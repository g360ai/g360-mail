<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>G360 CRM</title>
<link rel="icon" href="https://raw.githubusercontent.com/g360ai/g360-mail/main/Transparent%20-%20Kopya.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg-primary:#f8fafc;--bg-secondary:#ffffff;--bg-tertiary:#f1f5f9;--bg-hover:#e2e8f0;--border:#e2e8f0;--border-light:#cbd5e1;--text-primary:#1e293b;--text-secondary:#475569;--text-muted:#94a3b8;--accent-primary:#7c3aed;--accent-primary-light:#ede9fe;--accent-green:#10b981;--accent-green-light:#d1fae5;--accent-red:#ef4444;--accent-red-light:#fee2e2;--accent-yellow:#f59e0b;--accent-yellow-light:#fef3c7;--accent-blue:#3b82f6;--accent-blue-light:#dbeafe;--accent-purple:#8b5cf6;--accent-purple-light:#ede9fe;--accent-orange:#f97316;--accent-orange-light:#ffedd5;--accent-teal:#14b8a6;--accent-teal-light:#ccfbf1;--shadow-sm:0 1px 2px rgba(0,0,0,0.05);--shadow-md:0 4px 6px rgba(0,0,0,0.07);--shadow-lg:0 10px 15px rgba(0,0,0,0.1);--radius-sm:8px;--radius-md:12px;--radius-lg:16px}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.5}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 18px;border-radius:var(--radius-md);font-weight:600;font-size:14px;cursor:pointer;border:none;transition:all .2s;white-space:nowrap}
.btn-primary{background:var(--accent-primary);color:white}.btn-primary:hover{background:#6d28d9;transform:translateY(-1px)}
.btn-secondary{background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border)}.btn-secondary:hover{background:var(--bg-hover)}
.btn-danger{background:var(--accent-red-light);color:var(--accent-red)}.btn-ghost{background:transparent;color:var(--text-secondary);padding:8px 12px}.btn-ghost:hover{background:var(--bg-tertiary)}
.btn-sm{padding:8px 14px;font-size:13px}.btn-xs{padding:6px 10px;font-size:12px}.btn-block{width:100%}
.input{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:14px;background:var(--bg-secondary);color:var(--text-primary);transition:all .2s;font-family:inherit}
.input:focus{outline:none;border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-primary-light)}.input::placeholder{color:var(--text-muted)}
textarea.input{resize:vertical;min-height:80px}select.input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:40px}
.card{background:var(--bg-secondary);border-radius:var(--radius-lg);border:1px solid var(--border);box-shadow:var(--shadow-sm)}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
.app{display:flex;min-height:100vh}
.sidebar{width:280px;background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform .3s ease}
.sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sidebar-logo{display:flex;align-items:center;gap:10px;cursor:pointer}.sidebar-logo img{height:36px}
.sidebar-close{display:none;width:32px;height:32px;border:none;background:var(--bg-tertiary);border-radius:var(--radius-sm);cursor:pointer;color:var(--text-muted);font-size:18px;align-items:center;justify-content:center}
.sidebar-nav{flex:1;padding:16px 12px;overflow-y:auto}
.nav-section{margin-bottom:24px}.nav-title{font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;padding:0 12px;margin-bottom:8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:11px 12px;border-radius:var(--radius-md);color:var(--text-secondary);cursor:pointer;transition:all .2s;font-size:14px;font-weight:500;margin-bottom:2px}
.nav-item:hover{background:var(--bg-tertiary);color:var(--text-primary)}.nav-item.active{background:var(--accent-primary-light);color:var(--accent-primary)}.nav-item svg{width:20px;height:20px;flex-shrink:0}
.nav-link{display:flex;align-items:center;gap:8px;padding:10px 12px;color:var(--accent-primary);font-size:13px;font-weight:500;text-decoration:none;border-radius:var(--radius-sm);transition:all .2s}.nav-link:hover{background:var(--bg-tertiary)}
.sidebar-footer{padding:16px;border-top:1px solid var(--border)}
.user-card{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-tertiary);border-radius:var(--radius-md)}
.user-avatar{width:40px;height:40px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:15px}
.user-info{flex:1;min-width:0}.user-name{font-weight:600;font-size:14px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.user-role{font-size:12px;color:var(--text-muted)}
.logout-btn{padding:8px;background:transparent;border:none;cursor:pointer;color:var(--text-muted);border-radius:var(--radius-sm);transition:all .2s}.logout-btn:hover{background:var(--accent-red-light);color:var(--accent-red)}
.main{flex:1;margin-left:280px;min-height:100vh}.content{padding:24px;max-width:1200px;margin:0 auto}
.mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:60px;background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:0 16px;align-items:center;justify-content:space-between;z-index:99}
.menu-btn{padding:8px;border:none;background:transparent;cursor:pointer;color:var(--text-secondary);border-radius:var(--radius-sm)}
.notification-btn{padding:8px;border:none;background:transparent;cursor:pointer;color:var(--text-muted);border-radius:var(--radius-sm)}
.mobile-logo{cursor:pointer}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}.overlay.show{display:block}
@media(max-width:768px){.sidebar{transform:translateX(-100%);width:85%;max-width:320px}.sidebar.open{transform:translateX(0)}.sidebar-close{display:flex}.main{margin-left:0}.mobile-header{display:flex!important}.content{padding:16px;padding-top:76px}.stats-grid{grid-template-columns:1fr 1fr!important;gap:12px!important}.form-row,.form-row-3{grid-template-columns:1fr!important}.quick-actions{flex-direction:column}.dashboard-grid{grid-template-columns:1fr!important}.send-grid{grid-template-columns:1fr!important}.page-header{flex-direction:column;align-items:stretch;gap:12px}.page-header .btn{width:100%}.customer-filters{flex-direction:column}.customer-filters .input{max-width:100%!important}.customer-price-info{display:none!important}}
.page-header{margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
.page-title{font-size:24px;font-weight:800;color:var(--text-primary)}.page-subtitle{color:var(--text-muted);font-size:14px;margin-top:2px}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat-card{padding:20px;display:flex;align-items:center;gap:16px}
.stat-icon{width:48px;height:48px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.stat-content{flex:1}.stat-value{font-size:28px;font-weight:800;color:var(--text-primary);line-height:1}.stat-label{font-size:13px;color:var(--text-muted);margin-top:4px}.stat-change{font-size:12px;margin-top:6px;display:flex;align-items:center;gap:4px;color:var(--accent-green);font-weight:600}
.dashboard-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.quick-actions{display:flex;gap:12px;margin-bottom:24px}
.quick-action-btn{flex:1;padding:16px 20px;display:flex;align-items:center;gap:14px;background:var(--accent-primary);color:white;border:none;border-radius:var(--radius-lg);cursor:pointer;transition:all .2s}
.quick-action-btn:hover{background:#6d28d9;transform:translateY(-2px)}
.quick-action-btn.secondary{background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border)}.quick-action-btn.secondary:hover{background:var(--bg-tertiary);border-color:var(--accent-primary)}
.quick-action-icon{width:44px;height:44px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.2)}
.quick-action-btn.secondary .quick-action-icon{background:var(--accent-primary-light)}
.quick-action-text h4{font-size:15px;font-weight:700;text-align:left}.quick-action-text p{font-size:12px;opacity:0.8;margin-top:2px;text-align:left}
.customer-filters{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}.customer-filters .input{flex:1;min-width:150px;max-width:250px}
.customer-list{display:flex;flex-direction:column;gap:10px}

/* MÜŞTERİ KART TASARIMI - PC */
.customer-card{background:var(--bg-secondary);border-radius:var(--radius-md);border:1px solid var(--border);overflow:hidden;transition:all .2s;position:relative;cursor:pointer}
.customer-card:hover{box-shadow:var(--shadow-md);border-color:var(--accent-primary-light)}
.customer-card-header{display:flex;align-items:center;padding:16px}
.customer-status-bar{width:4px;height:100%;position:absolute;left:0;top:0;bottom:0}
.customer-info{flex:1;min-width:0;padding-left:12px}
.customer-name{font-weight:700;font-size:15px;color:var(--text-primary)}
.customer-meta{font-size:13px;color:var(--text-muted);margin-top:3px}
.customer-scenes{font-size:12px;color:var(--text-secondary);margin-top:2px;font-weight:500}
/* PC'de fiyat bilgisi */
.customer-price-info{display:flex;flex-direction:column;align-items:flex-end;margin-right:16px;min-width:120px}
.customer-price-main{font-size:16px;font-weight:700;color:var(--accent-primary)}
.customer-price-kdv{font-size:11px;color:var(--text-muted);margin-top:2px}
.customer-quick-actions{display:flex;gap:8px;align-items:center}
.quick-action-icon-btn{width:36px;height:36px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;border:none;background:var(--bg-tertiary);color:var(--text-secondary)}
.quick-action-icon-btn:hover{transform:scale(1.05)}
.quick-action-icon-btn.mail{background:var(--accent-blue-light);color:var(--accent-blue)}
.quick-action-icon-btn.edit{background:var(--accent-purple-light);color:var(--accent-purple)}

/* MODAL */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:flex-start;justify-content:center;z-index:200;padding:20px;overflow-y:auto;animation:fadeIn .2s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-content{background:var(--bg-secondary);border-radius:var(--radius-lg);width:100%;max-width:560px;margin:40px auto;box-shadow:var(--shadow-lg);animation:slideUp .3s}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-lg{max-width:640px}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg-secondary);z-index:10;border-radius:var(--radius-lg) var(--radius-lg) 0 0}
.modal-title{font-size:18px;font-weight:700}
.modal-close{width:36px;height:36px;border:none;background:var(--bg-tertiary);border-radius:var(--radius-sm);cursor:pointer;color:var(--text-muted);font-size:20px;display:flex;align-items:center;justify-content:center;transition:all .2s}.modal-close:hover{background:var(--bg-hover);color:var(--text-primary)}
.modal-body{padding:20px;max-height:calc(100vh - 200px);overflow-y:auto}
.modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end;flex-wrap:wrap;position:sticky;bottom:0;background:var(--bg-secondary);border-radius:0 0 var(--radius-lg) var(--radius-lg)}
@media(max-width:768px){
  .modal{padding:10px;align-items:flex-start}
  .modal-content{margin:10px auto;max-width:100%}
  .modal-body{max-height:calc(100vh - 180px);padding:16px}
  .modal-footer{flex-direction:column;padding:12px 16px}
  .modal-footer .btn{width:100%}
}
.form-group{margin-bottom:16px}.form-label{display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:6px}.form-hint{font-size:12px;color:var(--text-muted);margin-top:4px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.form-section{background:var(--bg-tertiary);padding:16px;border-radius:var(--radius-md);margin-bottom:16px}.form-section-title{font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;margin-bottom:12px}
.checkbox-wrapper{display:flex;align-items:center;gap:10px;cursor:pointer}.checkbox-wrapper input{width:18px;height:18px;accent-color:var(--accent-primary);cursor:pointer}.checkbox-label{font-size:14px;color:var(--text-primary)}
.kdv-calc{margin-top:12px;padding:12px;background:var(--bg-secondary);border-radius:var(--radius-sm);border:1px solid var(--border);display:none}
.kdv-row{display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:var(--text-muted)}.kdv-row.total{color:var(--accent-primary);font-weight:700;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
.places-wrapper{position:relative}
.places-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-md);margin-top:4px;max-height:200px;overflow-y:auto;z-index:50;display:none;box-shadow:var(--shadow-lg)}.places-dropdown.show{display:block}
.places-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s}.places-item:hover{background:var(--bg-tertiary)}.places-item:last-child{border-bottom:none}
.places-item-name{font-weight:500;color:var(--text-primary);font-size:14px}.places-item-address{font-size:12px;color:var(--text-muted);margin-top:2px}
.email-list{display:flex;flex-direction:column}
.email-item{display:flex;align-items:center;padding:16px;border-bottom:1px solid var(--border);cursor:pointer;gap:14px;transition:background .15s}.email-item:hover{background:var(--bg-tertiary)}
.email-avatar{width:42px;height:42px;background:var(--accent-primary-light);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent-primary);font-size:16px;flex-shrink:0}
.email-content{flex:1;min-width:0}.email-recipient{font-weight:600;font-size:14px;color:var(--text-primary)}.email-subject{font-size:13px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.email-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}.email-date{font-size:12px;color:var(--text-muted)}
.send-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.preview-box{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;min-height:200px}
.preview-subject{font-size:16px;font-weight:600;color:var(--text-primary);padding-bottom:12px;margin-bottom:12px;border-bottom:1px solid var(--border)}
.var-tag{background:var(--accent-yellow-light);color:var(--accent-yellow);padding:2px 8px;border-radius:4px;font-weight:600;font-size:12px}
.var-input{background:var(--accent-yellow-light);border:2px solid var(--accent-yellow);border-radius:var(--radius-sm);padding:10px 12px;font-weight:500;color:var(--text-primary);font-size:14px;width:100%;transition:all .2s}.var-input:focus{outline:none;box-shadow:0 0 0 3px rgba(245,158,11,0.2)}.var-input::placeholder{color:var(--accent-yellow);opacity:0.6}
.var-inputs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:12px}
.templates-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.editor-container{border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden}
.editor-toolbar{padding:8px 12px;background:var(--bg-tertiary);border-bottom:1px solid var(--border);display:flex;gap:6px}
.toolbar-btn{padding:6px 12px;border:1px solid var(--border);background:var(--bg-secondary);border-radius:var(--radius-sm);cursor:pointer;font-size:13px;color:var(--text-secondary);transition:all .15s}.toolbar-btn:hover{background:var(--bg-hover)}
.editor-area{min-height:120px;padding:16px;outline:none;font-size:14px;line-height:1.6;color:var(--text-primary);background:var(--bg-secondary)}.editor-area:empty:before{content:attr(data-placeholder);color:var(--text-muted)}
.table-container{overflow-x:auto}table{width:100%;border-collapse:collapse}
th{text-align:left;padding:12px 16px;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;border-bottom:1px solid var(--border);background:var(--bg-tertiary)}
td{padding:14px 16px;border-bottom:1px solid var(--border);font-size:14px;color:var(--text-secondary)}tr:hover td{background:var(--bg-tertiary)}
.toast{position:fixed;top:20px;right:20px;padding:14px 20px;border-radius:var(--radius-md);color:white;font-weight:600;z-index:300;animation:slideInRight .3s;font-size:14px;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px}@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.toast-success{background:var(--accent-green)}.toast-error{background:var(--accent-red)}.toast-info{background:var(--accent-blue)}
.empty-state{text-align:center;padding:48px 20px;color:var(--text-muted)}.empty-state h3{font-size:16px;font-weight:600;color:var(--text-secondary);margin-bottom:6px}
.loading{display:flex;align-items:center;justify-content:center;padding:40px}.spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent-primary);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
.section-card{padding:20px}.section-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.section-card-title{font-size:15px;font-weight:700;color:var(--text-primary)}
.status-breakdown-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}.status-breakdown-item:last-child{border-bottom:none}.status-breakdown-left{display:flex;align-items:center;gap:10px}.status-dot{width:10px;height:10px;border-radius:3px}.status-breakdown-count{font-weight:700;font-size:15px;color:var(--text-primary)}
.recent-customer-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all .15s}.recent-customer-item:hover{background:var(--bg-tertiary);margin:0 -16px;padding:10px 16px;border-radius:var(--radius-sm)}.recent-customer-item:last-child{border-bottom:none}
.recent-customer-bar{width:4px;height:32px;border-radius:2px}.recent-customer-info{flex:1}.recent-customer-name{font-weight:600;font-size:14px;color:var(--text-primary)}.recent-customer-city{font-size:12px;color:var(--text-muted)}.recent-customer-price{font-weight:700;font-size:14px;color:var(--accent-primary)}
.settings-section{max-width:560px}.settings-card{padding:24px;margin-bottom:16px}.settings-card-title{font-size:15px;font-weight:700;color:var(--text-primary);margin-bottom:16px;display:flex;align-items:center;gap:10px}
.deleted-card{opacity:0.6;background:var(--accent-red-light)}
.deleted-badge{background:var(--accent-red);color:white;font-size:10px;padding:2px 6px;border-radius:4px}
.tab-buttons{display:flex;gap:8px;margin-bottom:16px}
.tab-btn{padding:8px 16px;border:1px solid var(--border);background:var(--bg-secondary);border-radius:var(--radius-sm);cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
.tab-btn.active{background:var(--accent-primary);color:white;border-color:var(--accent-primary)}
/* Status picker */
.status-picker{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.status-btn{padding:10px 14px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;border:2px solid var(--border);background:var(--bg-secondary);color:var(--text-secondary);transition:all .2s}.status-btn:hover{border-color:var(--border-light)}.status-btn.active{color:white;border-color:transparent}
.customer-details-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;background:var(--bg-tertiary);padding:12px;border-radius:var(--radius-sm)}
@media(max-width:500px){.customer-details-grid{grid-template-columns:1fr}}
.detail-item{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)}.detail-item:last-child{border-bottom:none}
.detail-label{font-size:13px;color:var(--text-muted)}.detail-value{font-size:13px;color:var(--text-primary);font-weight:500}.detail-value a{color:var(--accent-primary);text-decoration:none}
</style>
</head>
<body>
<div id="app"></div>
<script>
const LOGO_URL='https://raw.githubusercontent.com/g360ai/g360-mail/main/Transparent%20-%20Kopya.png';
const UPTIME_URL='https://stats.uptimerobot.com/hJxMDJRwGE';
let user=null,page='login',sidebarOpen=false,customers=[],deletedCustomers=[],templates=[],teams=[],emails=[],users=[],categories=[],statuses=[],stats={},showDeleted=false;
const API='';
function token(){return localStorage.getItem('g360_token')}
async function api(url,opts={}){opts.headers={'Content-Type':'application/json'};if(token())opts.headers.Authorization='Bearer '+token();try{const res=await fetch(API+url,opts);const data=await res.json();if(res.status===401){localStorage.removeItem('g360_token');localStorage.removeItem('g360_user');page='login';user=null;render();throw new Error('Oturum sona erdi')}if(!res.ok)throw new Error(data.error||'Hata');return data}catch(err){if(err.message==='Failed to fetch')throw new Error('Sunucuya bağlanılamadı');throw err}}
function toast(msg,type='success'){const t=document.createElement('div');t.className='toast toast-'+type;t.innerHTML=(type==='success'?'✓':type==='error'?'✕':'ℹ')+' '+msg;document.body.appendChild(t);setTimeout(function(){t.remove()},3000)}
function nav(p){page=p;showDeleted=false;render()}
function goHome(){nav('dashboard');closeSidebar()}
function toggleSidebar(){sidebarOpen=!sidebarOpen;render()}
function closeSidebar(){sidebarOpen=false;render()}
function isAdmin(){return user?.role==='admin'}
function getRoleName(r){return{admin:'Admin',manager:'Yönetici',sales:'Satış'}[r]||r}
function getRoleColor(r){return{admin:'background:#f97316',manager:'background:#8b5cf6',sales:'background:#14b8a6'}[r]}
function formatDate(d){return new Date(d).toLocaleString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}
function formatShortDate(d){const date=new Date(d);const today=new Date();if(date.toDateString()===today.toDateString())return date.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});return date.toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit'})}
function formatMoney(n){return new Intl.NumberFormat('tr-TR').format(n||0)+'₺'}
function logout(){localStorage.removeItem('g360_token');localStorage.removeItem('g360_user');user=null;page='login';render();toast('Çıkış yapıldı','info')}
function escapeHtml(t){if(!t)return '';const d=document.createElement('div');d.textContent=t;return d.innerHTML}

// Modal dışına tıklayınca kapat
function setupModalClose(modalEl){if(!modalEl)return;modalEl.addEventListener('click',function(e){if(e.target===modalEl)modalEl.remove()})}
function closeModal(){var m=document.querySelector('.modal');if(m)m.remove()}

function render(){const app=document.getElementById('app');if(!app)return;if(page==='login'){app.innerHTML=loginPage();setupLogin()}else{app.innerHTML='<div class="app"><div class="overlay '+(sidebarOpen?'show':'')+'" onclick="closeSidebar()"></div>'+sidebar()+'<div class="main">'+mobileHeader()+'<div class="content">'+(page==='dashboard'?dashboardPage():'')+(page==='customers'?customersPage():'')+(page==='send'?sendPage():'')+(page==='emails'?emailsPage():'')+(page==='templates'?templatesPage():'')+(page==='teams'?teamsPage():'')+(page==='users'?usersPage():'')+(page==='settings'?settingsPage():'')+'</div></div></div>';loadPageData()}}
function loginPage(){return '<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%)"><div class="card" style="width:100%;max-width:380px;padding:36px"><div style="text-align:center;margin-bottom:28px"><img src="'+LOGO_URL+'" alt="G360" style="height:48px;margin-bottom:12px"><p style="color:var(--text-muted);font-size:14px">CRM & Mail Sistemi</p></div><form id="loginForm"><div class="form-group"><label class="form-label">Kullanıcı Adı</label><input type="text" id="username" class="input" placeholder="Kullanıcı adınız" required autofocus></div><div class="form-group"><label class="form-label">Şifre</label><input type="password" id="password" class="input" placeholder="••••••••" required></div><button type="submit" class="btn btn-primary btn-block" style="padding:14px;margin-top:8px">Giriş Yap</button></form><p style="text-align:center;margin-top:20px;font-size:11px;color:var(--text-muted)">c.g360.ai</p></div></div>'}
function setupLogin(){const form=document.getElementById('loginForm');if(!form)return;form.onsubmit=async function(e){e.preventDefault();const btn=e.target.querySelector('button');btn.disabled=true;btn.innerHTML='<span class="spinner" style="width:18px;height:18px;border-width:2px"></span>';try{const res=await api('/api/auth/login',{method:'POST',body:JSON.stringify({username:document.getElementById('username').value,password:document.getElementById('password').value})});localStorage.setItem('g360_token',res.token);localStorage.setItem('g360_user',JSON.stringify(res.user));user=res.user;page='dashboard';render();toast('Hoş geldiniz!')}catch(err){toast(err.message,'error');btn.disabled=false;btn.textContent='Giriş Yap'}}}
function sidebar(){return '<aside class="sidebar '+(sidebarOpen?'open':'')+'"><div class="sidebar-header"><div class="sidebar-logo" onclick="goHome()"><img src="'+LOGO_URL+'" alt="G360"></div><button class="sidebar-close" onclick="closeSidebar()">✕</button></div><nav class="sidebar-nav"><div class="nav-section"><div class="nav-item '+(page==='dashboard'?'active':'')+'" onclick="nav(\'dashboard\');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span>Ana Sayfa</span></div></div><div class="nav-section"><div class="nav-title">Müşteriler</div><div class="nav-item '+(page==='customers'?'active':'')+'" onclick="nav(\'customers\');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg><span>Müşteriler</span></div></div><div class="nav-section"><div class="nav-title">E-Posta</div><div class="nav-item '+(page==='send'?'active':'')+'" onclick="nav(\'send\');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg><span>Mail Gönder</span></div><div class="nav-item '+(page==='emails'?'active':'')+'" onclick="nav(\'emails\');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg><span>Gönderilen</span></div></div>'+(isAdmin()?'<div class="nav-section"><div class="nav-title">Yönetim</div><div class="nav-item '+(page==='templates'?'active':'')+'" onclick="nav(\'templates\');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><span>Taslaklar</span></div><div class="nav-item '+(page==='teams'?'active':'')+'" onclick="nav(\'teams\');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>Ekipler</span></div><div class="nav-item '+(page==='users'?'active':'')+'" onclick="nav(\'users\');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span>Kullanıcılar</span></div><div class="nav-item '+(page==='settings'?'active':'')+'" onclick="nav(\'settings\');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>Ayarlar</span></div></div>':'<div class="nav-section"><div class="nav-title">Hesap</div><div class="nav-item '+(page==='settings'?'active':'')+'" onclick="nav(\'settings\');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><span>Profilim</span></div></div>')+'<div class="nav-section" style="margin-top:auto;padding-top:12px;border-top:1px solid var(--border)"><a href="'+UPTIME_URL+'" target="_blank" class="nav-link"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>Uptime</a></div></nav><div class="sidebar-footer"><div class="user-card"><div class="user-avatar" style="'+getRoleColor(user?.role)+'">'+(user?.full_name?.[0]||'?')+'</div><div class="user-info"><div class="user-name">'+(user?.full_name||'')+'</div><div class="user-role">'+getRoleName(user?.role)+'</div></div><button class="logout-btn" onclick="logout()" title="Çıkış"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></button></div></div></aside>'}
function mobileHeader(){return '<div class="mobile-header"><button class="menu-btn" onclick="toggleSidebar()"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg></button><img src="'+LOGO_URL+'" alt="G360" style="height:28px;cursor:pointer" class="mobile-logo" onclick="goHome()"><button class="notification-btn"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg></button></div>'}
function dashboardPage(){return '<div class="page-header"><div><p style="color:var(--text-muted);font-size:13px">Hoş geldin,</p><h1 class="page-title">'+(user?.full_name||'')+'</h1></div></div><div class="quick-actions"><button class="quick-action-btn" onclick="showCustomerModal()"><div class="quick-action-icon"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg></div><div class="quick-action-text"><h4>Yeni Müşteri</h4><p>Müşteri kaydı oluştur</p></div></button><button class="quick-action-btn secondary" onclick="nav(\'send\')"><div class="quick-action-icon"><svg width="22" height="22" fill="none" stroke="var(--accent-primary)" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></div><div class="quick-action-text"><h4>Mail Gönder</h4><p>Teklif maili gönder</p></div></button></div><div id="statsGrid" class="stats-grid"><div class="card stat-card"><div class="loading"><div class="spinner"></div></div></div><div class="card stat-card"><div class="loading"><div class="spinner"></div></div></div><div class="card stat-card"><div class="loading"><div class="spinner"></div></div></div><div class="card stat-card"><div class="loading"><div class="spinner"></div></div></div></div><div class="dashboard-grid"><div class="card section-card"><div class="section-card-header"><h3 class="section-card-title">Durum Dağılımı</h3></div><div id="statusBreakdown"><div class="loading"><div class="spinner"></div></div></div></div><div class="card section-card"><div class="section-card-header"><h3 class="section-card-title">Son Müşteriler</h3><button class="btn btn-ghost btn-sm" onclick="nav(\'customers\')">Tümü →</button></div><div id="recentCustomers"><div class="loading"><div class="spinner"></div></div></div></div></div>'}
function customersPage(){return '<div class="page-header"><div><h1 class="page-title">Müşteriler</h1><p class="page-subtitle" id="customerCount">Yükleniyor...</p></div><button class="btn btn-primary" onclick="showCustomerModal()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Yeni Müşteri</button></div>'+(isAdmin()?'<div class="tab-buttons"><button class="tab-btn '+(showDeleted?'':'active')+'" onclick="showDeleted=false;filterCustomers()">Aktif Müşteriler</button><button class="tab-btn '+(showDeleted?'active':'')+'" onclick="showDeleted=true;loadDeletedCustomers()">Silinen ('+(deletedCustomers.length||0)+')</button></div>':'')+'<div class="customer-filters"><input type="text" class="input" placeholder="Ara..." id="searchInput" oninput="filterCustomers()"><select class="input" id="statusFilter" onchange="filterCustomers()"><option value="">Durum</option></select><select class="input" id="categoryFilter" onchange="filterCustomers()"><option value="">Kategori</option></select></div><div id="customerList" class="customer-list"><div class="loading"><div class="spinner"></div></div></div>'}
function sendPage(){return '<div class="page-header"><div><h1 class="page-title">Mail Gönder</h1></div></div><div class="send-grid"><div class="card" style="padding:20px"><form id="sendForm"><div class="form-group"><label class="form-label">Mail Taslağı *</label><select id="templateSelect" class="input" required><option value="">Taslak seçin...</option></select></div><div class="form-row"><div class="form-group"><label class="form-label">Alıcı E-posta *</label><input type="email" id="toEmail" class="input" placeholder="ornek@firma.com" required></div><div class="form-group"><label class="form-label">Alıcı Adı</label><input type="text" id="toName" class="input" placeholder="Ad Soyad"></div></div><div id="variableInputs"></div><button type="submit" class="btn btn-primary btn-block" style="padding:14px;margin-top:8px"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>Mail Gönder</button></form></div><div class="card" style="padding:20px"><h3 style="font-size:13px;font-weight:600;margin-bottom:12px;color:var(--text-muted)">Önizleme</h3><div id="sendPreview" class="preview-box"><p style="color:var(--text-muted);text-align:center;padding:32px 0">Taslak seçin...</p></div></div></div>'}
function emailsPage(){return '<div class="page-header"><div><h1 class="page-title">Gönderilen Mailler</h1><p class="page-subtitle" id="emailCount">Yükleniyor...</p></div></div><div class="card" style="padding:0;overflow:hidden"><div id="emailList" class="email-list"><div class="loading"><div class="spinner"></div></div></div></div>'}
function templatesPage(){return '<div class="page-header"><div><h1 class="page-title">Mail Taslakları</h1></div><button class="btn btn-primary" onclick="showTemplateModal()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Yeni Taslak</button></div><div id="templatesList" class="templates-grid"><div class="loading"><div class="spinner"></div></div></div>'}
function teamsPage(){return '<div class="page-header"><div><h1 class="page-title">Ekipler</h1></div><button class="btn btn-primary" onclick="showTeamModal()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Yeni Ekip</button></div><div id="teamsList" class="templates-grid"><div class="loading"><div class="spinner"></div></div></div>'}
function usersPage(){return '<div class="page-header"><div><h1 class="page-title">Kullanıcılar</h1></div><button class="btn btn-primary" onclick="showUserModal()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Yeni Kullanıcı</button></div><div class="card"><div id="usersTable" class="table-container"><div class="loading"><div class="spinner"></div></div></div></div>'}
function settingsPage(){return '<div class="page-header"><div><h1 class="page-title">'+(isAdmin()?'Ayarlar':'Profilim')+'</h1></div></div><div class="settings-section"><div class="card settings-card"><h3 class="settings-card-title">Şifre Değiştir</h3><form id="passwordForm"><div class="form-group"><label class="form-label">Mevcut Şifre</label><input type="password" id="currentPassword" class="input" required></div><div class="form-row"><div class="form-group"><label class="form-label">Yeni Şifre</label><input type="password" id="newPassword" class="input" required minlength="6"></div><div class="form-group"><label class="form-label">Yeni Şifre (Tekrar)</label><input type="password" id="confirmPassword" class="input" required></div></div><button type="submit" class="btn btn-primary">Şifreyi Güncelle</button></form></div>'+(isAdmin()?'<div class="card settings-card"><h3 class="settings-card-title">Mail İmzası</h3><div class="editor-container"><div class="editor-toolbar"><button type="button" class="toolbar-btn" onclick="document.execCommand(\'bold\')"><strong>B</strong></button><button type="button" class="toolbar-btn" onclick="document.execCommand(\'italic\')"><em>I</em></button></div><div id="signatureArea" class="editor-area" contenteditable="true" data-placeholder="Mail imzanızı yazın..."></div></div><button class="btn btn-primary" style="margin-top:12px" onclick="saveSignature()">İmzayı Kaydet</button></div>':'')+'</div>'}

async function loadPageData(){try{if(categories.length===0)categories=await api('/api/categories');if(statuses.length===0)statuses=await api('/api/statuses');templates=await api('/api/templates');if(page==='dashboard'){stats=await api('/api/stats');customers=await api('/api/customers');renderDashboard()}if(page==='customers'){customers=await api('/api/customers');if(isAdmin()){try{deletedCustomers=await api('/api/customers/deleted')}catch(e){deletedCustomers=[]}}renderCustomers()}if(page==='send')setupSendPage();if(page==='emails'){emails=await api('/api/emails');renderEmails()}if(page==='templates')renderTemplates();if(page==='teams'){teams=await api('/api/teams');renderTeams()}if(page==='users'){teams=await api('/api/teams');users=await api('/api/users');renderUsers()}if(page==='settings')setupSettingsPage()}catch(err){console.error(err);toast(err.message,'error')}}

async function loadDeletedCustomers(){try{deletedCustomers=await api('/api/customers/deleted');filterCustomers()}catch(err){toast(err.message,'error')}}

function renderDashboard(){const statsEl=document.getElementById('statsGrid');if(!statsEl)return;statsEl.innerHTML='<div class="card stat-card"><div class="stat-icon" style="background:var(--accent-green-light)"><svg width="22" height="22" fill="none" stroke="var(--accent-green)" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div class="stat-content"><div class="stat-value">'+formatMoney(stats.monthRevenue)+'</div><div class="stat-label">Aylık Kazanç</div></div></div><div class="card stat-card"><div class="stat-icon" style="background:var(--accent-blue-light)"><svg width="22" height="22" fill="none" stroke="var(--accent-blue)" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg></div><div class="stat-content"><div class="stat-value">'+stats.totalCustomers+'</div><div class="stat-label">Toplam Müşteri</div>'+(stats.newToday>0?'<div class="stat-change">+'+stats.newToday+' bugün</div>':'')+'</div></div><div class="card stat-card"><div class="stat-icon" style="background:var(--accent-teal-light)"><svg width="22" height="22" fill="none" stroke="var(--accent-teal)" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg></div><div class="stat-content"><div class="stat-value">'+stats.completedCount+'</div><div class="stat-label">Tamamlanan</div></div></div><div class="card stat-card"><div class="stat-icon" style="background:var(--accent-purple-light)"><svg width="22" height="22" fill="none" stroke="var(--accent-purple)" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></div><div class="stat-content"><div class="stat-value">'+(stats.sentEmails||stats.totalEmails)+'</div><div class="stat-label">Gönderilen Mail</div></div></div>';
var statusHtml='';if(stats.byStatus)stats.byStatus.forEach(function(s){statusHtml+='<div class="status-breakdown-item"><div class="status-breakdown-left"><div class="status-dot" style="background:'+s.color+'"></div><span style="font-size:13px;color:var(--text-secondary)">'+s.name+'</span></div><span class="status-breakdown-count">'+s.count+'</span></div>'});
var sbEl=document.getElementById('statusBreakdown');if(sbEl)sbEl.innerHTML=statusHtml||'<p class="empty-state">Henüz veri yok</p>';
var recentHtml='';var recentList=stats.recentCustomers||customers.slice(0,5);recentList.forEach(function(c){var statusInfo=c.status_info||statuses.find(function(s){return s.id===c.status});recentHtml+='<div class="recent-customer-item" onclick="showCustomerDetail(\''+c.id+'\')"><div class="recent-customer-bar" style="background:'+(statusInfo?.color||'var(--border)')+'"></div><div class="recent-customer-info"><div class="recent-customer-name">'+escapeHtml(c.business_name)+'</div><div class="recent-customer-city">'+(c.city||'Belirtilmemiş')+'</div></div><div class="recent-customer-price">'+formatMoney(c.price)+'</div></div>'});
var rcEl=document.getElementById('recentCustomers');if(rcEl)rcEl.innerHTML=recentHtml||'<p class="empty-state">Henüz müşteri yok</p>'}

function renderCustomers(){var statusEl=document.getElementById('statusFilter');if(statusEl)statusEl.innerHTML='<option value="">Durum</option>'+statuses.map(function(s){return '<option value="'+s.id+'">'+s.name+'</option>'}).join('');var catEl=document.getElementById('categoryFilter');if(catEl)catEl.innerHTML='<option value="">Kategori</option>'+categories.map(function(c){return '<option value="'+c.id+'">'+c.id+' | '+c.name+'</option>'}).join('');filterCustomers()}

function filterCustomers(){var search=(document.getElementById('searchInput')?.value||'').toLowerCase();var status=document.getElementById('statusFilter')?.value||'';var category=document.getElementById('categoryFilter')?.value||'';var list=showDeleted?deletedCustomers:customers;var filtered=list.filter(function(c){var matchSearch=!search||c.business_name?.toLowerCase().includes(search)||c.contact_name?.toLowerCase().includes(search)||c.city?.toLowerCase().includes(search);var matchStatus=!status||c.status===parseInt(status);var matchCategory=!category||c.category_id===parseInt(category);return matchSearch&&matchStatus&&matchCategory});
var countEl=document.getElementById('customerCount');if(countEl)countEl.textContent=filtered.length+(showDeleted?' silinen':'')+' müşteri';
var listEl=document.getElementById('customerList');if(!listEl)return;
if(filtered.length===0){listEl.innerHTML='<div class="empty-state"><h3>'+(showDeleted?'Silinen müşteri yok':'Müşteri bulunamadı')+'</h3></div>';return}
var html='';filtered.forEach(function(c){var statusInfo=c.status_info||statuses.find(function(s){return s.id===c.status});var isDeleted=showDeleted||c.is_deleted;
// Fiyat bilgisi
var priceHtml='<div class="customer-price-info"><div class="customer-price-main">'+formatMoney(c.price)+'</div>';
if(c.is_invoiced&&c.price>0){priceHtml+='<div class="customer-price-kdv">KDV Dahil: '+formatMoney(c.price)+'</div>'}
priceHtml+='</div>';
html+='<div class="customer-card '+(isDeleted?'deleted-card':'')+'" onclick="showCustomerDetail(\''+c.id+'\')"><div class="customer-status-bar" style="background:'+(statusInfo?.color||'var(--border)')+'"></div><div class="customer-card-header"><div class="customer-info"><div class="customer-name">'+escapeHtml(c.business_name)+(isDeleted?'<span class="deleted-badge" style="margin-left:8px">Silindi</span>':'')+'</div><div class="customer-meta">'+(c.city||'')+(c.district?' '+c.district:'')+'</div><div class="customer-scenes">'+(c.scene_count||1)+' Sahne</div></div>'+priceHtml+'<div class="customer-quick-actions">'+(isDeleted?'<button class="quick-action-icon-btn" style="background:var(--accent-green-light);color:var(--accent-green)" onclick="event.stopPropagation();restoreCustomer(\''+c.id+'\')" title="Geri Al"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg></button>':'<button class="quick-action-icon-btn mail" onclick="event.stopPropagation();sendMailToCustomer(\''+c.id+'\')" title="Mail Gönder"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></button><button class="quick-action-icon-btn edit" onclick="event.stopPropagation();editCustomer(\''+c.id+'\')" title="Düzenle"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>')+'</div></div></div>'});
listEl.innerHTML=html}

async function softDeleteCustomer(id){if(!confirm('Bu müşteriyi silmek istediğinize emin misiniz?\n\n30 gün içinde geri alabilirsiniz.'))return;try{await api('/api/customers/'+id+'/soft-delete',{method:'PATCH'});toast('Müşteri silindi (30 gün içinde geri alınabilir)');customers=await api('/api/customers');deletedCustomers=await api('/api/customers/deleted');closeModal();filterCustomers()}catch(err){toast(err.message,'error')}}

async function restoreCustomer(id){try{await api('/api/customers/'+id+'/restore',{method:'PATCH'});toast('Müşteri geri alındı');customers=await api('/api/customers');deletedCustomers=await api('/api/customers/deleted');filterCustomers()}catch(err){toast(err.message,'error')}}

function renderEmails(){var countEl=document.getElementById('emailCount');if(countEl)countEl.textContent=emails.length+' mail';var listEl=document.getElementById('emailList');if(!listEl)return;if(emails.length===0){listEl.innerHTML='<div class="empty-state"><h3>Henüz mail gönderilmemiş</h3></div>';return}var html='';emails.forEach(function(e){var initial=(e.recipient_name||e.recipient_email||'?')[0].toUpperCase();html+='<div class="email-item" onclick="viewEmail(\''+e.id+'\')"><div class="email-avatar">'+initial+'</div><div class="email-content"><div class="email-recipient">'+escapeHtml(e.recipient_name||e.recipient_email)+'</div><div class="email-subject">'+escapeHtml(e.subject)+'</div></div><div class="email-meta"><span class="badge" style="background:'+(e.status==='sent'?'var(--accent-green-light)':'var(--accent-red-light)')+';color:'+(e.status==='sent'?'var(--accent-green)':'var(--accent-red)')+'">'+(e.status==='sent'?'Gönderildi':'Hata')+'</span><span class="email-date">'+formatShortDate(e.sent_at)+'</span></div></div>'});listEl.innerHTML=html}

function renderTemplates(){var listEl=document.getElementById('templatesList');if(!listEl)return;if(templates.length===0){listEl.innerHTML='<div class="empty-state" style="grid-column:1/-1"><h3>Taslak bulunamadı</h3></div>';return}var html='';templates.forEach(function(t){html+='<div class="card" style="padding:16px"><h3 style="font-weight:700;font-size:15px;margin-bottom:6px">'+escapeHtml(t.name)+'</h3><p style="font-size:12px;color:var(--text-muted);margin-bottom:10px">'+escapeHtml(t.subject)+'</p><div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">'+(t.variables||[]).map(function(v){return '<span class="var-tag">{{'+v+'}}</span>'}).join('')+'</div><div style="display:flex;gap:6px"><button class="btn btn-secondary btn-sm" onclick="editTemplate(\''+t.id+'\')">Düzenle</button><button class="btn btn-danger btn-sm" onclick="deleteTemplate(\''+t.id+'\')">Sil</button></div></div>'});listEl.innerHTML=html}

function renderTeams(){var listEl=document.getElementById('teamsList');if(!listEl)return;if(teams.length===0){listEl.innerHTML='<div class="empty-state" style="grid-column:1/-1"><h3>Ekip bulunamadı</h3></div>';return}var html='';teams.forEach(function(t){html+='<div class="card" style="padding:16px"><div style="display:flex;align-items:center;gap:12px"><div style="width:40px;height:40px;background:var(--accent-purple);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">'+t.name[0]+'</div><div style="flex:1"><h3 style="font-weight:700;font-size:15px">'+escapeHtml(t.name)+'</h3></div><button class="btn btn-danger btn-sm" onclick="deleteTeam(\''+t.id+'\')">Sil</button></div></div>'});listEl.innerHTML=html}

function renderUsers(){var tableEl=document.getElementById('usersTable');if(!tableEl)return;if(users.length===0){tableEl.innerHTML='<div class="empty-state"><h3>Kullanıcı bulunamadı</h3></div>';return}var html='<table><thead><tr><th>Kullanıcı</th><th>Ekip</th><th>Rol</th><th style="text-align:right">İşlemler</th></tr></thead><tbody>';users.forEach(function(u){html+='<tr><td><div style="display:flex;align-items:center;gap:10px"><div class="user-avatar" style="'+getRoleColor(u.role)+';width:32px;height:32px;font-size:13px">'+u.full_name[0]+'</div><div><div style="font-weight:600">'+escapeHtml(u.full_name)+'</div><div style="font-size:11px;color:var(--text-muted)">@'+escapeHtml(u.username)+'</div></div></div></td><td><span class="badge" style="background:var(--accent-blue-light);color:var(--accent-blue)">'+(u.team_name||'-')+'</span></td><td><span class="badge" style="background:'+(u.role==='admin'?'var(--accent-orange-light)':u.role==='manager'?'var(--accent-purple-light)':'var(--accent-teal-light)')+';color:'+(u.role==='admin'?'var(--accent-orange)':u.role==='manager'?'var(--accent-purple)':'var(--accent-teal)')+'">'+getRoleName(u.role)+'</span></td><td style="text-align:right">'+(u.role!=='admin'||users.filter(function(x){return x.role==='admin'}).length>1?'<button class="btn btn-secondary btn-xs" onclick="editUser(\''+u.id+'\')">Düzenle</button> <button class="btn btn-danger btn-xs" onclick="deleteUser(\''+u.id+'\')">Sil</button>':'')+'</td></tr>'});html+='</tbody></table>';tableEl.innerHTML=html}

async function setupSettingsPage(){var form=document.getElementById('passwordForm');if(form)form.onsubmit=async function(e){e.preventDefault();var newPass=document.getElementById('newPassword').value;var confirmPass=document.getElementById('confirmPassword').value;if(newPass!==confirmPass){toast('Şifreler eşleşmiyor','error');return}try{await api('/api/auth/password',{method:'PUT',body:JSON.stringify({current_password:document.getElementById('currentPassword').value,new_password:newPass})});toast('Şifre güncellendi');e.target.reset()}catch(err){toast(err.message,'error')}};if(isAdmin()){try{var settings=await api('/api/settings');var sigEl=document.getElementById('signatureArea');if(sigEl)sigEl.innerHTML=settings.signature||''}catch(err){console.error(err)}}}

async function saveSignature(){try{var sigEl=document.getElementById('signatureArea');if(!sigEl)return;await api('/api/settings',{method:'POST',body:JSON.stringify({signature:sigEl.innerHTML})});toast('İmza kaydedildi')}catch(err){toast(err.message,'error')}}

// YENİ MÜŞTERİ MODAL - Görseldeki sıralama ile
function showCustomerModal(edit){var m=document.createElement('div');m.className='modal';m.id='customerModal';var categoryOpts=categories.map(function(c){return '<option value="'+c.id+'" '+(edit?.category_id===c.id?'selected':'')+'>'+c.id+' | '+c.name+'</option>'}).join('');
// Status picker for edit
var statusPickerHtml='';
if(edit){statusPickerHtml='<div class="form-group"><label class="form-label">Durum</label><div class="status-picker" id="statusPicker">'+statuses.map(function(s){return '<button type="button" class="status-btn '+(edit.status===s.id?'active':'')+'" data-status="'+s.id+'" style="'+(edit.status===s.id?'background:'+s.color+';border-color:'+s.color:'')+'">'+s.name+'</button>'}).join('')+'</div></div>'}
m.innerHTML='<div class="modal-content modal-lg"><div class="modal-header"><h3 class="modal-title">'+(edit?'Müşteri Düzenle':'Yeni Müşteri')+'</h3><button class="modal-close" onclick="closeModal()">✕</button></div><div class="modal-body">'+statusPickerHtml+'<div class="form-section"><div class="form-section-title">İşletme Bilgileri</div><div class="form-group"><label class="form-label">Kategori *</label><select id="custCategory" class="input" required><option value="">Kategori seçin</option>'+categoryOpts+'</select></div><div class="form-group"><div class="places-wrapper"><input type="text" id="custBusinessName" class="input" placeholder="İşletme adını yazın..." value="'+(edit?.business_name||'')+'" required autocomplete="off"><div id="placesDropdown" class="places-dropdown"></div></div></div><div class="form-group"><label class="form-label">Lokasyon</label><input type="text" id="custAddress" class="input" placeholder="Adres" value="'+(edit?.address||'')+'" readonly style="background:var(--bg-tertiary)"><input type="hidden" id="custPlaceId" value="'+(edit?.place_id||'')+'"><input type="hidden" id="custCity" value="'+(edit?.city||'')+'"><input type="hidden" id="custDistrict" value="'+(edit?.district||'')+'"></div></div><div class="form-section"><div class="form-section-title">Yetkili Personel</div><div class="form-group"><input type="text" id="custContact" class="input" placeholder="Ad Soyad" value="'+(edit?.contact_name||'')+'"></div><div class="form-group"><label class="form-label">Telefon</label><input type="text" id="custPhone" class="input" placeholder="+90 (5XX) XXX-XX-XX" value="'+(edit?.phone||'')+'"></div><div class="form-group"><label class="form-label">E-Posta</label><input type="email" id="custEmail" class="input" placeholder="ornek@firma.com" value="'+(edit?.email||'')+'"></div><div class="form-group"><label class="form-label">İşletme İsmi</label><input type="text" id="custBusinessNameAlt" class="input" placeholder="Manuel giriş (opsiyonel)" value="'+(edit?.business_name||'')+'"></div><div class="form-group"><label class="form-label">Vergi Numarası</label><input type="text" id="custTaxNumber" class="input" placeholder="Vergi numarası" value="'+(edit?.tax_number||'')+'"></div></div><div class="form-section"><div class="form-section-title">Teklif</div><div class="form-row"><div class="form-group"><label class="checkbox-wrapper" style="margin-bottom:8px"><input type="checkbox" id="custInvoiced" '+(edit?.is_invoiced?'checked':'')+' onchange="calcKdv()"><span class="checkbox-label">KDV Dahil</span></label><label class="form-label">Verilen Teklif (₺)</label><input type="number" id="custPrice" class="input" placeholder="0" value="'+(edit?.price||'')+'" step="0.01" oninput="calcKdv()"></div><div class="form-group"><label class="form-label">Sahne Sayısı</label><input type="number" id="custSceneCount" class="input" placeholder="1" value="'+(edit?.scene_count||1)+'" min="1"></div></div><div id="kdvCalc" class="kdv-calc"><div class="kdv-row"><span>KDV\'siz:</span><span id="kdvWithout">0₺</span></div><div class="kdv-row"><span>KDV:</span><span id="kdvAmount">0₺</span></div><div class="kdv-row total"><span>Toplam:</span><span id="kdvTotal">0₺</span></div></div></div><div class="form-group"><label class="form-label">Notlar</label><textarea id="custNotes" class="input" rows="3" placeholder="İşletme yada teklif ile ilgili notlarınızı buraya yazabilirsiniz.">'+(edit?.notes||'')+'</textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">İptal</button><button class="btn btn-primary" onclick="saveCustomer(\''+(edit?.id||'')+'\')">'+(edit?'Güncelle':'Kaydet')+'</button></div></div>';
document.body.appendChild(m);
setupModalClose(m);
// Status button click handlers
if(edit){var picker=document.getElementById('statusPicker');if(picker){picker.querySelectorAll('.status-btn').forEach(function(btn){btn.onclick=function(){picker.querySelectorAll('.status-btn').forEach(function(b){b.classList.remove('active');b.style.background='';b.style.borderColor=''});btn.classList.add('active');var status=statuses.find(function(s){return s.id===parseInt(btn.dataset.status)});if(status){btn.style.background=status.color;btn.style.borderColor=status.color}}})}}
setupPlacesAutocomplete();calcKdv()}

function calcKdv(){var priceEl=document.getElementById('custPrice');var invoicedEl=document.getElementById('custInvoiced');var calcEl=document.getElementById('kdvCalc');if(!priceEl||!invoicedEl||!calcEl)return;var price=parseFloat(priceEl.value)||0;var invoiced=invoicedEl.checked;if(invoiced&&price>0){calcEl.style.display='block';var without=price/1.20;var vat=price-without;var wEl=document.getElementById('kdvWithout');var aEl=document.getElementById('kdvAmount');var tEl=document.getElementById('kdvTotal');if(wEl)wEl.textContent=formatMoney(without);if(aEl)aEl.textContent=formatMoney(vat);if(tEl)tEl.textContent=formatMoney(price)}else{calcEl.style.display='none'}}

var placesTimeout=null;
function setupPlacesAutocomplete(){var input=document.getElementById('custBusinessName');var dropdown=document.getElementById('placesDropdown');if(!input||!dropdown)return;input.oninput=function(){clearTimeout(placesTimeout);var q=input.value.trim();if(q.length<2){dropdown.classList.remove('show');return}placesTimeout=setTimeout(async function(){try{var res=await api('/api/places/autocomplete?input='+encodeURIComponent(q));if(res.predictions?.length>0){dropdown.innerHTML=res.predictions.map(function(p){return '<div class="places-item" data-place-id="'+p.place_id+'"><div class="places-item-name">'+(p.structured_formatting?.main_text||p.description)+'</div><div class="places-item-address">'+(p.structured_formatting?.secondary_text||'')+'</div></div>'}).join('');dropdown.classList.add('show');dropdown.querySelectorAll('.places-item').forEach(function(item){item.onclick=async function(){var placeId=item.dataset.placeId;try{var details=await api('/api/places/details?place_id='+placeId);if(details.result){var bnEl=document.getElementById('custBusinessName');var baEl=document.getElementById('custBusinessNameAlt');var adEl=document.getElementById('custAddress');var piEl=document.getElementById('custPlaceId');var ciEl=document.getElementById('custCity');var diEl=document.getElementById('custDistrict');if(bnEl)bnEl.value=details.result.name||'';if(baEl)baEl.value=details.result.name||'';if(adEl)adEl.value=details.result.formatted_address||'';if(piEl)piEl.value=placeId;if(ciEl)ciEl.value=details.parsed?.city||'';if(diEl)diEl.value=details.parsed?.district||''}}catch(err){console.error(err)}dropdown.classList.remove('show')}})}else{dropdown.classList.remove('show')}}catch(err){dropdown.classList.remove('show')}},300)};document.addEventListener('click',function(e){if(!e.target.closest('.places-wrapper')){dropdown.classList.remove('show')}})}

async function saveCustomer(id){var bnEl=document.getElementById('custBusinessNameAlt');var bn2El=document.getElementById('custBusinessName');var businessName=(bnEl?.value)||(bn2El?.value)||'';var data={category_id:document.getElementById('custCategory')?.value,business_name:businessName,place_id:document.getElementById('custPlaceId')?.value||'',address:document.getElementById('custAddress')?.value||'',city:document.getElementById('custCity')?.value||'',district:document.getElementById('custDistrict')?.value||'',contact_name:document.getElementById('custContact')?.value||'',phone:document.getElementById('custPhone')?.value||'',email:document.getElementById('custEmail')?.value||'',tax_number:document.getElementById('custTaxNumber')?.value||'',price:document.getElementById('custPrice')?.value||0,is_invoiced:document.getElementById('custInvoiced')?.checked||false,scene_count:document.getElementById('custSceneCount')?.value||1,notes:document.getElementById('custNotes')?.value||''};if(!data.category_id){toast('Kategori seçin','error');return}if(!data.business_name){toast('İşletme adı girin','error');return}if(id){var activeStatus=document.querySelector('.status-btn.active');if(activeStatus)data.status=activeStatus.dataset.status}var btn=document.querySelector('#customerModal .btn-primary');if(btn){btn.disabled=true;btn.innerHTML='<span class="spinner" style="width:16px;height:16px;border-width:2px"></span>'}try{await api(id?'/api/customers/'+id:'/api/customers',{method:id?'PUT':'POST',body:JSON.stringify(data)});toast(id?'Müşteri güncellendi':'Müşteri oluşturuldu');closeModal();customers=await api('/api/customers');if(page==='customers')renderCustomers();else if(page==='dashboard'){stats=await api('/api/stats');renderDashboard()}}catch(err){toast(err.message,'error');if(btn){btn.disabled=false;btn.textContent=id?'Güncelle':'Kaydet'}}}

async function editCustomer(id){var c=customers.find(function(x){return x.id===id});if(c)showCustomerModal(c)}

// MÜŞTERİ DETAY MODAL - Karta tıklayınca açılır
function showCustomerDetail(id){var list=showDeleted?deletedCustomers:customers;var c=list.find(function(x){return x.id===id});if(!c)c=customers.find(function(x){return x.id===id});if(!c)return;var category=c.category||categories.find(function(cat){return cat.id===c.category_id});var statusInfo=c.status_info||statuses.find(function(s){return s.id===c.status});var m=document.createElement('div');m.className='modal';m.innerHTML='<div class="modal-content"><div class="modal-header"><h3 class="modal-title">'+escapeHtml(c.business_name)+'</h3><button class="modal-close" onclick="closeModal()">✕</button></div><div class="modal-body"><div style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-tertiary);border-radius:var(--radius-md);margin-bottom:16px"><div class="status-dot" style="background:'+(statusInfo?.color||'var(--border)')+'"></div><span style="font-weight:600">'+(statusInfo?.name||'-')+'</span></div><div class="customer-details-grid"><div class="detail-item"><span class="detail-label">Kategori</span><span class="detail-value">'+(category?.name||'-')+'</span></div><div class="detail-item"><span class="detail-label">Yetkili</span><span class="detail-value">'+(escapeHtml(c.contact_name)||'-')+'</span></div><div class="detail-item"><span class="detail-label">Telefon</span><span class="detail-value">'+(c.phone?'<a href="tel:'+c.phone+'">'+c.phone+'</a>':'-')+'</span></div><div class="detail-item"><span class="detail-label">E-Posta</span><span class="detail-value">'+(c.email?'<a href="mailto:'+c.email+'">'+c.email+'</a>':'-')+'</span></div><div class="detail-item"><span class="detail-label">Vergi No</span><span class="detail-value">'+(c.tax_number||'-')+'</span></div><div class="detail-item"><span class="detail-label">Lokasyon</span><span class="detail-value">'+(c.city||'-')+(c.district?' / '+c.district:'')+'</span></div></div><div style="background:var(--bg-tertiary);padding:16px;border-radius:var(--radius-md);margin-top:16px"><div class="detail-item" style="border:none;padding:0;margin-bottom:8px"><span class="detail-label">Fiyat</span><span class="detail-value" style="color:var(--accent-primary);font-size:20px;font-weight:700">'+formatMoney(c.price)+'</span></div>'+(c.is_invoiced&&c.price>0?'<div class="detail-item" style="padding:4px 0"><span class="detail-label">KDV\'siz</span><span class="detail-value">'+formatMoney(c.price_without_vat||c.price/1.2)+'</span></div><div class="detail-item" style="border:none;padding:4px 0"><span class="detail-label">KDV</span><span class="detail-value">'+formatMoney(c.vat_amount||(c.price-c.price/1.2))+'</span></div>':'')+'<div class="detail-item" style="border:none;padding:4px 0"><span class="detail-label">Sahne</span><span class="detail-value">'+(c.scene_count||1)+'</span></div></div>'+(c.notes?'<div style="margin-top:16px"><div class="form-label">Notlar</div><p style="color:var(--text-secondary);font-size:14px;background:var(--bg-tertiary);padding:12px;border-radius:var(--radius-sm)">'+escapeHtml(c.notes)+'</p></div>':'')+'</div><div class="modal-footer">'+(isAdmin()&&!c.is_deleted?'<button class="btn btn-danger" onclick="softDeleteCustomer(\''+c.id+'\')">Sil</button>':'')+'<button class="btn btn-secondary" onclick="closeModal();editCustomer(\''+c.id+'\')">Düzenle</button><button class="btn btn-primary" onclick="closeModal();sendMailToCustomer(\''+c.id+'\')">Mail Gönder</button></div></div>';document.body.appendChild(m);setupModalClose(m)}

async function changeStatus(id,status){try{await api('/api/customers/'+id+'/status',{method:'PATCH',body:JSON.stringify({status:status})});toast('Durum güncellendi');customers=await api('/api/customers');if(page==='customers')filterCustomers();else if(page==='dashboard'){stats=await api('/api/stats');renderDashboard()}}catch(err){toast(err.message,'error')}}

var currentVars={},currentCustomerId=null;
function sendMailToCustomer(id){var c=customers.find(function(x){return x.id===id});if(!c)return;
// Email kontrolü
if(!c.email){toast('Bu müşterinin e-posta adresi yok. Lütfen önce e-posta ekleyin.','error');editCustomer(id);return}
currentCustomerId=id;page='send';render();setTimeout(function(){var emailEl=document.getElementById('toEmail');var nameEl=document.getElementById('toName');if(c.email&&emailEl)emailEl.value=c.email;if(c.contact_name&&nameEl)nameEl.value=c.contact_name;window.mailCustomer=c;toast('Müşteri bilgileri yüklendi','info')},100)}

function setupSendPage(){var select=document.getElementById('templateSelect');if(!select)return;select.innerHTML='<option value="">Taslak seçin...</option>'+templates.map(function(t){return '<option value="'+t.id+'">'+t.name+'</option>'}).join('');select.onchange=onTemplateChange;var form=document.getElementById('sendForm');if(form)form.onsubmit=handleSend}

function onTemplateChange(){var selectEl=document.getElementById('templateSelect');if(!selectEl)return;var tid=selectEl.value;var t=templates.find(function(x){return x.id===tid});currentVars={};var varEl=document.getElementById('variableInputs');var prevEl=document.getElementById('sendPreview');if(!t){if(varEl)varEl.innerHTML='';if(prevEl)prevEl.innerHTML='<p style="color:var(--text-muted);text-align:center;padding:32px 0">Taslak seçin...</p>';return}if(t.variables?.length>0){var html='<div class="form-group"><label class="form-label">Değişkenler</label><div class="var-inputs">';t.variables.forEach(function(v){var def='';if(window.mailCustomer){var c=window.mailCustomer;if(v==='isim'||v==='ad'||v==='yetkili')def=c.contact_name||'';if(v==='firma'||v==='işletme'||v==='isletme')def=c.business_name||'';if(v==='fiyat'||v==='tutar'||v==='ucret')def=c.price||'';if(v==='email'||v==='eposta')def=c.email||'';if(v==='telefon'||v==='tel')def=c.phone||''}html+='<input type="text" class="var-input" id="var_'+v+'" placeholder="'+v+'" value="'+def+'" oninput="updateVar(\''+v+'\',this.value)">';if(def)currentVars[v]=def});html+='</div></div>';if(varEl)varEl.innerHTML=html}else{if(varEl)varEl.innerHTML=''}updatePreview()}

function updateVar(name,value){currentVars[name]=value;updatePreview()}

function updatePreview(){var selectEl=document.getElementById('templateSelect');if(!selectEl)return;var tid=selectEl.value;var t=templates.find(function(x){return x.id===tid});if(!t)return;var subject=t.subject;var body=t.body;Object.keys(currentVars).forEach(function(k){var re=new RegExp('\\{\\{'+k+'\\}\\}','g');var val=currentVars[k]||'<span class="var-tag">{{'+k+'}}</span>';subject=subject.replace(re,val);body=body.replace(re,val)});subject=subject.replace(/\{\{(\w+)\}\}/g,'<span class="var-tag">{{$1}}</span>');body=body.replace(/\{\{(\w+)\}\}/g,'<span class="var-tag">{{$1}}</span>');var prevEl=document.getElementById('sendPreview');if(prevEl)prevEl.innerHTML='<div class="preview-subject">'+subject+'</div><div style="font-size:14px;line-height:1.6;color:var(--text-secondary)">'+body+'</div>'}

async function handleSend(e){e.preventDefault();var selectEl=document.getElementById('templateSelect');var emailEl=document.getElementById('toEmail');var nameEl=document.getElementById('toName');if(!selectEl||!emailEl)return;var tid=selectEl.value;if(!tid){toast('Taslak seçin','error');return}var email=emailEl.value;if(!email){toast('E-posta adresi girin','error');return}var btn=e.target.querySelector('button[type="submit"]');if(btn){btn.disabled=true;btn.innerHTML='<span class="spinner" style="width:16px;height:16px;border-width:2px"></span> Gönderiliyor...'}try{await api('/api/emails/send',{method:'POST',body:JSON.stringify({template_id:tid,recipient_email:email,recipient_name:nameEl?.value||'',variables:currentVars,customer_id:currentCustomerId})});toast('Mail başarıyla gönderildi!');window.mailCustomer=null;currentCustomerId=null;currentVars={};var form=document.getElementById('sendForm');if(form)form.reset();var varEl=document.getElementById('variableInputs');if(varEl)varEl.innerHTML='';var prevEl=document.getElementById('sendPreview');if(prevEl)prevEl.innerHTML='<p style="color:var(--text-muted);text-align:center;padding:32px 0">Taslak seçin...</p>'}catch(err){toast(err.message,'error')}if(btn){btn.disabled=false;btn.innerHTML='<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>Mail Gönder'}}

async function viewEmail(id){try{var e=await api('/api/emails/'+id);var m=document.createElement('div');m.className='modal';m.innerHTML='<div class="modal-content modal-lg"><div class="modal-header"><h3 class="modal-title">Mail Detayı</h3><button class="modal-close" onclick="closeModal()">✕</button></div><div style="padding:16px;background:var(--bg-tertiary);border-bottom:1px solid var(--border)"><div style="font-size:16px;font-weight:700;margin-bottom:8px">'+escapeHtml(e.subject)+'</div><div style="display:flex;flex-wrap:wrap;gap:12px;font-size:12px;color:var(--text-muted)"><span><strong>Alıcı:</strong> '+escapeHtml(e.recipient_name||'')+' &lt;'+e.recipient_email+'&gt;</span><span><strong>Tarih:</strong> '+formatDate(e.sent_at)+'</span></div></div><div class="modal-body"><div style="font-size:14px;line-height:1.6;color:var(--text-secondary)">'+e.body+'</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Kapat</button></div></div>';document.body.appendChild(m);setupModalClose(m)}catch(err){toast(err.message,'error')}}

function showTemplateModal(edit){var m=document.createElement('div');m.className='modal';m.id='templateModal';m.innerHTML='<div class="modal-content modal-lg"><div class="modal-header"><h3 class="modal-title">'+(edit?'Taslak Düzenle':'Yeni Taslak')+'</h3><button class="modal-close" onclick="closeModal()">✕</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Taslak Adı *</label><input type="text" id="tplName" class="input" value="'+(edit?.name||'')+'" placeholder="Örn: Teklif Maili" required></div><div class="form-group"><label class="form-label">Konu *</label><input type="text" id="tplSubject" class="input" placeholder="{{değişken}} kullanabilirsiniz" value="'+(edit?.subject||'')+'" required></div><div class="form-group"><label class="form-label">İçerik *</label><div class="editor-container"><div class="editor-toolbar"><button type="button" class="toolbar-btn" onclick="document.execCommand(\'bold\')"><strong>B</strong></button><button type="button" class="toolbar-btn" onclick="document.execCommand(\'italic\')"><em>I</em></button><button type="button" class="toolbar-btn" onclick="insertVariable()">{{x}}</button></div><div id="tplBody" class="editor-area" contenteditable="true" data-placeholder="Mail içeriği...">'+(edit?.body||'')+'</div></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">İptal</button><button class="btn btn-primary" onclick="saveTemplate(\''+(edit?.id||'')+'\')">'+(edit?'Güncelle':'Kaydet')+'</button></div></div>';document.body.appendChild(m);setupModalClose(m)}

function insertVariable(){var name=prompt('Değişken adı:');if(name){document.execCommand('insertText',false,'{{'+name.trim()+'}}')}}

async function saveTemplate(id){var nameEl=document.getElementById('tplName');var subEl=document.getElementById('tplSubject');var bodyEl=document.getElementById('tplBody');if(!nameEl||!subEl||!bodyEl)return;var name=nameEl.value;var subject=subEl.value;var body=bodyEl.innerHTML;if(!name||!subject||!body){toast('Tüm alanları doldurun','error');return}try{await api(id?'/api/templates/'+id:'/api/templates',{method:id?'PUT':'POST',body:JSON.stringify({name:name,subject:subject,body:body})});toast(id?'Taslak güncellendi':'Taslak oluşturuldu');closeModal();templates=await api('/api/templates');renderTemplates()}catch(err){toast(err.message,'error')}}

async function editTemplate(id){var t=templates.find(function(x){return x.id===id});if(t)showTemplateModal(t)}

async function deleteTemplate(id){if(!confirm('Bu taslağı silmek istediğinize emin misiniz?'))return;try{await api('/api/templates/'+id,{method:'DELETE'});toast('Taslak silindi');templates=await api('/api/templates');renderTemplates()}catch(err){toast(err.message,'error')}}

function showTeamModal(){var m=document.createElement('div');m.className='modal';m.innerHTML='<div class="modal-content" style="max-width:380px"><div class="modal-header"><h3 class="modal-title">Yeni Ekip</h3><button class="modal-close" onclick="closeModal()">✕</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Ekip Adı *</label><input type="text" id="teamName" class="input" placeholder="Örn: İstanbul Avrupa" required></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">İptal</button><button class="btn btn-primary" onclick="saveTeam()">Kaydet</button></div></div>';document.body.appendChild(m);setupModalClose(m)}

async function saveTeam(){var nameEl=document.getElementById('teamName');if(!nameEl)return;var name=nameEl.value;if(!name){toast('Ekip adı girin','error');return}try{await api('/api/teams',{method:'POST',body:JSON.stringify({name:name})});toast('Ekip oluşturuldu');closeModal();teams=await api('/api/teams');renderTeams()}catch(err){toast(err.message,'error')}}

async function deleteTeam(id){if(!confirm('Bu ekibi silmek istediğinize emin misiniz?'))return;try{await api('/api/teams/'+id,{method:'DELETE'});toast('Ekip silindi');teams=await api('/api/teams');renderTeams()}catch(err){toast(err.message,'error')}}

function showUserModal(edit){var teamOpts=teams.map(function(t){return '<option value="'+t.id+'" '+(edit?.team_id===t.id?'selected':'')+'>'+t.name+'</option>'}).join('');var m=document.createElement('div');m.className='modal';m.innerHTML='<div class="modal-content" style="max-width:440px"><div class="modal-header"><h3 class="modal-title">'+(edit?'Kullanıcı Düzenle':'Yeni Kullanıcı')+'</h3><button class="modal-close" onclick="closeModal()">✕</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label class="form-label">Kullanıcı Adı *</label><input type="text" id="userName" class="input" value="'+(edit?.username||'')+'" '+(edit?'disabled style="opacity:0.6"':'required')+' placeholder="kullanici"></div><div class="form-group"><label class="form-label">Ad Soyad *</label><input type="text" id="userFullName" class="input" value="'+(edit?.full_name||'')+'" required placeholder="Ad Soyad"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ekip</label><select id="userTeam" class="input"><option value="">Ekip seçin</option>'+teamOpts+'</select></div><div class="form-group"><label class="form-label">Rol *</label><select id="userRole" class="input" required><option value="sales" '+(edit?.role==='sales'?'selected':'')+'>Satış</option><option value="manager" '+(edit?.role==='manager'?'selected':'')+'>Yönetici</option><option value="admin" '+(edit?.role==='admin'?'selected':'')+'>Admin</option></select></div></div><div class="form-group"><label class="form-label">Şifre '+(edit?'(boş bırakırsanız değişmez)':'*')+'</label><input type="password" id="userPass" class="input" '+(edit?'':'required')+' placeholder="••••••••" minlength="6"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">İptal</button><button class="btn btn-primary" onclick="saveUser(\''+(edit?.id||'')+'\')">'+(edit?'Güncelle':'Kaydet')+'</button></div></div>';document.body.appendChild(m);setupModalClose(m)}

async function saveUser(id){var fnEl=document.getElementById('userFullName');var teamEl=document.getElementById('userTeam');var roleEl=document.getElementById('userRole');var passEl=document.getElementById('userPass');var unEl=document.getElementById('userName');if(!fnEl||!roleEl)return;var data={full_name:fnEl.value,team_id:teamEl?.value||null,role:roleEl.value};if(!id){if(!unEl)return;data.username=unEl.value;if(!data.username){toast('Kullanıcı adı girin','error');return}}var pass=passEl?.value;if(pass)data.password=pass;else if(!id){toast('Şifre girin','error');return}if(!data.full_name){toast('Ad soyad girin','error');return}try{await api(id?'/api/users/'+id:'/api/users',{method:id?'PUT':'POST',body:JSON.stringify(data)});toast(id?'Kullanıcı güncellendi':'Kullanıcı oluşturuldu');closeModal();users=await api('/api/users');renderUsers()}catch(err){toast(err.message,'error')}}

async function editUser(id){var u=users.find(function(x){return x.id===id});if(u)showUserModal(u)}

async function deleteUser(id){if(!confirm('Bu kullanıcıyı silmek istediğinize emin misiniz?'))return;try{await api('/api/users/'+id,{method:'DELETE'});toast('Kullanıcı silindi');users=await api('/api/users');renderUsers()}catch(err){toast(err.message,'error')}}

(function init(){var t=localStorage.getItem('g360_token');var u=localStorage.getItem('g360_user');if(t&&u){try{user=JSON.parse(u);page='dashboard'}catch(e){localStorage.removeItem('g360_token');localStorage.removeItem('g360_user')}}render()})();
</script>
</body>
</html>
