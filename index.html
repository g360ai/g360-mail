<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G360 Mail</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:#f8fafc;color:#1e293b;min-height:100vh}
.btn{padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;font-size:14px}
.btn-primary{background:linear-gradient(135deg,#0d9488,#0891b2);color:#fff}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(13,148,136,0.3)}
.btn-secondary{background:#e2e8f0;color:#475569}
.btn-danger{background:#fee2e2;color:#dc2626}
.btn-sm{padding:6px 12px;font-size:12px}
.input{width:100%;padding:12px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;transition:border 0.2s;background:#fff;-webkit-appearance:none}
.input:focus{outline:none;border-color:#0d9488}
.card{background:#fff;border-radius:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);border:1px solid #e2e8f0}
.badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap}
.badge-success{background:#d1fae5;color:#059669}
.badge-danger{background:#fee2e2;color:#dc2626}
.badge-info{background:#e0f2fe;color:#0284c7}
.badge-purple{background:#f3e8ff;color:#9333ea}
.badge-orange{background:#ffedd5;color:#ea580c}

.app{display:flex;min-height:100vh}
.sidebar{width:260px;background:#fff;border-right:1px solid #e2e8f0;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100}
.main{flex:1;margin-left:260px;min-height:100vh}
.content{padding:24px;max-width:1200px;margin:0 auto}

@media(max-width:900px){
  .sidebar{transform:translateX(-100%);transition:transform 0.3s}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0}
  .mobile-header{display:flex!important}
  .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
  .overlay.show{display:block}
  .content{padding:16px;padding-top:70px}
  .send-grid{grid-template-columns:1fr!important}
  .stats-grid{grid-template-columns:1fr 1fr!important}
}

.sidebar-header{padding:20px;border-bottom:1px solid #e2e8f0}
.sidebar-logo{display:flex;align-items:center;gap:12px;cursor:pointer}
.sidebar-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#0d9488,#0891b2);border-radius:10px;display:flex;align-items:center;justify-content:center}
.sidebar-logo-icon svg{width:24px;height:24px;color:#fff}
.sidebar-logo-text{font-size:20px;font-weight:700;color:#0d9488}
.sidebar-nav{flex:1;padding:12px;overflow-y:auto}
.nav-section{margin-bottom:20px}
.nav-title{font-size:11px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;padding:0 12px;margin-bottom:8px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#64748b;cursor:pointer;transition:all 0.2s;margin-bottom:2px;font-size:14px}
.nav-item:hover{background:#f1f5f9;color:#0d9488}
.nav-item.active{background:linear-gradient(135deg,rgba(13,148,136,0.1),rgba(8,145,178,0.1));color:#0d9488;font-weight:600}
.nav-item svg{width:20px;height:20px;flex-shrink:0}
.sidebar-footer{padding:12px;border-top:1px solid #e2e8f0}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;background:#f8fafc;border-radius:10px}
.user-avatar{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px}
.user-info{flex:1;min-width:0}
.user-name{font-weight:600;font-size:13px;color:#1e293b}
.user-role{font-size:11px;color:#64748b}
.logout-btn{padding:6px;border-radius:6px;background:transparent;border:none;cursor:pointer;color:#94a3b8}
.logout-btn:hover{background:#fee2e2;color:#dc2626}

.mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:56px;background:#fff;border-bottom:1px solid #e2e8f0;padding:0 16px;align-items:center;justify-content:space-between;z-index:98}
.menu-btn{padding:8px;border:none;background:transparent;cursor:pointer}

.page-header{margin-bottom:20px}
.page-title{font-size:24px;font-weight:700;color:#1e293b;margin-bottom:4px}
.page-subtitle{color:#64748b;font-size:14px}

.quick-action{background:linear-gradient(135deg,#0d9488,#0891b2);color:#fff;padding:14px 24px;border-radius:12px;display:flex;align-items:center;justify-content:center;gap:10px;font-weight:600;cursor:pointer;margin-bottom:20px;font-size:15px}
.quick-action:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(13,148,136,0.4)}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{padding:16px;display:flex;align-items:center;gap:12px}
.stat-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.stat-icon svg{width:22px;height:22px}
.stat-value{font-size:24px;font-weight:700;color:#1e293b}
.stat-label{font-size:12px;color:#64748b}

/* Mobile-friendly email list */
.email-list{display:flex;flex-direction:column}
.email-item{display:flex;align-items:center;padding:14px 0;border-bottom:1px solid #f1f5f9;cursor:pointer;gap:12px}
.email-item:hover{background:#f8fafc;margin:0 -16px;padding-left:16px;padding-right:16px}
.email-avatar{width:40px;height:40px;background:#f1f5f9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:600;color:#64748b;font-size:14px;flex-shrink:0}
.email-content{flex:1;min-width:0}
.email-recipient{font-weight:600;font-size:14px;color:#1e293b;margin-bottom:2px}
.email-subject{font-size:13px;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.email-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.email-date{font-size:11px;color:#94a3b8}

/* Table for desktop */
.table-container{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:12px 16px;font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;border-bottom:2px solid #e2e8f0}
td{padding:14px 16px;border-bottom:1px solid #f1f5f9;font-size:14px}
tr:hover td{background:#f8fafc}
.table-empty{padding:40px;text-align:center;color:#94a3b8}

@media(max-width:900px){
  .desktop-table{display:none!important}
  .mobile-list{display:block!important}
}
@media(min-width:901px){
  .desktop-table{display:block!important}
  .mobile-list{display:none!important}
}

.modal{position:fixed;inset:0;background:rgba(15,23,42,0.6);display:flex;align-items:center;justify-content:center;z-index:200;padding:16px}
.modal-content{background:#fff;border-radius:16px;width:100%;max-width:600px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:18px;font-weight:700}
.modal-close{padding:8px;border:none;background:#f1f5f9;border-radius:8px;cursor:pointer;font-size:16px}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-footer{padding:16px 20px;border-top:1px solid #e2e8f0;display:flex;gap:12px;justify-content:flex-end}
.modal-lg{max-width:800px}

.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px}
.form-hint{font-size:12px;color:#94a3b8;margin-top:4px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}

.editor-container{border:2px solid #e2e8f0;border-radius:10px;overflow:hidden}
.editor-toolbar{padding:10px;background:#f8fafc;border-bottom:1px solid #e2e8f0;display:flex;flex-wrap:wrap;gap:6px}
.toolbar-btn{padding:6px 10px;border:1px solid #e2e8f0;background:#fff;border-radius:6px;cursor:pointer;font-size:12px}
.toolbar-btn:hover{background:#f1f5f9}
.editor-area{min-height:150px;padding:12px;outline:none;font-size:14px;line-height:1.6}
.editor-area:empty:before{content:attr(data-placeholder);color:#94a3b8}
.editor-area img{max-width:180px;height:auto;border-radius:4px}
.var-tag{display:inline-block;background:linear-gradient(135deg,#fef3c7,#fde68a);color:#92400e;padding:2px 8px;border-radius:4px;font-weight:600;font-size:12px}

.send-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.preview-box{background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:20px;min-height:200px;max-height:400px;overflow-y:auto}
.preview-subject{font-size:15px;font-weight:600;color:#1e293b;padding-bottom:12px;margin-bottom:12px;border-bottom:1px solid #e2e8f0}

.var-input-wrapper{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:8px}
.var-input{background:#fef3c7;border:2px solid #fcd34d;border-radius:8px;padding:10px 12px;font-weight:500;color:#78350f;font-size:14px;width:100%;-webkit-appearance:none}
.var-input:focus{outline:none;border-color:#f59e0b;background:#fef9c3}
.var-input::placeholder{color:#a16207;opacity:1}

.email-detail-header{padding:16px 20px;background:#f8fafc;border-bottom:1px solid #e2e8f0}
.email-detail-subject{font-size:16px;font-weight:600;margin-bottom:12px}
.email-detail-meta{display:flex;flex-wrap:wrap;gap:16px;font-size:13px;color:#64748b}
.email-detail-meta strong{color:#1e293b}
.email-detail-body{padding:20px}
.email-detail-body img{max-width:100%;height:auto}

.toast{position:fixed;top:16px;right:16px;padding:14px 20px;border-radius:10px;color:#fff;font-weight:500;z-index:300;animation:slideIn 0.3s;font-size:14px}
.toast-success{background:linear-gradient(135deg,#059669,#10b981)}
.toast-error{background:linear-gradient(135deg,#dc2626,#ef4444)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* Templates grid */
.templates-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
</style>
</head>
<body>
<div id="app"></div>

<script>
let user = null;
let page = 'login';
let templates = [];
let teams = [];
let emails = [];
let sidebarOpen = false;

const API = '';

function token() { return localStorage.getItem('token'); }

async function api(url, opts = {}) {
  opts.headers = { 'Content-Type': 'application/json' };
  if (token()) opts.headers.Authorization = 'Bearer ' + token();
  const res = await fetch(API + url, opts);
  const data = await res.json();
  if (res.status === 401) { localStorage.clear(); page = 'login'; render(); throw new Error('Oturum sonlandi'); }
  if (!res.ok) throw new Error(data.error || 'Hata olustu');
  return data;
}

function toast(msg, type = 'success') {
  const t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function nav(p) { page = p; render(); }
function toggleSidebar() { sidebarOpen = !sidebarOpen; render(); }
function closeSidebar() { sidebarOpen = false; render(); }
function goHome() { nav('dashboard'); }

function isAdmin() { return user?.role === 'admin'; }
function isManager() { return user?.role === 'manager'; }

function getRoleName(r) {
  if (r === 'admin') return 'Admin';
  if (r === 'manager') return 'BÃ¶lge YÃ¶neticisi';
  return 'SatÄ±ÅŸ Personeli';
}

function getRoleColor(r) {
  if (r === 'admin') return 'background:linear-gradient(135deg,#f59e0b,#d97706)';
  if (r === 'manager') return 'background:linear-gradient(135deg,#8b5cf6,#7c3aed)';
  return 'background:linear-gradient(135deg,#0d9488,#0891b2)';
}

function formatDate(d) {
  return new Date(d).toLocaleString('tr-TR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

function formatShortDate(d) {
  const date = new Date(d);
  const today = new Date();
  if (date.toDateString() === today.toDateString()) {
    return date.toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit' });
  }
  return date.toLocaleDateString('tr-TR', { day:'2-digit', month:'2-digit' });
}

function render() {
  const app = document.getElementById('app');
  if (page === 'login') {
    app.innerHTML = loginPage();
    setupLogin();
  } else {
    app.innerHTML = `
      <div class="app">
        <div class="overlay ${sidebarOpen ? 'show' : ''}" onclick="closeSidebar()"></div>
        ${sidebar()}
        <div class="main">
          ${mobileHeader()}
          <div class="content">
            ${page === 'dashboard' ? dashboardPage() : ''}
            ${page === 'send' ? sendPage() : ''}
            ${page === 'emails' ? emailsPage() : ''}
            ${page === 'templates' ? templatesPage() : ''}
            ${page === 'teams' ? teamsPage() : ''}
            ${page === 'users' ? usersPage() : ''}
            ${page === 'settings' ? settingsPage() : ''}
          </div>
        </div>
      </div>
    `;
    loadPageData();
  }
}

function loginPage() {
  return `
    <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#f0fdfa,#ecfeff)">
      <div class="card" style="width:100%;max-width:380px;padding:32px">
        <div style="text-align:center;margin-bottom:28px">
          <div style="width:56px;height:56px;background:linear-gradient(135deg,#0d9488,#0891b2);border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 14px">
            <svg width="28" height="28" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          </div>
          <h1 style="font-size:24px;font-weight:700;color:#0d9488">G360 Mail</h1>
          <p style="color:#64748b;margin-top:6px;font-size:14px">Mail YÃ¶netim Sistemi</p>
        </div>
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label">KullanÄ±cÄ± AdÄ±</label>
            <input type="text" id="username" class="input" placeholder="KullanÄ±cÄ± adÄ±nÄ±z" required>
          </div>
          <div class="form-group">
            <label class="form-label">Åžifre</label>
            <input type="password" id="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
          </div>
          <button type="submit" class="btn btn-primary" style="width:100%;padding:12px">GiriÅŸ Yap</button>
        </form>
      </div>
    </div>
  `;
}

function sidebar() {
  return `
    <aside class="sidebar ${sidebarOpen ? 'open' : ''}">
      <div class="sidebar-header">
        <div class="sidebar-logo" onclick="goHome();closeSidebar()">
          <div class="sidebar-logo-icon">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          </div>
          <span class="sidebar-logo-text">G360 Mail</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-item ${page === 'dashboard' ? 'active' : ''}" onclick="nav('dashboard');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span>Ana Sayfa</span>
          </div>
          <div class="nav-item ${page === 'send' ? 'active' : ''}" onclick="nav('send');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
            <span>Mail GÃ¶nder</span>
          </div>
          <div class="nav-item ${page === 'emails' ? 'active' : ''}" onclick="nav('emails');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            <span>Mailler</span>
          </div>
        </div>
        ${isAdmin() ? `
        <div class="nav-section">
          <div class="nav-title">YÃ¶netim</div>
          <div class="nav-item ${page === 'templates' ? 'active' : ''}" onclick="nav('templates');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span>Taslaklar</span>
          </div>
          <div class="nav-item ${page === 'teams' ? 'active' : ''}" onclick="nav('teams');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>Ekipler</span>
          </div>
          <div class="nav-item ${page === 'users' ? 'active' : ''}" onclick="nav('users');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span>KullanÄ±cÄ±lar</span>
          </div>
          <div class="nav-item ${page === 'settings' ? 'active' : ''}" onclick="nav('settings');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>Ayarlar</span>
          </div>
        </div>
        ` : ''}
      </nav>
      <div class="sidebar-footer">
        <div class="user-card">
          <div class="user-avatar" style="${getRoleColor(user?.role)}">${user?.full_name?.[0] || '?'}</div>
          <div class="user-info">
            <div class="user-name">${user?.full_name || ''}</div>
            <div class="user-role">${getRoleName(user?.role)}</div>
          </div>
          <button class="logout-btn" onclick="logout()" title="Ã‡Ä±kÄ±ÅŸ">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>
  `;
}

function mobileHeader() {
  return `
    <div class="mobile-header">
      <button class="menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
      <span style="font-weight:700;color:#0d9488;cursor:pointer" onclick="goHome()">G360 Mail</span>
      <div style="width:40px"></div>
    </div>
  `;
}

function dashboardPage() {
  return `
    <div class="page-header">
      <p style="color:#64748b;font-size:14px">HoÅŸ geldin,</p>
      <h1 class="page-title">${user?.full_name || ''}</h1>
    </div>
    <div class="quick-action" onclick="nav('send')">
      <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
      <span>+ Yeni Mail GÃ¶nder</span>
    </div>
    <div id="stats" class="stats-grid"></div>
    <div class="card" style="padding:20px">
      <h2 style="font-size:16px;font-weight:600;margin-bottom:16px">Son Mailler</h2>
      <div id="recentEmails"></div>
    </div>
  `;
}

function sendPage() {
  return `
    <div class="page-header">
      <h1 class="page-title">Mail GÃ¶nder</h1>
      <p class="page-subtitle">Taslak seÃ§in, bilgileri doldurun, gÃ¶nderin</p>
    </div>
    <div class="send-grid">
      <div class="card" style="padding:20px">
        <form id="sendForm">
          <div class="form-group">
            <label class="form-label">Mail TaslaÄŸÄ±</label>
            <select id="templateSelect" class="input">
              <option value="">Taslak seÃ§in...</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">AlÄ±cÄ± E-posta *</label>
              <input type="email" id="toEmail" class="input" placeholder="ornek@firma.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">AlÄ±cÄ± AdÄ±</label>
              <input type="text" id="toName" class="input" placeholder="Ahmet Bey">
            </div>
          </div>
          <div id="variableInputs"></div>
          <button type="submit" class="btn btn-primary" style="width:100%;padding:14px;margin-top:8px">
            <span style="display:flex;align-items:center;justify-content:center;gap:8px">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              Mail GÃ¶nder
            </span>
          </button>
        </form>
      </div>
      <div>
        <div class="card" style="padding:20px;position:sticky;top:80px">
          <h3 style="font-size:14px;font-weight:600;margin-bottom:12px;color:#64748b">ðŸ“§ Ã–nizleme</h3>
          <div id="sendPreview" class="preview-box">
            <p style="color:#94a3b8;text-align:center;padding:30px;font-size:14px">Taslak seÃ§in...</p>
          </div>
        </div>
      </div>
    </div>
  `;
}

function emailsPage() {
  const title = isAdmin() ? 'TÃ¼m Mailler' : isManager() ? 'Ekip Mailleri' : 'Maillerim';
  return `
    <div class="page-header">
      <h1 class="page-title">${title}</h1>
      <p class="page-subtitle" id="emailCount"></p>
    </div>
    <div class="card" style="padding:16px">
      <div class="mobile-list" id="emailListMobile"></div>
      <div class="desktop-table">
        <div class="table-container" id="emailsTable"></div>
      </div>
    </div>
  `;
}

function templatesPage() {
  return `
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div>
        <h1 class="page-title">Mail TaslaklarÄ±</h1>
        <p class="page-subtitle">Taslak oluÅŸturun, deÄŸiÅŸkenleri belirleyin</p>
      </div>
      <button class="btn btn-primary" onclick="showTemplateModal()">+ Yeni Taslak</button>
    </div>
    <div id="templatesList"></div>
  `;
}

function teamsPage() {
  return `
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div>
        <h1 class="page-title">Ekipler</h1>
        <p class="page-subtitle">SatÄ±ÅŸ ekiplerini yÃ¶netin</p>
      </div>
      <button class="btn btn-primary" onclick="showTeamModal()">+ Yeni Ekip</button>
    </div>
    <div id="teamsList" class="templates-grid"></div>
  `;
}

function usersPage() {
  return `
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div>
        <h1 class="page-title">KullanÄ±cÄ±lar</h1>
        <p class="page-subtitle">Ekip Ã¼yelerini yÃ¶netin</p>
      </div>
      <button class="btn btn-primary" onclick="showUserModal()">+ Yeni KullanÄ±cÄ±</button>
    </div>
    <div class="card">
      <div class="table-container" id="usersTable"></div>
    </div>
  `;
}

function settingsPage() {
  return `
    <div class="page-header">
      <h1 class="page-title">Ayarlar</h1>
      <p class="page-subtitle">Ä°mza ve diÄŸer ayarlar</p>
    </div>
    <div class="card" style="padding:20px;max-width:700px">
      <h3 style="font-size:16px;font-weight:600;margin-bottom:12px">Mail Ä°mzasÄ±</h3>
      <p style="color:#64748b;font-size:13px;margin-bottom:16px">Her mailin altÄ±na otomatik eklenecek imza. Logo iÃ§in "ðŸ–¼ Resim Ekle" butonunu kullanÄ±n.</p>
      <div class="editor-container">
        <div class="editor-toolbar">
          <button type="button" class="toolbar-btn" onclick="execCmd('bold')"><strong>B</strong></button>
          <button type="button" class="toolbar-btn" onclick="execCmd('italic')"><em>I</em></button>
          <button type="button" class="toolbar-btn" onclick="insertImageToSignature()">ðŸ–¼ Resim Ekle</button>
        </div>
        <div id="signatureArea" class="editor-area" contenteditable="true" data-placeholder="Ä°mza yazÄ±n..."></div>
      </div>
      <button class="btn btn-primary" style="margin-top:12px" onclick="saveSignature()">Ä°mzayÄ± Kaydet</button>
    </div>
  `;
}

// DATA LOADING
async function loadPageData() {
  try {
    templates = await api('/api/templates');
    emails = await api('/api/emails');
    
    if (page === 'dashboard') {
      const stats = await api('/api/stats');
      document.getElementById('stats').innerHTML = `
        <div class="card stat-card">
          <div class="stat-icon" style="background:#dbeafe"><svg fill="none" stroke="#2563eb" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></div>
          <div><div class="stat-value">${stats.total}</div><div class="stat-label">Toplam Mail</div></div>
        </div>
        <div class="card stat-card">
          <div class="stat-icon" style="background:#d1fae5"><svg fill="none" stroke="#059669" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg></div>
          <div><div class="stat-value" style="color:#059669">${stats.sent}</div><div class="stat-label">BaÅŸarÄ±lÄ±</div></div>
        </div>
        <div class="card stat-card">
          <div class="stat-icon" style="background:#fee2e2"><svg fill="none" stroke="#dc2626" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></div>
          <div><div class="stat-value" style="color:#dc2626">${stats.failed}</div><div class="stat-label">BaÅŸarÄ±sÄ±z</div></div>
        </div>
        <div class="card stat-card">
          <div class="stat-icon" style="background:#f3e8ff"><svg fill="none" stroke="#9333ea" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg></div>
          <div><div class="stat-value" style="color:#9333ea">${stats.teams}</div><div class="stat-label">Ekip</div></div>
        </div>
      `;
      
      const recentHtml = emails.slice(0, 5).map(e => `
        <div class="email-item" onclick="viewEmail('${e.id}')">
          <div class="email-avatar">${(e.recipient_name || e.recipient_email)[0].toUpperCase()}</div>
          <div class="email-content">
            <div class="email-recipient">${e.recipient_name || e.recipient_email}</div>
            <div class="email-subject">${e.subject}</div>
          </div>
          <div class="email-meta">
            <span class="badge ${e.status === 'sent' ? 'badge-success' : 'badge-danger'}">${e.status === 'sent' ? 'OK' : 'Hata'}</span>
            <span class="email-date">${formatShortDate(e.sent_at)}</span>
          </div>
        </div>
      `).join('');
      document.getElementById('recentEmails').innerHTML = recentHtml || '<p style="text-align:center;color:#94a3b8;padding:20px">HenÃ¼z mail yok</p>';
    }
    
    if (page === 'send') {
      const select = document.getElementById('templateSelect');
      select.innerHTML = '<option value="">Taslak seÃ§in...</option>' + templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      select.onchange = onTemplateChange;
      document.getElementById('sendForm').onsubmit = handleSend;
    }
    
    if (page === 'emails') {
      document.getElementById('emailCount').textContent = emails.length + ' mail';
      
      // Mobile list
      const mobileHtml = emails.map(e => `
        <div class="email-item" onclick="viewEmail('${e.id}')">
          <div class="email-avatar">${(e.recipient_name || e.recipient_email)[0].toUpperCase()}</div>
          <div class="email-content">
            <div class="email-recipient">${e.recipient_name || '-'}</div>
            <div class="email-subject">${e.subject}</div>
          </div>
          <div class="email-meta">
            <span class="badge ${e.status === 'sent' ? 'badge-success' : 'badge-danger'}">${e.status === 'sent' ? 'OK' : 'Hata'}</span>
            <span class="email-date">${formatShortDate(e.sent_at)}</span>
          </div>
        </div>
      `).join('');
      document.getElementById('emailListMobile').innerHTML = mobileHtml || '<p style="text-align:center;color:#94a3b8;padding:20px">HenÃ¼z mail yok</p>';
      
      // Desktop table
      const hasTeamCol = isAdmin();
      const hasSenderCol = isAdmin() || isManager();
      
      let html = `<table><thead><tr>
        <th>AlÄ±cÄ±</th>
        ${hasSenderCol ? '<th>GÃ¶nderen</th>' : ''}
        ${hasTeamCol ? '<th>Ekip</th>' : ''}
        <th>Konu</th>
        <th>Durum</th>
        <th>Tarih</th>
      </tr></thead><tbody>`;
      
      if (emails.length === 0) {
        html += `<tr><td colspan="6" class="table-empty">HenÃ¼z mail yok</td></tr>`;
      } else {
        emails.forEach(e => {
          html += `<tr style="cursor:pointer" onclick="viewEmail('${e.id}')">
            <td><div style="font-weight:500">${e.recipient_name || '-'}</div><div style="font-size:11px;color:#64748b">${e.recipient_email}</div></td>
            ${hasSenderCol ? `<td style="font-size:13px">${e.sender_name || '-'}</td>` : ''}
            ${hasTeamCol ? `<td><span class="badge badge-info">${e.team_name || '-'}</span></td>` : ''}
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:13px">${e.subject}</td>
            <td><span class="badge ${e.status === 'sent' ? 'badge-success' : 'badge-danger'}">${e.status === 'sent' ? 'GÃ¶nderildi' : 'BaÅŸarÄ±sÄ±z'}</span></td>
            <td style="font-size:12px;color:#64748b">${formatDate(e.sent_at)}</td>
          </tr>`;
        });
      }
      html += '</tbody></table>';
      document.getElementById('emailsTable').innerHTML = html;
    }
    
    if (page === 'templates') {
      let html = '<div class="templates-grid">';
      templates.forEach(t => {
        html += `
          <div class="card" style="padding:16px">
            <h3 style="font-weight:600;font-size:15px;margin-bottom:6px">${t.name}</h3>
            <p style="font-size:12px;color:#64748b;margin-bottom:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${t.subject}</p>
            <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">
              ${(t.variables||[]).map(v => `<span class="badge badge-orange">{{${v}}}</span>`).join('')}
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-secondary btn-sm" onclick="editTemplate('${t.id}')">DÃ¼zenle</button>
              <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${t.id}')">Sil</button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      document.getElementById('templatesList').innerHTML = html || '<p class="table-empty">HenÃ¼z taslak yok</p>';
    }
    
    if (page === 'teams') {
      teams = await api('/api/teams');
      let html = '';
      teams.forEach(t => {
        html += `
          <div class="card" style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="display:flex;align-items:center;gap:10px">
                <div style="width:40px;height:40px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${t.name[0]}</div>
                <h3 style="font-weight:600;font-size:15px">${t.name}</h3>
              </div>
              <button class="btn btn-danger btn-sm" onclick="deleteTeam('${t.id}')">Sil</button>
            </div>
          </div>
        `;
      });
      document.getElementById('teamsList').innerHTML = html || '<p class="table-empty">HenÃ¼z ekip yok</p>';
    }
    
    if (page === 'users') {
      const users = await api('/api/users');
      teams = await api('/api/teams');
      
      let html = `<table><thead><tr><th>KullanÄ±cÄ±</th><th>Ekip</th><th>Rol</th><th style="text-align:right">Ä°ÅŸlem</th></tr></thead><tbody>`;
      users.forEach(u => {
        html += `<tr>
          <td>
            <div style="display:flex;align-items:center;gap:10px">
              <div style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:13px;${getRoleColor(u.role)}">${u.full_name[0]}</div>
              <div><div style="font-weight:500;font-size:14px">${u.full_name}</div><div style="font-size:11px;color:#64748b">@${u.username}</div></div>
            </div>
          </td>
          <td><span class="badge badge-info">${u.team_name || '-'}</span></td>
          <td><span class="badge ${u.role === 'admin' ? 'badge-orange' : u.role === 'manager' ? 'badge-purple' : 'badge-success'}">${getRoleName(u.role)}</span></td>
          <td style="text-align:right">
            ${u.role !== 'admin' ? `
              <button class="btn btn-secondary btn-sm" onclick="editUser('${u.id}')">DÃ¼zenle</button>
              <button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Sil</button>
            ` : '<span style="color:#94a3b8;font-size:12px">Admin</span>'}
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('usersTable').innerHTML = html;
    }
    
    if (page === 'settings') {
      const settings = await api('/api/settings');
      document.getElementById('signatureArea').innerHTML = settings.signature || '';
    }
  } catch (err) {
    console.error(err);
  }
}

// SEND PAGE
let currentTemplateVars = {};

function onTemplateChange() {
  const tid = document.getElementById('templateSelect').value;
  const t = templates.find(x => x.id === tid);
  currentTemplateVars = {};
  
  if (!t) {
    document.getElementById('variableInputs').innerHTML = '';
    document.getElementById('sendPreview').innerHTML = '<p style="color:#94a3b8;text-align:center;padding:30px;font-size:14px">Taslak seÃ§in...</p>';
    return;
  }
  
  if (t.variables && t.variables.length > 0) {
    let html = '<div class="form-group"><label class="form-label">DeÄŸiÅŸkenleri Doldurun</label><div class="var-input-wrapper">';
    t.variables.forEach(v => {
      html += `<input type="text" class="var-input" id="var_${v}" placeholder="${v}" oninput="updateVarValue('${v}', this.value)">`;
    });
    html += '</div></div>';
    document.getElementById('variableInputs').innerHTML = html;
  } else {
    document.getElementById('variableInputs').innerHTML = '';
  }
  
  updatePreview();
}

function updateVarValue(name, value) {
  currentTemplateVars[name] = value;
  updatePreview();
}

function updatePreview() {
  const tid = document.getElementById('templateSelect').value;
  const t = templates.find(x => x.id === tid);
  if (!t) return;
  
  let html = t.body;
  let subject = t.subject;
  
  (t.variables || []).forEach(v => {
    const val = currentTemplateVars[v] || '';
    const display = val || `<span class="var-tag">${v}</span>`;
    const re = new RegExp('\\{\\{' + v + '\\}\\}', 'g');
    html = html.replace(re, display);
    subject = subject.replace(re, val || `[${v}]`);
  });
  
  document.getElementById('sendPreview').innerHTML = `
    <div class="preview-subject">${subject}</div>
    <div style="font-size:14px;line-height:1.6">${html}</div>
  `;
}

async function handleSend(e) {
  e.preventDefault();
  const tid = document.getElementById('templateSelect').value;
  if (!tid) { toast('Taslak seÃ§in', 'error'); return; }
  
  const btn = e.target.querySelector('button[type=submit]');
  btn.disabled = true;
  btn.innerHTML = '<span>GÃ¶nderiliyor...</span>';
  
  try {
    await api('/api/emails/send', {
      method: 'POST',
      body: JSON.stringify({
        template_id: tid,
        recipient_email: document.getElementById('toEmail').value,
        recipient_name: document.getElementById('toName').value,
        variables: currentTemplateVars
      })
    });
    toast('Mail baÅŸarÄ±yla gÃ¶nderildi!');
    nav('emails');
  } catch (err) {
    toast(err.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<span style="display:flex;align-items:center;justify-content:center;gap:8px"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>Mail GÃ¶nder</span>';
  }
}

// LOGIN
function setupLogin() {
  document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    try {
      const res = await api('/api/auth/login', {
        method: 'POST',
        body: JSON.stringify({
          username: document.getElementById('username').value,
          password: document.getElementById('password').value
        })
      });
      localStorage.setItem('token', res.token);
      localStorage.setItem('user', JSON.stringify(res.user));
      user = res.user;
      toast('GiriÅŸ baÅŸarÄ±lÄ±!');
      nav('dashboard');
    } catch (err) {
      toast(err.message, 'error');
    }
  };
}

function logout() { localStorage.clear(); user = null; nav('login'); }

// VIEW EMAIL - Fixed with recipient name and email
async function viewEmail(id) {
  try {
    const e = await api('/api/emails/' + id);
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content modal-lg">
        <div class="modal-header">
          <h3 class="modal-title">Mail DetayÄ±</h3>
          <button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button>
        </div>
        <div class="email-detail-header">
          <div class="email-detail-subject">${e.subject}</div>
          <div class="email-detail-meta">
            <div><strong>AlÄ±cÄ±:</strong> ${e.recipient_name || 'Ä°simsiz'} &lt;${e.recipient_email}&gt;</div>
            <div><strong>Tarih:</strong> ${formatDate(e.sent_at)}</div>
            <span class="badge ${e.status === 'sent' ? 'badge-success' : 'badge-danger'}">${e.status === 'sent' ? 'GÃ¶nderildi' : 'BaÅŸarÄ±sÄ±z'}</span>
          </div>
        </div>
        <div class="email-detail-body">${e.body}</div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
  } catch (err) {
    toast(err.message, 'error');
  }
}

// TEMPLATE MODAL
function showTemplateModal(edit = null) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.id = 'templateModal';
  modal.innerHTML = `
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">${edit ? 'TaslaÄŸÄ± DÃ¼zenle' : 'Yeni Taslak'}</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Taslak AdÄ±</label>
          <input type="text" id="tplName" class="input" placeholder="Ã–rn: Teklif Maili" value="${edit?.name || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Mail Konusu</label>
          <input type="text" id="tplSubject" class="input" placeholder="Ã–rn: Teklif - {{firma}}" value="${edit?.subject || ''}" required>
          <p class="form-hint">DeÄŸiÅŸken iÃ§in {{isim}} formatÄ± kullanÄ±n</p>
        </div>
        <div class="form-group">
          <label class="form-label">Mail Ä°Ã§eriÄŸi</label>
          <div class="editor-container">
            <div class="editor-toolbar">
              <button type="button" class="toolbar-btn" onclick="execCmd('bold')"><strong>B</strong></button>
              <button type="button" class="toolbar-btn" onclick="execCmd('italic')"><em>I</em></button>
              <button type="button" class="toolbar-btn" onclick="execCmd('underline')"><u>U</u></button>
              <button type="button" class="toolbar-btn" onclick="insertVar()">+ DeÄŸiÅŸken</button>
            </div>
            <div id="tplBody" class="editor-area" contenteditable="true" data-placeholder="Mail iÃ§eriÄŸini yazÄ±n...">${edit?.body || ''}</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveTemplate('${edit?.id || ''}')">${edit ? 'GÃ¼ncelle' : 'Kaydet'}</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
}

function execCmd(cmd) { document.execCommand(cmd, false, null); }

function insertVar() {
  const name = prompt('DeÄŸiÅŸken adÄ± (boÅŸluksuz):');
  if (name && /^\w+$/.test(name)) {
    document.execCommand('insertHTML', false, `<span class="var-tag">{{${name}}}</span>&nbsp;`);
  } else if (name) {
    toast('DeÄŸiÅŸken adÄ± sadece harf ve rakam iÃ§erebilir', 'error');
  }
}

function insertImageToSignature() {
  const url = prompt('Logo/Resim URL\'si girin:\n\nÃ–rnek: https://raw.githubusercontent.com/g360ai/g360-mail/main/Transparent%20-%20Kopya.png');
  if (url) {
    document.execCommand('insertHTML', false, `<img src="${url}" alt="Logo" style="max-width:150px;height:auto;display:block;margin:10px 0;">`);
  }
}

async function saveTemplate(id) {
  const body = document.getElementById('tplBody').innerHTML.replace(/<span class="var-tag">\{\{(\w+)\}\}<\/span>/g, '{{$1}}');
  
  try {
    await api(id ? '/api/templates/' + id : '/api/templates', {
      method: id ? 'PUT' : 'POST',
      body: JSON.stringify({
        name: document.getElementById('tplName').value,
        subject: document.getElementById('tplSubject').value,
        body: body
      })
    });
    toast(id ? 'Taslak gÃ¼ncellendi!' : 'Taslak oluÅŸturuldu!');
    document.getElementById('templateModal').remove();
    loadPageData();
  } catch (err) {
    toast(err.message, 'error');
  }
}

function editTemplate(id) {
  const t = templates.find(x => x.id === id);
  if (t) {
    const bodyWithTags = t.body.replace(/\{\{(\w+)\}\}/g, '<span class="var-tag">{{$1}}</span>');
    showTemplateModal({ ...t, body: bodyWithTags });
  }
}

async function deleteTemplate(id) {
  if (!confirm('Bu taslaÄŸÄ± silmek istediÄŸinize emin misiniz?')) return;
  try {
    await api('/api/templates/' + id, { method: 'DELETE' });
    toast('Taslak silindi');
    loadPageData();
  } catch (err) { toast(err.message, 'error'); }
}

// TEAM
function showTeamModal() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.id = 'teamModal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:360px">
      <div class="modal-header">
        <h3 class="modal-title">Yeni Ekip</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Ekip AdÄ±</label>
          <input type="text" id="teamName" class="input" placeholder="Ã–rn: Ä°stanbul" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveTeam()">Kaydet</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
}

async function saveTeam() {
  try {
    await api('/api/teams', { method: 'POST', body: JSON.stringify({ name: document.getElementById('teamName').value }) });
    toast('Ekip oluÅŸturuldu!');
    document.getElementById('teamModal').remove();
    loadPageData();
  } catch (err) { toast(err.message, 'error'); }
}

async function deleteTeam(id) {
  if (!confirm('Bu ekibi silmek istediÄŸinize emin misiniz?')) return;
  try {
    await api('/api/teams/' + id, { method: 'DELETE' });
    toast('Ekip silindi');
    loadPageData();
  } catch (err) { toast(err.message, 'error'); }
}

// USER
function showUserModal(edit = null) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.id = 'userModal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:450px">
      <div class="modal-header">
        <h3 class="modal-title">${edit ? 'KullanÄ±cÄ± DÃ¼zenle' : 'Yeni KullanÄ±cÄ±'}</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">KullanÄ±cÄ± AdÄ±</label>
            <input type="text" id="userName" class="input" value="${edit?.username || ''}" ${edit ? 'disabled' : 'required'}>
          </div>
          <div class="form-group">
            <label class="form-label">Ad Soyad</label>
            <input type="text" id="userFullName" class="input" value="${edit?.full_name || ''}" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Ekip</label>
            <select id="userTeam" class="input">
              <option value="">Ekip Yok</option>
              ${teams.map(t => `<option value="${t.id}" ${edit?.team_id === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Rol</label>
            <select id="userRole" class="input">
              <option value="sales" ${edit?.role === 'sales' ? 'selected' : ''}>SatÄ±ÅŸ Personeli</option>
              <option value="manager" ${edit?.role === 'manager' ? 'selected' : ''}>BÃ¶lge YÃ¶neticisi</option>
              <option value="admin" ${edit?.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Åžifre ${edit ? '(boÅŸ=deÄŸiÅŸmez)' : ''}</label>
          <input type="password" id="userPass" class="input" ${edit ? '' : 'required'}>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Ä°ptal</button>
        <button class="btn btn-primary" onclick="saveUser('${edit?.id || ''}')">${edit ? 'GÃ¼ncelle' : 'Kaydet'}</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
}

async function saveUser(id) {
  const data = {
    full_name: document.getElementById('userFullName').value,
    team_id: document.getElementById('userTeam').value || null,
    role: document.getElementById('userRole').value
  };
  if (!id) data.username = document.getElementById('userName').value;
  const pass = document.getElementById('userPass').value;
  if (pass) data.password = pass;
  
  try {
    await api(id ? '/api/users/' + id : '/api/users', { method: id ? 'PUT' : 'POST', body: JSON.stringify(data) });
    toast(id ? 'KullanÄ±cÄ± gÃ¼ncellendi!' : 'KullanÄ±cÄ± oluÅŸturuldu!');
    document.getElementById('userModal').remove();
    loadPageData();
  } catch (err) { toast(err.message, 'error'); }
}

async function editUser(id) {
  const users = await api('/api/users');
  const u = users.find(x => x.id === id);
  if (u) showUserModal(u);
}

async function deleteUser(id) {
  if (!confirm('Bu kullanÄ±cÄ±yÄ± silmek istediÄŸinize emin misiniz?')) return;
  try {
    await api('/api/users/' + id, { method: 'DELETE' });
    toast('KullanÄ±cÄ± silindi');
    loadPageData();
  } catch (err) { toast(err.message, 'error'); }
}

// SIGNATURE
async function saveSignature() {
  try {
    await api('/api/settings', { method: 'POST', body: JSON.stringify({ signature: document.getElementById('signatureArea').innerHTML }) });
    toast('Ä°mza kaydedildi!');
  } catch (err) { toast(err.message, 'error'); }
}

// INIT
(function() {
  const t = localStorage.getItem('token');
  const u = localStorage.getItem('user');
  if (t && u) { user = JSON.parse(u); page = 'dashboard'; }
  render();
})();
</script>
</body>
</html>
