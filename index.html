<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G360 CRM</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
.btn{padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;font-size:14px}
.btn-primary{background:linear-gradient(135deg,#0d9488,#0891b2);color:#fff}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(13,148,136,0.3)}
.btn-secondary{background:#1e293b;color:#94a3b8;border:1px solid #334155}
.btn-secondary:hover{background:#334155;color:#fff}
.btn-danger{background:#7f1d1d;color:#fca5a5}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-xs{padding:4px 8px;font-size:11px;border-radius:6px}
.input{width:100%;padding:12px 16px;border:1px solid #334155;border-radius:10px;font-size:14px;background:#1e293b;color:#e2e8f0}
.input:focus{outline:none;border-color:#0d9488;box-shadow:0 0 0 3px rgba(13,148,136,0.1)}
.input::placeholder{color:#64748b}
.card{background:#1e293b;border-radius:16px;border:1px solid #334155}
.badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}

.app{display:flex;min-height:100vh}
.sidebar{width:260px;background:#1e293b;border-right:1px solid #334155;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100}
.main{flex:1;margin-left:260px;min-height:100vh}
.content{padding:24px;max-width:1400px;margin:0 auto}

@media(max-width:900px){
  .sidebar{transform:translateX(-100%);transition:transform 0.3s}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0}
  .mobile-header{display:flex!important}
  .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99}
  .overlay.show{display:block}
  .content{padding:16px;padding-top:70px}
  .stats-grid{grid-template-columns:1fr 1fr!important}
  .form-row{grid-template-columns:1fr!important}
}

.sidebar-header{padding:20px;border-bottom:1px solid #334155}
.sidebar-logo{font-size:28px;font-weight:800;cursor:pointer}
.sidebar-logo span:nth-child(1){color:#fff}
.sidebar-logo span:nth-child(2){color:#22d3ee}
.sidebar-logo span:nth-child(3){color:#a855f7}
.sidebar-logo span:nth-child(4){color:#fb923c}
.sidebar-nav{flex:1;padding:12px;overflow-y:auto}
.nav-section{margin-bottom:20px}
.nav-title{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;padding:0 12px;margin-bottom:8px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#94a3b8;cursor:pointer;transition:all 0.2s;font-size:14px}
.nav-item:hover{background:#334155;color:#fff}
.nav-item.active{background:linear-gradient(135deg,rgba(13,148,136,0.2),rgba(8,145,178,0.2));color:#2dd4bf;font-weight:600}
.nav-item svg{width:20px;height:20px}
.sidebar-footer{padding:12px;border-top:1px solid #334155}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;background:#0f172a;border-radius:10px}
.user-avatar{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px}
.user-name{font-weight:600;font-size:13px;color:#fff}
.user-role{font-size:11px;color:#64748b}
.logout-btn{padding:6px;background:transparent;border:none;cursor:pointer;color:#64748b;border-radius:6px}
.logout-btn:hover{background:#7f1d1d;color:#fca5a5}

.mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:56px;background:#1e293b;border-bottom:1px solid #334155;padding:0 16px;align-items:center;justify-content:space-between;z-index:98}
.menu-btn{padding:8px;border:none;background:transparent;cursor:pointer;color:#94a3b8}

.page-header{margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.page-title{font-size:24px;font-weight:700;color:#fff}
.page-subtitle{color:#64748b;font-size:14px}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{padding:16px;display:flex;align-items:center;gap:12px}
.stat-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center}
.stat-value{font-size:24px;font-weight:700;color:#fff}
.stat-label{font-size:12px;color:#64748b}

.customer-filters{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.customer-filters .input{max-width:250px}
.customer-filters select.input{max-width:180px}

.customer-list{display:flex;flex-direction:column;gap:8px}
.customer-item{display:flex;align-items:center;padding:14px;background:#1e293b;border-radius:12px;border:1px solid #334155;gap:12px;transition:all 0.2s}
.customer-item:hover{border-color:#475569}
.customer-status-bar{width:5px;height:50px;border-radius:3px;flex-shrink:0;cursor:pointer;transition:all 0.2s}
.customer-status-bar:hover{transform:scaleX(1.5)}
.customer-info{flex:1;min-width:0}
.customer-name{font-weight:600;font-size:15px;color:#fff}
.customer-meta{font-size:12px;color:#64748b;margin-top:2px}
.customer-meta span{margin-right:12px}
.customer-price{text-align:right;min-width:90px}
.customer-price-value{font-weight:700;font-size:16px;color:#2dd4bf}
.customer-price-scenes{font-size:11px;color:#64748b}
.customer-actions{display:flex;gap:6px}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:200;padding:16px}
.modal-content{background:#1e293b;border-radius:16px;width:100%;max-width:600px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;border:1px solid #334155}
.modal-header{padding:16px 20px;border-bottom:1px solid #334155;display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:18px;font-weight:700;color:#fff}
.modal-close{padding:8px;border:none;background:#334155;border-radius:8px;cursor:pointer;color:#94a3b8;font-size:16px}
.modal-close:hover{background:#475569;color:#fff}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-footer{padding:16px 20px;border-top:1px solid #334155;display:flex;gap:12px;justify-content:flex-end}
.modal-lg{max-width:700px}

.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:6px}
.form-hint{font-size:12px;color:#64748b;margin-top:4px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.status-picker{display:flex;flex-wrap:wrap;gap:6px}
.status-btn{padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:2px solid transparent;background:#0f172a;color:#94a3b8;transition:all 0.2s}
.status-btn:hover{opacity:0.8}
.status-btn.active{color:#fff;border-color:currentColor}

.places-wrapper{position:relative}
.places-dropdown{position:absolute;top:100%;left:0;right:0;background:#0f172a;border:1px solid #334155;border-radius:10px;margin-top:4px;max-height:200px;overflow-y:auto;z-index:50;display:none}
.places-dropdown.show{display:block}
.places-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid #1e293b}
.places-item:hover{background:#1e293b}
.places-item:last-child{border-bottom:none}
.places-item-name{font-weight:500;color:#fff;font-size:14px}
.places-item-address{font-size:12px;color:#64748b;margin-top:2px}

.detail-section{margin-bottom:20px}
.detail-title{font-size:13px;font-weight:600;color:#64748b;margin-bottom:10px;text-transform:uppercase}
.detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155}
.detail-row:last-child{border-bottom:none}
.detail-label{color:#64748b;font-size:13px}
.detail-value{color:#fff;font-weight:500;font-size:13px}

.preview-box{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:20px;min-height:150px}
.preview-subject{font-size:15px;font-weight:600;color:#fff;padding-bottom:12px;margin-bottom:12px;border-bottom:1px solid #334155}

.templates-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}

table{width:100%;border-collapse:collapse}
th{text-align:left;padding:12px 16px;font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;border-bottom:1px solid #334155}
td{padding:14px 16px;border-bottom:1px solid #334155;font-size:14px}
tr:hover td{background:#243244}

.editor-container{border:1px solid #334155;border-radius:10px;overflow:hidden}
.editor-toolbar{padding:10px;background:#0f172a;border-bottom:1px solid #334155;display:flex;gap:6px}
.toolbar-btn{padding:6px 10px;border:1px solid #334155;background:#1e293b;border-radius:6px;cursor:pointer;font-size:12px;color:#94a3b8}
.toolbar-btn:hover{background:#334155;color:#fff}
.editor-area{min-height:120px;padding:12px;outline:none;font-size:14px;line-height:1.6;color:#e2e8f0;background:#1e293b}
.editor-area:empty:before{content:attr(data-placeholder);color:#64748b}

.var-tag{background:#713f12;color:#fde047;padding:2px 8px;border-radius:4px;font-weight:600;font-size:12px}
.var-input{background:#713f12;border:2px solid #854d0e;border-radius:8px;padding:10px 12px;font-weight:500;color:#fef3c7;font-size:14px;width:100%}
.var-input:focus{outline:none;border-color:#eab308}
.var-input::placeholder{color:#a16207}
.var-inputs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:8px}

.toast{position:fixed;top:16px;right:16px;padding:14px 20px;border-radius:10px;color:#fff;font-weight:500;z-index:300;animation:slideIn 0.3s;font-size:14px}
.toast-success{background:linear-gradient(135deg,#059669,#10b981)}
.toast-error{background:linear-gradient(135deg,#dc2626,#ef4444)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

.checkbox-wrapper{display:flex;align-items:center;gap:10px;cursor:pointer}
.checkbox-wrapper input{width:18px;height:18px;accent-color:#0d9488}
.checkbox-label{font-size:14px;color:#e2e8f0}

.kdv-calc{margin-top:8px;padding:12px;background:#0f172a;border-radius:8px;font-size:13px;display:none}
.kdv-row{display:flex;justify-content:space-between;padding:4px 0;color:#64748b}
.kdv-row.total{color:#2dd4bf;font-weight:600;margin-top:4px;padding-top:8px;border-top:1px solid #334155}

.email-list{display:flex;flex-direction:column}
.email-item{display:flex;align-items:center;padding:14px 0;border-bottom:1px solid #334155;cursor:pointer;gap:12px}
.email-item:hover{background:#243244;margin:0 -16px;padding-left:16px;padding-right:16px}
.email-avatar{width:40px;height:40px;background:#334155;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:600;color:#94a3b8;font-size:14px}
.email-content{flex:1;min-width:0}
.email-recipient{font-weight:600;font-size:14px;color:#fff}
.email-subject{font-size:13px;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.email-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.email-date{font-size:11px;color:#64748b}

.send-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
@media(max-width:900px){.send-grid{grid-template-columns:1fr}}

.status-menu{position:absolute;background:#0f172a;border:1px solid #334155;border-radius:10px;padding:6px;z-index:50;min-width:200px;display:none}
.status-menu.show{display:block}
.status-menu-item{padding:10px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px}
.status-menu-item:hover{background:#1e293b}
.status-dot{width:12px;height:12px;border-radius:3px}
</style>
</head>
<body>
<div id="app"></div>

<script>
// =====================================================
// STATE
// =====================================================
let user = null;
let page = 'login';
let sidebarOpen = false;

let customers = [];
let templates = [];
let teams = [];
let emails = [];
let categories = [];
let statuses = [];
let stats = {};

const API = '';

// =====================================================
// HELPERS
// =====================================================
function token() { return localStorage.getItem('token'); }

async function api(url, opts = {}) {
  opts.headers = { 'Content-Type': 'application/json' };
  if (token()) opts.headers.Authorization = 'Bearer ' + token();
  const res = await fetch(API + url, opts);
  const data = await res.json();
  if (res.status === 401) { localStorage.clear(); page = 'login'; render(); throw new Error('Oturum sonlandi'); }
  if (!res.ok) throw new Error(data.error || 'Hata');
  return data;
}

function toast(msg, type = 'success') {
  const t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function nav(p) { page = p; render(); }
function toggleSidebar() { sidebarOpen = !sidebarOpen; render(); }
function closeSidebar() { sidebarOpen = false; render(); }

function isAdmin() { return user?.role === 'admin'; }
function isManager() { return user?.role === 'manager'; }
function getRoleName(r) { return r === 'admin' ? 'Admin' : r === 'manager' ? 'B√∂lge Y√∂neticisi' : 'Satƒ±≈ü Personeli'; }
function getRoleColor(r) { return r === 'admin' ? 'background:#f59e0b' : r === 'manager' ? 'background:#8b5cf6' : 'background:#0d9488'; }

function formatDate(d) { return new Date(d).toLocaleString('tr-TR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }); }
function formatShortDate(d) {
  const date = new Date(d);
  const today = new Date();
  if (date.toDateString() === today.toDateString()) return date.toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit' });
  return date.toLocaleDateString('tr-TR', { day:'2-digit', month:'2-digit' });
}
function formatMoney(n) { return new Intl.NumberFormat('tr-TR').format(n || 0) + '‚Ç∫'; }

function logout() { localStorage.clear(); user = null; page = 'login'; render(); }

// =====================================================
// RENDER
// =====================================================
function render() {
  const app = document.getElementById('app');
  if (page === 'login') {
    app.innerHTML = loginPage();
    setupLogin();
  } else {
    app.innerHTML = `
      <div class="app">
        <div class="overlay ${sidebarOpen ? 'show' : ''}" onclick="closeSidebar()"></div>
        ${sidebar()}
        <div class="main">
          ${mobileHeader()}
          <div class="content">
            ${page === 'dashboard' ? dashboardPage() : ''}
            ${page === 'customers' ? customersPage() : ''}
            ${page === 'send' ? sendPage() : ''}
            ${page === 'emails' ? emailsPage() : ''}
            ${page === 'templates' ? templatesPage() : ''}
            ${page === 'teams' ? teamsPage() : ''}
            ${page === 'users' ? usersPage() : ''}
            ${page === 'settings' ? settingsPage() : ''}
          </div>
        </div>
      </div>
    `;
    loadPageData();
  }
}

// =====================================================
// LOGIN
// =====================================================
function loginPage() {
  return `
    <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px">
      <div class="card" style="width:100%;max-width:380px;padding:32px">
        <div style="text-align:center;margin-bottom:28px">
          <div style="font-size:36px;font-weight:800;margin-bottom:8px">
            <span style="color:#fff">G</span><span style="color:#22d3ee">3</span><span style="color:#a855f7">6</span><span style="color:#fb923c">0</span>
          </div>
          <p style="color:#64748b;font-size:14px">CRM & Mail Sistemi</p>
        </div>
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label">Kullanƒ±cƒ± Adƒ±</label>
            <input type="text" id="username" class="input" placeholder="Kullanƒ±cƒ± adƒ±" required>
          </div>
          <div class="form-group">
            <label class="form-label">≈ûifre</label>
            <input type="password" id="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>
          <button type="submit" class="btn btn-primary" style="width:100%;padding:12px">Giri≈ü Yap</button>
        </form>
      </div>
    </div>
  `;
}

function setupLogin() {
  document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    try {
      const res = await api('/api/auth/login', {
        method: 'POST',
        body: JSON.stringify({ username: document.getElementById('username').value, password: document.getElementById('password').value })
      });
      localStorage.setItem('token', res.token);
      localStorage.setItem('user', JSON.stringify(res.user));
      user = res.user;
      page = 'dashboard';
      render();
      toast('Ho≈ü geldiniz, ' + user.full_name);
    } catch (err) { toast(err.message, 'error'); }
  };
}

// =====================================================
// SIDEBAR
// =====================================================
function sidebar() {
  return `
    <aside class="sidebar ${sidebarOpen ? 'open' : ''}">
      <div class="sidebar-header">
        <div class="sidebar-logo" onclick="nav('dashboard');closeSidebar()">
          <span>G</span><span>3</span><span>6</span><span>0</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-item ${page === 'dashboard' ? 'active' : ''}" onclick="nav('dashboard');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span>Ana Sayfa</span>
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-title">M√ú≈ûTERƒ∞LER</div>
          <div class="nav-item ${page === 'customers' ? 'active' : ''}" onclick="nav('customers');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            <span>M√º≈üteriler</span>
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-title">E-POSTA</div>
          <div class="nav-item ${page === 'send' ? 'active' : ''}" onclick="nav('send');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
            <span>Mail G√∂nder</span>
          </div>
          <div class="nav-item ${page === 'emails' ? 'active' : ''}" onclick="nav('emails');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            <span>G√∂nderilen</span>
          </div>
        </div>
        ${isAdmin() ? `
        <div class="nav-section">
          <div class="nav-title">Y√ñNETƒ∞M</div>
          <div class="nav-item ${page === 'templates' ? 'active' : ''}" onclick="nav('templates');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span>Taslaklar</span>
          </div>
          <div class="nav-item ${page === 'teams' ? 'active' : ''}" onclick="nav('teams');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>Ekipler</span>
          </div>
          <div class="nav-item ${page === 'users' ? 'active' : ''}" onclick="nav('users');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span>Kullanƒ±cƒ±lar</span>
          </div>
          <div class="nav-item ${page === 'settings' ? 'active' : ''}" onclick="nav('settings');closeSidebar()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>Ayarlar</span>
          </div>
        </div>
        ` : ''}
      </nav>
      <div class="sidebar-footer">
        <div class="user-card">
          <div class="user-avatar" style="${getRoleColor(user?.role)}">${user?.full_name?.[0] || '?'}</div>
          <div style="flex:1;min-width:0">
            <div class="user-name">${user?.full_name || ''}</div>
            <div class="user-role">${getRoleName(user?.role)}</div>
          </div>
          <button class="logout-btn" onclick="logout()" title="√áƒ±kƒ±≈ü">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>
  `;
}

function mobileHeader() {
  return `
    <div class="mobile-header">
      <button class="menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
      <div style="font-size:20px;font-weight:800">
        <span style="color:#fff">G</span><span style="color:#22d3ee">3</span><span style="color:#a855f7">6</span><span style="color:#fb923c">0</span>
      </div>
      <div style="width:40px"></div>
    </div>
  `;
}

// =====================================================
// PAGES
// =====================================================
function dashboardPage() {
  return `
    <div class="page-header">
      <div>
        <p style="color:#64748b;font-size:14px">Ho≈ü geldin,</p>
        <h1 class="page-title">${user?.full_name || ''}</h1>
      </div>
    </div>
    <div id="statsGrid" class="stats-grid"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">
      <div class="card" style="padding:20px">
        <h2 style="font-size:16px;font-weight:600;margin-bottom:16px;color:#fff">Durum Daƒüƒ±lƒ±mƒ±</h2>
        <div id="statusBreakdown"></div>
      </div>
      <div class="card" style="padding:20px">
        <h2 style="font-size:16px;font-weight:600;margin-bottom:16px;color:#fff">Son M√º≈üteriler</h2>
        <div id="recentCustomers"></div>
      </div>
    </div>
  `;
}

function customersPage() {
  return `
    <div class="page-header">
      <div>
        <h1 class="page-title">M√º≈üteriler</h1>
        <p class="page-subtitle" id="customerCount"></p>
      </div>
      <button class="btn btn-primary" onclick="showCustomerModal()">+ Yeni M√º≈üteri</button>
    </div>
    <div class="customer-filters">
      <input type="text" class="input" placeholder="ƒ∞≈ületme ara..." id="searchInput" oninput="filterCustomers()">
      <select class="input" id="statusFilter" onchange="filterCustomers()"><option value="">T√ºm Durumlar</option></select>
      <select class="input" id="categoryFilter" onchange="filterCustomers()"><option value="">T√ºm Kategoriler</option></select>
    </div>
    <div id="customerList" class="customer-list"></div>
  `;
}

function sendPage() {
  return `
    <div class="page-header">
      <div>
        <h1 class="page-title">Mail G√∂nder</h1>
        <p class="page-subtitle">Taslak se√ß, deƒüi≈ükenleri doldur, g√∂nder</p>
      </div>
    </div>
    <div class="send-grid">
      <div class="card" style="padding:20px">
        <form id="sendForm">
          <div class="form-group">
            <label class="form-label">Mail Taslaƒüƒ±</label>
            <select id="templateSelect" class="input"><option value="">Se√ßin...</option></select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Alƒ±cƒ± E-posta *</label>
              <input type="email" id="toEmail" class="input" placeholder="ornek@firma.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Alƒ±cƒ± Adƒ±</label>
              <input type="text" id="toName" class="input" placeholder="Ahmet Bey">
            </div>
          </div>
          <div id="variableInputs"></div>
          <button type="submit" class="btn btn-primary" style="width:100%;padding:14px;margin-top:8px">‚úâÔ∏è Mail G√∂nder</button>
        </form>
      </div>
      <div class="card" style="padding:20px;position:sticky;top:80px">
        <h3 style="font-size:14px;font-weight:600;margin-bottom:12px;color:#64748b">üìß √ñnizleme</h3>
        <div id="sendPreview" class="preview-box"><p style="color:#64748b;text-align:center">Taslak se√ßin...</p></div>
      </div>
    </div>
  `;
}

function emailsPage() {
  return `
    <div class="page-header">
      <div>
        <h1 class="page-title">G√∂nderilen Mailler</h1>
        <p class="page-subtitle" id="emailCount"></p>
      </div>
    </div>
    <div class="card" style="padding:16px">
      <div id="emailList" class="email-list"></div>
    </div>
  `;
}

function templatesPage() {
  return `
    <div class="page-header">
      <div>
        <h1 class="page-title">Mail Taslaklarƒ±</h1>
      </div>
      <button class="btn btn-primary" onclick="showTemplateModal()">+ Yeni Taslak</button>
    </div>
    <div id="templatesList" class="templates-grid"></div>
  `;
}

function teamsPage() {
  return `
    <div class="page-header">
      <div>
        <h1 class="page-title">Ekipler</h1>
      </div>
      <button class="btn btn-primary" onclick="showTeamModal()">+ Yeni Ekip</button>
    </div>
    <div id="teamsList" class="templates-grid"></div>
  `;
}

function usersPage() {
  return `
    <div class="page-header">
      <div>
        <h1 class="page-title">Kullanƒ±cƒ±lar</h1>
      </div>
      <button class="btn btn-primary" onclick="showUserModal()">+ Yeni Kullanƒ±cƒ±</button>
    </div>
    <div class="card"><div id="usersTable"></div></div>
  `;
}

function settingsPage() {
  return `
    <div class="page-header">
      <div>
        <h1 class="page-title">Ayarlar</h1>
      </div>
    </div>
    <div class="card" style="padding:20px;max-width:700px">
      <h3 style="font-size:16px;font-weight:600;margin-bottom:12px;color:#fff">Mail ƒ∞mzasƒ±</h3>
      <div class="editor-container">
        <div class="editor-toolbar">
          <button type="button" class="toolbar-btn" onclick="document.execCommand('bold')"><strong>B</strong></button>
          <button type="button" class="toolbar-btn" onclick="document.execCommand('italic')"><em>I</em></button>
        </div>
        <div id="signatureArea" class="editor-area" contenteditable="true" data-placeholder="ƒ∞mza..."></div>
      </div>
      <button class="btn btn-primary" style="margin-top:12px" onclick="saveSignature()">ƒ∞mzayƒ± Kaydet</button>
    </div>
  `;
}

// =====================================================
// DATA LOADING
// =====================================================
async function loadPageData() {
  try {
    categories = await api('/api/categories');
    statuses = await api('/api/statuses');
    templates = await api('/api/templates');
    
    if (page === 'dashboard') {
      stats = await api('/api/stats');
      customers = await api('/api/customers');
      renderDashboard();
    }
    if (page === 'customers') {
      customers = await api('/api/customers');
      renderCustomers();
    }
    if (page === 'send') setupSendPage();
    if (page === 'emails') {
      emails = await api('/api/emails');
      renderEmails();
    }
    if (page === 'templates') renderTemplates();
    if (page === 'teams') {
      teams = await api('/api/teams');
      renderTeams();
    }
    if (page === 'users') {
      teams = await api('/api/teams');
      renderUsers();
    }
    if (page === 'settings') {
      const s = await api('/api/settings');
      document.getElementById('signatureArea').innerHTML = s.signature || '';
    }
  } catch (err) { console.error(err); }
}

// =====================================================
// RENDER FUNCTIONS
// =====================================================
function renderDashboard() {
  document.getElementById('statsGrid').innerHTML = `
    <div class="card stat-card">
      <div class="stat-icon" style="background:#064e3b"><svg width="22" height="22" fill="none" stroke="#6ee7b7" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
      <div><div class="stat-value">${formatMoney(stats.monthRevenue)}</div><div class="stat-label">Aylƒ±k Kazan√ß</div></div>
    </div>
    <div class="card stat-card">
      <div class="stat-icon" style="background:#1e3a5f"><svg width="22" height="22" fill="none" stroke="#7dd3fc" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"/></svg></div>
      <div><div class="stat-value">${stats.totalCustomers}</div><div class="stat-label">Toplam M√º≈üteri</div></div>
    </div>
    <div class="card stat-card">
      <div class="stat-icon" style="background:#064e3b"><svg width="22" height="22" fill="none" stroke="#6ee7b7" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg></div>
      <div><div class="stat-value" style="color:#6ee7b7">${stats.completedCount}</div><div class="stat-label">Tamamlanan</div></div>
    </div>
    <div class="card stat-card">
      <div class="stat-icon" style="background:#4c1d95"><svg width="22" height="22" fill="none" stroke="#c4b5fd" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></div>
      <div><div class="stat-value" style="color:#c4b5fd">${stats.totalEmails}</div><div class="stat-label">Mail</div></div>
    </div>
  `;
  
  let statusHtml = '';
  if (stats.byStatus) {
    stats.byStatus.forEach(s => {
      statusHtml += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:12px;height:12px;border-radius:3px;background:${s.color}"></div>
          <span style="font-size:13px">${s.name}</span>
        </div>
        <span style="font-weight:600;color:#fff">${s.count}</span>
      </div>`;
    });
  }
  document.getElementById('statusBreakdown').innerHTML = statusHtml || '<p style="color:#64748b">Veri yok</p>';
  
  let recentHtml = '';
  customers.slice(0, 5).forEach(c => {
    recentHtml += `<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #334155">
      <div style="width:4px;height:30px;border-radius:2px;background:${c.status_info?.color || '#64748b'}"></div>
      <div style="flex:1"><div style="font-weight:500;color:#fff;font-size:13px">${c.business_name}</div><div style="font-size:11px;color:#64748b">${c.city || ''}</div></div>
      <div style="font-weight:600;color:#2dd4bf;font-size:13px">${formatMoney(c.price)}</div>
    </div>`;
  });
  document.getElementById('recentCustomers').innerHTML = recentHtml || '<p style="color:#64748b">Hen√ºz m√º≈üteri yok</p>';
}

function renderCustomers() {
  document.getElementById('statusFilter').innerHTML = '<option value="">T√ºm Durumlar</option>' + statuses.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  document.getElementById('categoryFilter').innerHTML = '<option value="">T√ºm Kategoriler</option>' + categories.map(c => `<option value="${c.id}">${c.id} | ${c.name}</option>`).join('');
  filterCustomers();
}

function filterCustomers() {
  const search = document.getElementById('searchInput')?.value?.toLowerCase() || '';
  const status = document.getElementById('statusFilter')?.value || '';
  const category = document.getElementById('categoryFilter')?.value || '';
  
  let filtered = customers.filter(c => {
    const matchSearch = !search || c.business_name?.toLowerCase().includes(search);
    const matchStatus = !status || c.status === parseInt(status);
    const matchCategory = !category || c.category_id === parseInt(category);
    return matchSearch && matchStatus && matchCategory;
  });
  
  document.getElementById('customerCount').textContent = filtered.length + ' m√º≈üteri';
  
  let html = '';
  filtered.forEach(c => {
    html += `
      <div class="customer-item">
        <div class="customer-status-bar" style="background:${c.status_info?.color || '#64748b'}" onclick="showStatusMenu(event, '${c.id}')" title="Durum deƒüi≈ütir"></div>
        <div class="customer-info">
          <div class="customer-name">${c.business_name}</div>
          <div class="customer-meta">
            <span>${c.category?.name || ''}</span>
            <span>${c.city || ''} ${c.district ? '/ ' + c.district : ''}</span>
          </div>
        </div>
        <div class="customer-price">
          <div class="customer-price-value">${formatMoney(c.price)}</div>
          <div class="customer-price-scenes">${c.scene_count || 1} Sahne</div>
        </div>
        <div class="customer-actions">
          <button class="btn btn-primary btn-xs" onclick="sendMailToCustomer('${c.id}')" title="Mail G√∂nder">‚úâÔ∏è</button>
          <button class="btn btn-secondary btn-xs" onclick="editCustomer('${c.id}')" title="D√ºzenle">‚úèÔ∏è</button>
          <button class="btn btn-secondary btn-xs" onclick="showCustomerDetail('${c.id}')" title="Detaylar">üëÅÔ∏è</button>
        </div>
      </div>
    `;
  });
  
  document.getElementById('customerList').innerHTML = html || '<p style="text-align:center;color:#64748b;padding:40px">M√º≈üteri bulunamadƒ±</p>';
}

function renderEmails() {
  document.getElementById('emailCount').textContent = emails.length + ' mail';
  let html = '';
  emails.forEach(e => {
    html += `<div class="email-item" onclick="viewEmail('${e.id}')">
      <div class="email-avatar">${(e.recipient_name || e.recipient_email)[0].toUpperCase()}</div>
      <div class="email-content">
        <div class="email-recipient">${e.recipient_name || e.recipient_email}</div>
        <div class="email-subject">${e.subject}</div>
      </div>
      <div class="email-meta">
        <span class="badge" style="background:${e.status === 'sent' ? '#064e3b' : '#7f1d1d'};color:${e.status === 'sent' ? '#6ee7b7' : '#fca5a5'}">${e.status === 'sent' ? 'OK' : 'Hata'}</span>
        <span class="email-date">${formatShortDate(e.sent_at)}</span>
      </div>
    </div>`;
  });
  document.getElementById('emailList').innerHTML = html || '<p style="text-align:center;color:#64748b;padding:40px">Hen√ºz mail yok</p>';
}

function renderTemplates() {
  let html = '';
  templates.forEach(t => {
    html += `<div class="card" style="padding:16px">
      <h3 style="font-weight:600;font-size:15px;margin-bottom:6px;color:#fff">${t.name}</h3>
      <p style="font-size:12px;color:#64748b;margin-bottom:10px">${t.subject}</p>
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">
        ${(t.variables||[]).map(v => `<span class="var-tag">{{${v}}}</span>`).join('')}
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="editTemplate('${t.id}')">D√ºzenle</button>
        <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${t.id}')">Sil</button>
      </div>
    </div>`;
  });
  document.getElementById('templatesList').innerHTML = html || '<p style="color:#64748b">Taslak yok</p>';
}

function renderTeams() {
  let html = '';
  teams.forEach(t => {
    html += `<div class="card" style="padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:40px;height:40px;background:#8b5cf6;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${t.name[0]}</div>
          <h3 style="font-weight:600;font-size:15px;color:#fff">${t.name}</h3>
        </div>
        <button class="btn btn-danger btn-sm" onclick="deleteTeam('${t.id}')">Sil</button>
      </div>
    </div>`;
  });
  document.getElementById('teamsList').innerHTML = html || '<p style="color:#64748b">Ekip yok</p>';
}

async function renderUsers() {
  const users = await api('/api/users');
  let html = `<table><thead><tr><th>Kullanƒ±cƒ±</th><th>Ekip</th><th>Rol</th><th style="text-align:right">ƒ∞≈ülem</th></tr></thead><tbody>`;
  users.forEach(u => {
    html += `<tr>
      <td><div style="display:flex;align-items:center;gap:10px">
        <div style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:13px;${getRoleColor(u.role)}">${u.full_name[0]}</div>
        <div><div style="font-weight:500;color:#fff">${u.full_name}</div><div style="font-size:11px;color:#64748b">@${u.username}</div></div>
      </div></td>
      <td><span class="badge" style="background:#1e3a5f;color:#7dd3fc">${u.team_name || '-'}</span></td>
      <td><span class="badge" style="background:${u.role === 'admin' ? '#7c2d12' : u.role === 'manager' ? '#4c1d95' : '#064e3b'};color:${u.role === 'admin' ? '#fdba74' : u.role === 'manager' ? '#c4b5fd' : '#6ee7b7'}">${getRoleName(u.role)}</span></td>
      <td style="text-align:right">${u.role !== 'admin' ? `<button class="btn btn-secondary btn-sm" onclick="editUser('${u.id}')">D√ºzenle</button> <button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Sil</button>` : ''}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('usersTable').innerHTML = html;
}

// =====================================================
// CUSTOMER FUNCTIONS
// =====================================================
function showCustomerModal(edit = null) {
  const m = document.createElement('div');
  m.className = 'modal';
  m.id = 'customerModal';
  
  const categoryOpts = categories.map(c => `<option value="${c.id}" ${edit?.category_id === c.id ? 'selected' : ''}>${c.id} | ${c.name}</option>`).join('');
  
  m.innerHTML = `
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">${edit ? 'M√º≈üteri D√ºzenle' : 'Yeni M√º≈üteri'}</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">‚úï</button>
      </div>
      <div class="modal-body">
        ${edit ? `<div class="form-group"><label class="form-label">Durum</label><div class="status-picker" id="statusPicker"></div></div>` : ''}
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Kategori *</label>
            <select id="custCategory" class="input" required>${categoryOpts}</select>
          </div>
          <div class="form-group">
            <label class="form-label">ƒ∞≈ületme ƒ∞smi *</label>
            <div class="places-wrapper">
              <input type="text" id="custBusinessName" class="input" placeholder="ƒ∞≈ületme ismini yazƒ±n..." value="${edit?.business_name || ''}" required autocomplete="off">
              <div id="placesDropdown" class="places-dropdown"></div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Adres</label>
          <input type="text" id="custAddress" class="input" placeholder="Google Places'tan otomatik dolar" value="${edit?.address || ''}" readonly style="background:#0f172a">
          <input type="hidden" id="custPlaceId" value="${edit?.place_id || ''}">
          <input type="hidden" id="custCity" value="${edit?.city || ''}">
          <input type="hidden" id="custDistrict" value="${edit?.district || ''}">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Yetkili Ki≈üi</label>
            <input type="text" id="custContact" class="input" placeholder="Ahmet Bey" value="${edit?.contact_name || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Telefon</label>
            <input type="text" id="custPhone" class="input" placeholder="+90 5XX XXX XX XX" value="${edit?.phone || ''}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">E-Posta</label>
            <input type="email" id="custEmail" class="input" placeholder="ornek@firma.com" value="${edit?.email || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Vergi No</label>
            <input type="text" id="custTaxNumber" class="input" placeholder="Vergi numarasƒ±" value="${edit?.tax_number || ''}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Fiyat (‚Ç∫)</label>
            <input type="number" id="custPrice" class="input" placeholder="0" value="${edit?.price || ''}" step="0.01" oninput="calcKdv()">
          </div>
          <div class="form-group">
            <label class="form-label">Sahne Sayƒ±sƒ±</label>
            <input type="number" id="custSceneCount" class="input" placeholder="1" value="${edit?.scene_count || 1}" min="1">
          </div>
        </div>
        <div class="form-group">
          <label class="checkbox-wrapper">
            <input type="checkbox" id="custInvoiced" ${edit?.is_invoiced ? 'checked' : ''} onchange="calcKdv()">
            <span class="checkbox-label">KDV Dahil (Faturalƒ± ƒ∞≈ülem - %20)</span>
          </label>
          <div id="kdvCalc" class="kdv-calc">
            <div class="kdv-row"><span>KDV'siz:</span><span id="kdvWithout">0‚Ç∫</span></div>
            <div class="kdv-row"><span>KDV (%20):</span><span id="kdvAmount">0‚Ç∫</span></div>
            <div class="kdv-row total"><span>Toplam:</span><span id="kdvTotal">0‚Ç∫</span></div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notlar</label>
          <textarea id="custNotes" class="input" rows="3" placeholder="Notlar...">${edit?.notes || ''}</textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="saveCustomer('${edit?.id || ''}')">${edit ? 'G√ºncelle' : 'Kaydet'}</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(m);
  m.onclick = (e) => { if (e.target === m) m.remove(); };
  
  // Status picker for edit
  if (edit) {
    const picker = document.getElementById('statusPicker');
    picker.innerHTML = statuses.map(s => `<button type="button" class="status-btn ${edit.status === s.id ? 'active' : ''}" data-status="${s.id}" style="${edit.status === s.id ? 'background:' + s.color + ';color:#fff' : ''}">${s.name}</button>`).join('');
    picker.querySelectorAll('.status-btn').forEach(btn => {
      btn.onclick = () => {
        picker.querySelectorAll('.status-btn').forEach(b => { b.classList.remove('active'); b.style.background = '#0f172a'; b.style.color = '#94a3b8'; });
        btn.classList.add('active');
        const status = statuses.find(s => s.id === parseInt(btn.dataset.status));
        btn.style.background = status.color;
        btn.style.color = '#fff';
      };
    });
  }
  
  setupPlacesAutocomplete();
  calcKdv();
}

function calcKdv() {
  const price = parseFloat(document.getElementById('custPrice')?.value) || 0;
  const invoiced = document.getElementById('custInvoiced')?.checked;
  const calc = document.getElementById('kdvCalc');
  
  if (invoiced && price > 0) {
    calc.style.display = 'block';
    const without = price / 1.20;
    const vat = price - without;
    document.getElementById('kdvWithout').textContent = formatMoney(without);
    document.getElementById('kdvAmount').textContent = formatMoney(vat);
    document.getElementById('kdvTotal').textContent = formatMoney(price);
  } else {
    calc.style.display = 'none';
  }
}

let placesTimeout = null;
function setupPlacesAutocomplete() {
  const input = document.getElementById('custBusinessName');
  const dropdown = document.getElementById('placesDropdown');
  
  input.oninput = () => {
    clearTimeout(placesTimeout);
    const q = input.value.trim();
    if (q.length < 2) { dropdown.classList.remove('show'); return; }
    
    placesTimeout = setTimeout(async () => {
      try {
        const res = await api('/api/places/autocomplete?input=' + encodeURIComponent(q));
        if (res.predictions?.length > 0) {
          dropdown.innerHTML = res.predictions.map(p => `
            <div class="places-item" data-place-id="${p.place_id}">
              <div class="places-item-name">${p.structured_formatting?.main_text || p.description}</div>
              <div class="places-item-address">${p.structured_formatting?.secondary_text || ''}</div>
            </div>
          `).join('');
          dropdown.classList.add('show');
          
          dropdown.querySelectorAll('.places-item').forEach(item => {
            item.onclick = async () => {
              const placeId = item.dataset.placeId;
              const details = await api('/api/places/details?place_id=' + placeId);
              if (details.result) {
                document.getElementById('custBusinessName').value = details.result.name || '';
                document.getElementById('custAddress').value = details.result.formatted_address || '';
                document.getElementById('custPlaceId').value = placeId;
                document.getElementById('custCity').value = details.parsed?.city || '';
                document.getElementById('custDistrict').value = details.parsed?.district || '';
                if (details.result.formatted_phone_number) document.getElementById('custPhone').value = details.result.formatted_phone_number;
              }
              dropdown.classList.remove('show');
            };
          });
        } else { dropdown.classList.remove('show'); }
      } catch (err) { dropdown.classList.remove('show'); }
    }, 300);
  };
  
  document.addEventListener('click', (e) => { if (!e.target.closest('.places-wrapper')) dropdown.classList.remove('show'); });
}

async function saveCustomer(id) {
  const data = {
    category_id: document.getElementById('custCategory').value,
    business_name: document.getElementById('custBusinessName').value,
    place_id: document.getElementById('custPlaceId').value,
    address: document.getElementById('custAddress').value,
    city: document.getElementById('custCity').value,
    district: document.getElementById('custDistrict').value,
    contact_name: document.getElementById('custContact').value,
    phone: document.getElementById('custPhone').value,
    email: document.getElementById('custEmail').value,
    tax_number: document.getElementById('custTaxNumber').value,
    price: document.getElementById('custPrice').value || 0,
    is_invoiced: document.getElementById('custInvoiced').checked,
    scene_count: document.getElementById('custSceneCount').value || 1,
    notes: document.getElementById('custNotes').value
  };
  
  if (id) {
    const activeStatus = document.querySelector('.status-btn.active');
    if (activeStatus) data.status = activeStatus.dataset.status;
  }
  
  try {
    await api(id ? '/api/customers/' + id : '/api/customers', { method: id ? 'PUT' : 'POST', body: JSON.stringify(data) });
    toast(id ? 'G√ºncellendi!' : 'Olu≈üturuldu!');
    document.getElementById('customerModal').remove();
    loadPageData();
  } catch (err) { toast(err.message, 'error'); }
}

async function editCustomer(id) {
  const c = customers.find(x => x.id === id);
  if (c) showCustomerModal(c);
}

function showCustomerDetail(id) {
  const c = customers.find(x => x.id === id);
  if (!c) return;
  
  const m = document.createElement('div');
  m.className = 'modal';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">${c.business_name}</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="detail-section">
          <div class="detail-title">Durum</div>
          <div style="display:flex;align-items:center;gap:10px;padding:12px;background:#0f172a;border-radius:8px">
            <div style="width:12px;height:12px;border-radius:3px;background:${c.status_info?.color}"></div>
            <span style="font-weight:600;color:#fff">${c.status_info?.name}</span>
          </div>
        </div>
        <div class="detail-section">
          <div class="detail-title">ƒ∞≈ületme Bilgileri</div>
          <div class="detail-row"><span class="detail-label">Kategori</span><span class="detail-value">${c.category?.name || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">Yetkili</span><span class="detail-value">${c.contact_name || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">Telefon</span><span class="detail-value">${c.phone || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">E-Posta</span><span class="detail-value">${c.email || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">Vergi No</span><span class="detail-value">${c.tax_number || '-'}</span></div>
        </div>
        <div class="detail-section">
          <div class="detail-title">Lokasyon</div>
          <div class="detail-row"><span class="detail-label">ƒ∞l / ƒ∞l√ße</span><span class="detail-value">${c.city || '-'} ${c.district ? '/ ' + c.district : ''}</span></div>
          <div class="detail-row"><span class="detail-label">Adres</span><span class="detail-value" style="max-width:200px;white-space:normal">${c.address || '-'}</span></div>
        </div>
        <div class="detail-section">
          <div class="detail-title">Fiyat</div>
          ${c.is_invoiced ? `
            <div class="detail-row"><span class="detail-label">KDV'siz</span><span class="detail-value">${formatMoney(c.price_without_vat)}</span></div>
            <div class="detail-row"><span class="detail-label">KDV (%20)</span><span class="detail-value">${formatMoney(c.vat_amount)}</span></div>
            <div class="detail-row"><span class="detail-label">Toplam</span><span class="detail-value" style="color:#2dd4bf;font-size:16px">${formatMoney(c.price)}</span></div>
          ` : `<div class="detail-row"><span class="detail-label">Fiyat</span><span class="detail-value" style="color:#2dd4bf;font-size:16px">${formatMoney(c.price)}</span></div>`}
          <div class="detail-row"><span class="detail-label">Sahne</span><span class="detail-value">${c.scene_count || 1}</span></div>
        </div>
        ${c.notes ? `<div class="detail-section"><div class="detail-title">Notlar</div><p style="color:#e2e8f0;font-size:14px">${c.notes}</p></div>` : ''}
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteCustomer('${c.id}')">Sil</button>
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Kapat</button>
      </div>
    </div>
  `;
  document.body.appendChild(m);
  m.onclick = (e) => { if (e.target === m) m.remove(); };
}

async function deleteCustomer(id) {
  if (!confirm('Silmek istediƒüinize emin misiniz?')) return;
  try {
    await api('/api/customers/' + id, { method: 'DELETE' });
    toast('Silindi');
    document.querySelector('.modal')?.remove();
    loadPageData();
  } catch (err) { toast(err.message, 'error'); }
}

// Status menu
function showStatusMenu(e, id) {
  e.stopPropagation();
  document.querySelectorAll('.status-menu').forEach(m => m.remove());
  
  const c = customers.find(x => x.id === id);
  if (!c) return;
  
  const menu = document.createElement('div');
  menu.className = 'status-menu show';
  menu.style.left = e.pageX + 'px';
  menu.style.top = e.pageY + 'px';
  menu.style.position = 'absolute';
  
  menu.innerHTML = statuses.map(s => `
    <div class="status-menu-item" onclick="changeStatus('${id}', ${s.id})">
      <div class="status-dot" style="background:${s.color}"></div>
      <span>${s.name}</span>
    </div>
  `).join('');
  
  document.body.appendChild(menu);
  setTimeout(() => document.addEventListener('click', () => menu.remove(), { once: true }), 10);
}

async function changeStatus(id, status) {
  try {
    await api('/api/customers/' + id + '/status', { method: 'PATCH', body: JSON.stringify({ status }) });
    toast('Durum g√ºncellendi!');
    loadPageData();
  } catch (err) { toast(err.message, 'error'); }
}

// =====================================================
// MAIL FUNCTIONS
// =====================================================
let currentVars = {};
let currentCustomerId = null;

function sendMailToCustomer(id) {
  const c = customers.find(x => x.id === id);
  if (!c) return;
  
  currentCustomerId = id;
  page = 'send';
  render();
  
  setTimeout(() => {
    if (c.email) document.getElementById('toEmail').value = c.email;
    if (c.contact_name) document.getElementById('toName').value = c.contact_name;
    window.mailCustomer = c;
    toast('M√º≈üteri bilgileri y√ºklendi');
  }, 100);
}

function setupSendPage() {
  const select = document.getElementById('templateSelect');
  select.innerHTML = '<option value="">Se√ßin...</option>' + templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
  select.onchange = onTemplateChange;
  document.getElementById('sendForm').onsubmit = handleSend;
}

function onTemplateChange() {
  const tid = document.getElementById('templateSelect').value;
  const t = templates.find(x => x.id === tid);
  currentVars = {};
  
  if (!t) {
    document.getElementById('variableInputs').innerHTML = '';
    document.getElementById('sendPreview').innerHTML = '<p style="color:#64748b;text-align:center">Taslak se√ßin...</p>';
    return;
  }
  
  if (t.variables?.length > 0) {
    let html = '<div class="form-group"><label class="form-label">Deƒüi≈ükenler</label><div class="var-inputs">';
    t.variables.forEach(v => {
      let def = '';
      if (window.mailCustomer) {
        const c = window.mailCustomer;
        if (v === 'isim' || v === 'ad') def = c.contact_name || '';
        if (v === 'firma' || v === 'i≈ületme') def = c.business_name || '';
        if (v === 'fiyat' || v === 'tutar') def = c.price || '';
      }
      html += `<input type="text" class="var-input" id="var_${v}" placeholder="${v}" value="${def}" oninput="updateVar('${v}', this.value)">`;
      if (def) currentVars[v] = def;
    });
    html += '</div></div>';
    document.getElementById('variableInputs').innerHTML = html;
  } else {
    document.getElementById('variableInputs').innerHTML = '';
  }
  
  updatePreview();
}

function updateVar(name, value) {
  currentVars[name] = value;
  updatePreview();
}

function updatePreview() {
  const tid = document.getElementById('templateSelect').value;
  const t = templates.find(x => x.id === tid);
  if (!t) return;
  
  let subject = t.subject;
  let body = t.body;
  
  Object.keys(currentVars).forEach(k => {
    const re = new RegExp('\\{\\{' + k + '\\}\\}', 'g');
    const val = currentVars[k] || `<span class="var-tag">{{${k}}}</span>`;
    subject = subject.replace(re, val);
    body = body.replace(re, val);
  });
  
  subject = subject.replace(/\{\{(\w+)\}\}/g, '<span class="var-tag">{{$1}}</span>');
  body = body.replace(/\{\{(\w+)\}\}/g, '<span class="var-tag">{{$1}}</span>');
  
  document.getElementById('sendPreview').innerHTML = `<div class="preview-subject">${subject}</div><div style="font-size:14px;line-height:1.6">${body}</div>`;
}

async function handleSend(e) {
  e.preventDefault();
  
  const tid = document.getElementById('templateSelect').value;
  if (!tid) { toast('Taslak se√ßin', 'error'); return; }
  
  try {
    await api('/api/emails/send', {
      method: 'POST',
      body: JSON.stringify({
        template_id: tid,
        recipient_email: document.getElementById('toEmail').value,
        recipient_name: document.getElementById('toName').value,
        variables: currentVars,
        customer_id: currentCustomerId
      })
    });
    toast('Mail g√∂nderildi!');
    window.mailCustomer = null;
    currentCustomerId = null;
    document.getElementById('sendForm').reset();
    document.getElementById('variableInputs').innerHTML = '';
    document.getElementById('sendPreview').innerHTML = '<p style="color:#64748b;text-align:center">Taslak se√ßin...</p>';
  } catch (err) { toast(err.message, 'error'); }
}

async function viewEmail(id) {
  const e = await api('/api/emails/' + id);
  const m = document.createElement('div');
  m.className = 'modal';
  m.innerHTML = `
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">Mail Detayƒ±</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">‚úï</button>
      </div>
      <div style="padding:16px 20px;background:#0f172a;border-bottom:1px solid #334155">
        <div style="font-size:16px;font-weight:600;margin-bottom:8px;color:#fff">${e.subject}</div>
        <div style="font-size:13px;color:#64748b"><strong>Alƒ±cƒ±:</strong> ${e.recipient_name || ''} &lt;${e.recipient_email}&gt; | <strong>Tarih:</strong> ${formatDate(e.sent_at)}</div>
      </div>
      <div class="modal-body"><div style="font-size:14px;line-height:1.6">${e.body}</div></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Kapat</button></div>
    </div>
  `;
  document.body.appendChild(m);
  m.onclick = (ev) => { if (ev.target === m) m.remove(); };
}

// =====================================================
// TEMPLATE FUNCTIONS
// =====================================================
function showTemplateModal(edit = null) {
  const m = document.createElement('div');
  m.className = 'modal';
  m.id = 'templateModal';
  m.innerHTML = `
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">${edit ? 'Taslak D√ºzenle' : 'Yeni Taslak'}</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Taslak Adƒ±</label>
          <input type="text" id="tplName" class="input" value="${edit?.name || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Konu</label>
          <input type="text" id="tplSubject" class="input" placeholder="{{deƒüi≈üken}} kullanabilirsiniz" value="${edit?.subject || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">ƒ∞√ßerik</label>
          <div class="editor-container">
            <div class="editor-toolbar">
              <button type="button" class="toolbar-btn" onclick="document.execCommand('bold')"><strong>B</strong></button>
              <button type="button" class="toolbar-btn" onclick="document.execCommand('italic')"><em>I</em></button>
              <button type="button" class="toolbar-btn" onclick="insertVar2()">{{x}}</button>
            </div>
            <div id="tplBody" class="editor-area" contenteditable="true" data-placeholder="ƒ∞√ßerik...">${edit?.body || ''}</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">ƒ∞ptal</button>
        <button class="btn btn-primary" onclick="saveTemplate('${edit?.id || ''}')">${edit ? 'G√ºncelle' : 'Kaydet'}</button>
      </div>
    </div>
  `;
  document.body.appendChild(m);
  m.onclick = (e) => { if (e.target === m) m.remove(); };
}

function insertVar2() {
  const name = prompt('Deƒüi≈üken adƒ±:');
  if (name) document.execCommand('insertText', false, '{{' + name + '}}');
}

async function saveTemplate(id) {
  const data = { name: document.getElementById('tplName').value, subject: document.getElementById('tplSubject').value, body: document.getElementById('tplBody').innerHTML };
  try {
    await api(id ? '/api/templates/' + id : '/api/templates', { method: id ? 'PUT' : 'POST', body: JSON.stringify(data) });
    toast(id ? 'G√ºncellendi!' : 'Olu≈üturuldu!');
    document.getElementById('templateModal').remove();
    loadPageData();
  } catch (err) { toast(err.message, 'error'); }
}

async function editTemplate(id) {
  const t = templates.find(x => x.id === id);
  if (t) showTemplateModal(t);
}

async function deleteTemplate(id) {
  if (!confirm('Silmek istediƒüinize emin misiniz?')) return;
  try { await api('/api/templates/' + id, { method: 'DELETE' }); toast('Silindi'); loadPageData(); } catch (err) { toast(err.message, 'error'); }
}

// =====================================================
// TEAM FUNCTIONS
// =====================================================
function showTeamModal() {
  const m = document.createElement('div');
  m.className = 'modal';
  m.innerHTML = `
    <div class="modal-content" style="max-width:360px">
      <div class="modal-header"><h3 class="modal-title">Yeni Ekip</h3><button class="modal-close" onclick="this.closest('.modal').remove()">‚úï</button></div>
      <div class="modal-body"><div class="form-group"><label class="form-label">Ekip Adƒ±</label><input type="text" id="teamName" class="input" required></div></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest('.modal').remove()">ƒ∞ptal</button><button class="btn btn-primary" onclick="saveTeam()">Kaydet</button></div>
    </div>
  `;
  document.body.appendChild(m);
}

async function saveTeam() {
  try { await api('/api/teams', { method: 'POST', body: JSON.stringify({ name: document.getElementById('teamName').value }) }); toast('Olu≈üturuldu!'); document.querySelector('.modal').remove(); loadPageData(); } catch (err) { toast(err.message, 'error'); }
}

async function deleteTeam(id) {
  if (!confirm('Silmek istediƒüinize emin misiniz?')) return;
  try { await api('/api/teams/' + id, { method: 'DELETE' }); toast('Silindi'); loadPageData(); } catch (err) { toast(err.message, 'error'); }
}

// =====================================================
// USER FUNCTIONS
// =====================================================
function showUserModal(edit = null) {
  const teamOpts = teams.map(t => `<option value="${t.id}" ${edit?.team_id === t.id ? 'selected' : ''}>${t.name}</option>`).join('');
  const m = document.createElement('div');
  m.className = 'modal';
  m.innerHTML = `
    <div class="modal-content" style="max-width:450px">
      <div class="modal-header"><h3 class="modal-title">${edit ? 'D√ºzenle' : 'Yeni Kullanƒ±cƒ±'}</h3><button class="modal-close" onclick="this.closest('.modal').remove()">‚úï</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label class="form-label">Kullanƒ±cƒ± Adƒ±</label><input type="text" id="userName" class="input" value="${edit?.username || ''}" ${edit ? 'disabled' : 'required'}></div>
          <div class="form-group"><label class="form-label">Ad Soyad</label><input type="text" id="userFullName" class="input" value="${edit?.full_name || ''}" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Ekip</label><select id="userTeam" class="input"><option value="">-</option>${teamOpts}</select></div>
          <div class="form-group"><label class="form-label">Rol</label><select id="userRole" class="input">
            <option value="sales" ${edit?.role === 'sales' ? 'selected' : ''}>Satƒ±≈ü Personeli</option>
            <option value="manager" ${edit?.role === 'manager' ? 'selected' : ''}>B√∂lge Y√∂neticisi</option>
            <option value="admin" ${edit?.role === 'admin' ? 'selected' : ''}>Admin</option>
          </select></div>
        </div>
        <div class="form-group"><label class="form-label">≈ûifre ${edit ? '(bo≈ü=deƒüi≈ümez)' : ''}</label><input type="password" id="userPass" class="input" ${edit ? '' : 'required'}></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest('.modal').remove()">ƒ∞ptal</button><button class="btn btn-primary" onclick="saveUser('${edit?.id || ''}')">${edit ? 'G√ºncelle' : 'Kaydet'}</button></div>
    </div>
  `;
  document.body.appendChild(m);
}

async function saveUser(id) {
  const data = { full_name: document.getElementById('userFullName').value, team_id: document.getElementById('userTeam').value || null, role: document.getElementById('userRole').value };
  if (!id) data.username = document.getElementById('userName').value;
  const pass = document.getElementById('userPass').value;
  if (pass) data.password = pass;
  try { await api(id ? '/api/users/' + id : '/api/users', { method: id ? 'PUT' : 'POST', body: JSON.stringify(data) }); toast(id ? 'G√ºncellendi!' : 'Olu≈üturuldu!'); document.querySelector('.modal').remove(); loadPageData(); } catch (err) { toast(err.message, 'error'); }
}

async function editUser(id) {
  const users = await api('/api/users');
  const u = users.find(x => x.id === id);
  if (u) showUserModal(u);
}

async function deleteUser(id) {
  if (!confirm('Silmek istediƒüinize emin misiniz?')) return;
  try { await api('/api/users/' + id, { method: 'DELETE' }); toast('Silindi'); loadPageData(); } catch (err) { toast(err.message, 'error'); }
}

// =====================================================
// SETTINGS
// =====================================================
async function saveSignature() {
  try { await api('/api/settings', { method: 'POST', body: JSON.stringify({ signature: document.getElementById('signatureArea').innerHTML }) }); toast('Kaydedildi!'); } catch (err) { toast(err.message, 'error'); }
}

// =====================================================
// INIT
// =====================================================
(function() {
  const t = localStorage.getItem('token');
  const u = localStorage.getItem('user');
  if (t && u) { user = JSON.parse(u); page = 'dashboard'; }
  render();
})();
</script>
</body>
</html>
