<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G360 CRM</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¯</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg-primary:#0a0f1a;--bg-secondary:#111827;--bg-tertiary:#1f2937;--bg-hover:#374151;--border:#374151;--border-light:#4b5563;--text-primary:#f9fafb;--text-secondary:#9ca3af;--text-muted:#6b7280;--accent-cyan:#06b6d4;--accent-purple:#a855f7;--accent-orange:#f97316;--accent-teal:#14b8a6;--accent-green:#22c55e;--accent-red:#ef4444;--accent-yellow:#eab308;--accent-blue:#3b82f6;--gradient-primary:linear-gradient(135deg,#14b8a6 0%,#06b6d4 100%);--shadow-sm:0 1px 2px rgba(0,0,0,0.3);--shadow-md:0 4px 6px rgba(0,0,0,0.4);--shadow-lg:0 10px 15px rgba(0,0,0,0.5);--radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:20px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.5}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 20px;border-radius:var(--radius-md);font-weight:600;font-size:14px;cursor:pointer;border:none;transition:all .2s ease;white-space:nowrap}
.btn-primary{background:var(--gradient-primary);color:white;box-shadow:0 2px 8px rgba(20,184,166,0.3)}.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(20,184,166,0.4)}
.btn-secondary{background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border)}.btn-secondary:hover{background:var(--bg-hover);color:var(--text-primary)}
.btn-danger{background:rgba(239,68,68,0.15);color:#fca5a5;border:1px solid rgba(239,68,68,0.3)}.btn-danger:hover{background:rgba(239,68,68,0.25)}
.btn-ghost{background:transparent;color:var(--text-secondary);padding:8px 12px}.btn-ghost:hover{background:var(--bg-tertiary);color:var(--text-primary)}
.btn-sm{padding:6px 14px;font-size:13px}.btn-xs{padding:5px 10px;font-size:12px;border-radius:var(--radius-sm)}.btn-icon{padding:8px;width:36px;height:36px}
.input{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:14px;background:var(--bg-secondary);color:var(--text-primary);transition:all .2s ease;font-family:inherit}
.input:focus{outline:none;border-color:var(--accent-teal);box-shadow:0 0 0 3px rgba(20,184,166,0.15)}.input::placeholder{color:var(--text-muted)}.input:disabled{opacity:0.6;cursor:not-allowed}
textarea.input{resize:vertical;min-height:80px}select.input{cursor:pointer}
.card{background:var(--bg-secondary);border-radius:var(--radius-lg);border:1px solid var(--border)}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:0.02em}
.app{display:flex;min-height:100vh}
.sidebar{width:260px;background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform .3s ease}
.sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
.sidebar-logo{font-size:32px;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:2px;letter-spacing:-1px}.sidebar-logo span:nth-child(1){color:#fff}.sidebar-logo span:nth-child(2){color:var(--accent-cyan)}.sidebar-logo span:nth-child(3){color:var(--accent-purple)}.sidebar-logo span:nth-child(4){color:var(--accent-orange)}
.sidebar-nav{flex:1;padding:16px 12px;overflow-y:auto}
.nav-section{margin-bottom:24px}.nav-title{font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;padding:0 12px;margin-bottom:8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:11px 12px;border-radius:var(--radius-md);color:var(--text-secondary);cursor:pointer;transition:all .2s ease;font-size:14px;font-weight:500;margin-bottom:2px}
.nav-item:hover{background:var(--bg-tertiary);color:var(--text-primary)}.nav-item.active{background:rgba(20,184,166,0.15);color:var(--accent-teal)}.nav-item svg{width:20px;height:20px;flex-shrink:0}
.nav-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:var(--accent-cyan);font-size:13px;font-weight:500;text-decoration:none;border-radius:var(--radius-sm);transition:all .2s}.nav-link:hover{background:var(--bg-tertiary)}
.sidebar-footer{padding:16px;border-top:1px solid var(--border)}
.user-card{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-primary);border-radius:var(--radius-md)}
.user-avatar{width:40px;height:40px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:15px}
.user-info{flex:1;min-width:0}.user-name{font-weight:600;font-size:14px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.user-role{font-size:12px;color:var(--text-muted)}
.logout-btn{padding:8px;background:transparent;border:none;cursor:pointer;color:var(--text-muted);border-radius:var(--radius-sm);transition:all .2s}.logout-btn:hover{background:rgba(239,68,68,0.15);color:var(--accent-red)}
.main{flex:1;margin-left:260px;min-height:100vh;background:var(--bg-primary)}
.content{padding:24px;max-width:1400px;margin:0 auto}
.mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:60px;background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:0 16px;align-items:center;justify-content:space-between;z-index:99}
.menu-btn{padding:8px;border:none;background:transparent;cursor:pointer;color:var(--text-secondary);border-radius:var(--radius-sm)}.menu-btn:hover{background:var(--bg-tertiary)}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99;backdrop-filter:blur(4px)}.overlay.show{display:block}
@media(max-width:900px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.mobile-header{display:flex!important}.content{padding:16px;padding-top:76px}.stats-grid{grid-template-columns:1fr 1fr!important}.form-row{grid-template-columns:1fr!important}.dashboard-grid{grid-template-columns:1fr!important}.quick-actions{flex-direction:column}}
.page-header{margin-bottom:24px;display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
.page-title{font-size:28px;font-weight:800;color:var(--text-primary);letter-spacing:-0.5px}.page-subtitle{color:var(--text-muted);font-size:14px;margin-top:4px}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat-card{padding:20px;display:flex;align-items:flex-start;gap:16px}
.stat-icon{width:48px;height:48px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.stat-content{flex:1}.stat-value{font-size:28px;font-weight:800;color:var(--text-primary);line-height:1}.stat-label{font-size:13px;color:var(--text-muted);margin-top:4px}.stat-change{font-size:12px;margin-top:8px;display:flex;align-items:center;gap:4px}.stat-change.positive{color:var(--accent-green)}
.dashboard-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.quick-actions{display:flex;gap:12px;margin-bottom:24px}
.quick-action-btn{flex:1;padding:20px;display:flex;align-items:center;gap:16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);cursor:pointer;transition:all .2s}
.quick-action-btn:hover{border-color:var(--accent-teal);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.quick-action-icon{width:52px;height:52px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center}
.quick-action-text h4{font-size:16px;font-weight:700;color:var(--text-primary)}.quick-action-text p{font-size:13px;color:var(--text-muted);margin-top:2px}
.customer-filters{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}.customer-filters .input{max-width:260px}.customer-filters select.input{max-width:200px}
.customer-list{display:flex;flex-direction:column;gap:8px}
.customer-item{display:flex;align-items:center;padding:16px;background:var(--bg-secondary);border-radius:var(--radius-lg);border:1px solid var(--border);gap:16px;transition:all .2s}
.customer-item:hover{border-color:var(--border-light);box-shadow:var(--shadow-sm)}
.customer-status-bar{width:5px;height:56px;border-radius:3px;flex-shrink:0;cursor:pointer;transition:all .2s}.customer-status-bar:hover{transform:scaleX(1.8)}
.customer-info{flex:1;min-width:0}.customer-name{font-weight:600;font-size:15px;color:var(--text-primary);display:flex;align-items:center;gap:8px}
.customer-meta{font-size:13px;color:var(--text-muted);margin-top:4px;display:flex;flex-wrap:wrap;gap:4px 16px}
.customer-details{display:flex;align-items:center;gap:24px;flex-shrink:0}
.customer-price{text-align:right;min-width:100px}.customer-price-value{font-weight:700;font-size:17px;color:var(--accent-teal)}.customer-price-scenes{font-size:12px;color:var(--text-muted)}
.customer-user{display:flex;align-items:center;gap:8px;min-width:140px}
.customer-user-avatar{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:white;background:var(--accent-purple)}
.customer-user-info{font-size:12px}.customer-user-name{color:var(--text-secondary);font-weight:500}.customer-user-date{color:var(--text-muted)}
.customer-actions{display:flex;gap:6px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:200;padding:16px;backdrop-filter:blur(4px);animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-content{background:var(--bg-secondary);border-radius:var(--radius-xl);width:100%;max-width:560px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;border:1px solid var(--border);box-shadow:var(--shadow-lg);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-lg{max-width:680px}.modal-xl{max-width:800px}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:18px;font-weight:700;color:var(--text-primary)}
.modal-close{width:32px;height:32px;border:none;background:var(--bg-tertiary);border-radius:var(--radius-sm);cursor:pointer;color:var(--text-muted);font-size:18px;display:flex;align-items:center;justify-content:center;transition:all .2s}.modal-close:hover{background:var(--bg-hover);color:var(--text-primary)}
.modal-body{padding:24px;overflow-y:auto;flex:1}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}
.form-group{margin-bottom:20px}.form-label{display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:8px}.form-hint{font-size:12px;color:var(--text-muted);margin-top:6px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.status-picker{display:flex;flex-wrap:wrap;gap:8px}
.status-btn{padding:10px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;border:2px solid transparent;background:var(--bg-primary);color:var(--text-muted);transition:all .2s}.status-btn:hover{opacity:0.85}.status-btn.active{color:white}
.places-wrapper{position:relative}
.places-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-md);margin-top:4px;max-height:240px;overflow-y:auto;z-index:50;display:none;box-shadow:var(--shadow-lg)}.places-dropdown.show{display:block}
.places-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s}.places-item:hover{background:var(--bg-secondary)}.places-item:last-child{border-bottom:none}
.places-item-name{font-weight:500;color:var(--text-primary);font-size:14px}.places-item-address{font-size:12px;color:var(--text-muted);margin-top:2px}
.kdv-calc{margin-top:12px;padding:16px;background:var(--bg-primary);border-radius:var(--radius-md);border:1px solid var(--border);display:none}
.kdv-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;color:var(--text-muted)}.kdv-row.total{color:var(--accent-teal);font-weight:700;margin-top:8px;padding-top:12px;border-top:1px solid var(--border)}
.checkbox-wrapper{display:flex;align-items:center;gap:12px;cursor:pointer}.checkbox-wrapper input{width:20px;height:20px;accent-color:var(--accent-teal);cursor:pointer}.checkbox-label{font-size:14px;color:var(--text-primary)}
.detail-section{margin-bottom:24px}.detail-title{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px}
.detail-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}.detail-row:last-child{border-bottom:none}.detail-label{color:var(--text-muted);font-size:13px}.detail-value{color:var(--text-primary);font-weight:500;font-size:14px;text-align:right;max-width:60%}
.status-menu{position:absolute;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-md);padding:8px;z-index:50;min-width:220px;box-shadow:var(--shadow-lg);display:none}.status-menu.show{display:block}
.status-menu-item{padding:10px 12px;border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;gap:12px;font-size:13px;font-weight:500;color:var(--text-secondary);transition:all .15s}.status-menu-item:hover{background:var(--bg-secondary);color:var(--text-primary)}
.status-dot{width:12px;height:12px;border-radius:4px;flex-shrink:0}
.email-list{display:flex;flex-direction:column}
.email-item{display:flex;align-items:center;padding:16px;border-bottom:1px solid var(--border);cursor:pointer;gap:16px;transition:background .15s}.email-item:hover{background:var(--bg-tertiary)}.email-item:last-child{border-bottom:none}
.email-avatar{width:44px;height:44px;background:var(--bg-tertiary);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--text-muted);font-size:16px;flex-shrink:0}
.email-content{flex:1;min-width:0}.email-recipient{font-weight:600;font-size:14px;color:var(--text-primary)}.email-subject{font-size:13px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.email-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0}.email-date{font-size:12px;color:var(--text-muted)}
.send-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}@media(max-width:900px){.send-grid{grid-template-columns:1fr}}
.preview-box{background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-md);padding:24px;min-height:200px}
.preview-subject{font-size:16px;font-weight:600;color:var(--text-primary);padding-bottom:16px;margin-bottom:16px;border-bottom:1px solid var(--border)}
.var-tag{background:rgba(234,179,8,0.2);color:#fde047;padding:2px 8px;border-radius:4px;font-weight:600;font-size:12px}
.var-input{background:rgba(234,179,8,0.1);border:2px solid rgba(234,179,8,0.3);border-radius:var(--radius-sm);padding:10px 14px;font-weight:500;color:#fef3c7;font-size:14px;width:100%;transition:all .2s}
.var-input:focus{outline:none;border-color:var(--accent-yellow);box-shadow:0 0 0 3px rgba(234,179,8,0.15)}.var-input::placeholder{color:rgba(234,179,8,0.5)}
.var-inputs{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:12px}
.templates-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.editor-container{border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden}
.editor-toolbar{padding:10px 12px;background:var(--bg-primary);border-bottom:1px solid var(--border);display:flex;gap:8px}
.toolbar-btn{padding:6px 12px;border:1px solid var(--border);background:var(--bg-secondary);border-radius:var(--radius-sm);cursor:pointer;font-size:13px;color:var(--text-secondary);transition:all .15s}.toolbar-btn:hover{background:var(--bg-tertiary);color:var(--text-primary)}
.editor-area{min-height:150px;padding:16px;outline:none;font-size:14px;line-height:1.7;color:var(--text-primary);background:var(--bg-secondary)}.editor-area:empty:before{content:attr(data-placeholder);color:var(--text-muted)}
.table-container{overflow-x:auto}table{width:100%;border-collapse:collapse}
th{text-align:left;padding:14px 16px;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);background:var(--bg-primary)}
td{padding:16px;border-bottom:1px solid var(--border);font-size:14px;color:var(--text-secondary)}tr:hover td{background:var(--bg-tertiary)}
.toast{position:fixed;top:20px;right:20px;padding:16px 24px;border-radius:var(--radius-md);color:white;font-weight:600;z-index:300;animation:slideInRight .3s ease;font-size:14px;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.toast-success{background:linear-gradient(135deg,#059669,#10b981)}.toast-error{background:linear-gradient(135deg,#dc2626,#ef4444)}.toast-info{background:linear-gradient(135deg,#2563eb,#3b82f6)}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}.empty-state svg{width:64px;height:64px;margin-bottom:16px;opacity:0.5}.empty-state h3{font-size:18px;font-weight:600;color:var(--text-secondary);margin-bottom:8px}.empty-state p{font-size:14px}
.loading{display:flex;align-items:center;justify-content:center;padding:40px}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent-teal);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
.section-card{padding:24px}.section-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.section-card-title{font-size:16px;font-weight:700;color:var(--text-primary)}
.status-breakdown-item{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}.status-breakdown-item:last-child{border-bottom:none}.status-breakdown-left{display:flex;align-items:center;gap:12px}.status-breakdown-count{font-weight:700;font-size:16px;color:var(--text-primary)}
.recent-customer-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all .15s}.recent-customer-item:hover{margin:0 -16px;padding:12px 16px;background:var(--bg-tertiary);border-radius:var(--radius-sm)}.recent-customer-item:last-child{border-bottom:none}
.recent-customer-bar{width:4px;height:36px;border-radius:2px}.recent-customer-info{flex:1}.recent-customer-name{font-weight:600;font-size:14px;color:var(--text-primary)}.recent-customer-city{font-size:12px;color:var(--text-muted)}.recent-customer-price{font-weight:700;font-size:14px;color:var(--accent-teal)}
.settings-section{max-width:600px}.settings-card{padding:24px;margin-bottom:20px}.settings-card-title{font-size:16px;font-weight:700;color:var(--text-primary);margin-bottom:20px;display:flex;align-items:center;gap:10px}
</style>
</head>
<body>
<div id="app"></div>
<script>
let user=null,page='login',sidebarOpen=false,customers=[],templates=[],teams=[],emails=[],users=[],categories=[],statuses=[],stats={};
const API='';
function token(){return localStorage.getItem('g360_token')}
async function api(url,opts={}){opts.headers={'Content-Type':'application/json'};if(token())opts.headers.Authorization='Bearer '+token();try{const res=await fetch(API+url,opts);const data=await res.json();if(res.status===401){localStorage.removeItem('g360_token');localStorage.removeItem('g360_user');page='login';user=null;render();throw new Error('Oturum sona erdi')}if(!res.ok)throw new Error(data.error||'Bir hata oluÅŸtu');return data}catch(err){if(err.message==='Failed to fetch')throw new Error('Sunucuya baÄŸlanÄ±lamadÄ±');throw err}}
function toast(msg,type='success'){const t=document.createElement('div');t.className='toast toast-'+type;t.innerHTML=`${type==='success'?'âœ“':type==='error'?'âœ•':'â„¹'}<span>${msg}</span>`;document.body.appendChild(t);setTimeout(()=>{t.style.animation='slideInRight 0.3s ease reverse';setTimeout(()=>t.remove(),300)},3000)}
function nav(p){page=p;render()}function toggleSidebar(){sidebarOpen=!sidebarOpen;render()}function closeSidebar(){sidebarOpen=false;render()}
function isAdmin(){return user?.role==='admin'}function isManager(){return user?.role==='manager'}function isAdminOrManager(){return isAdmin()||isManager()}
function getRoleName(r){return{admin:'Admin',manager:'BÃ¶lge YÃ¶neticisi',sales:'SatÄ±ÅŸ Temsilcisi'}[r]||r}
function getRoleColor(r){return{admin:'background:var(--accent-orange)',manager:'background:var(--accent-purple)',sales:'background:var(--accent-teal)'}[r]||'background:var(--accent-teal)'}
function formatDate(d){return new Date(d).toLocaleString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}
function formatShortDate(d){const date=new Date(d);const today=new Date();if(date.toDateString()===today.toDateString())return date.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});return date.toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit'})}
function formatMoney(n){return new Intl.NumberFormat('tr-TR').format(n||0)+'â‚º'}
function logout(){localStorage.removeItem('g360_token');localStorage.removeItem('g360_user');user=null;page='login';render();toast('Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±','info')}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}
function render(){const app=document.getElementById('app');if(page==='login'){app.innerHTML=loginPage();setupLogin()}else{app.innerHTML=`<div class="app"><div class="overlay ${sidebarOpen?'show':''}" onclick="closeSidebar()"></div>${sidebar()}<div class="main">${mobileHeader()}<div class="content">${page==='dashboard'?dashboardPage():''}${page==='customers'?customersPage():''}${page==='send'?sendPage():''}${page==='emails'?emailsPage():''}${page==='templates'?templatesPage():''}${page==='teams'?teamsPage():''}${page==='users'?usersPage():''}${page==='settings'?settingsPage():''}</div></div></div>`;loadPageData()}}
function loginPage(){return`<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,var(--bg-primary) 0%,#0f1729 100%)"><div class="card" style="width:100%;max-width:400px;padding:40px"><div style="text-align:center;margin-bottom:32px"><div class="sidebar-logo" style="justify-content:center;font-size:42px;margin-bottom:12px"><span>G</span><span>3</span><span>6</span><span>0</span></div><p style="color:var(--text-muted);font-size:15px">CRM & Mail Sistemi</p></div><form id="loginForm"><div class="form-group"><label class="form-label">KullanÄ±cÄ± AdÄ±</label><input type="text" id="username" class="input" placeholder="KullanÄ±cÄ± adÄ±nÄ±z" required autofocus></div><div class="form-group"><label class="form-label">Åžifre</label><input type="password" id="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required></div><button type="submit" class="btn btn-primary" style="width:100%;padding:14px;margin-top:8px">GiriÅŸ Yap</button></form><p style="text-align:center;margin-top:24px;font-size:12px;color:var(--text-muted)">c.g360.ai â€¢ v6.0</p></div></div>`}
function setupLogin(){document.getElementById('loginForm').onsubmit=async(e)=>{e.preventDefault();const btn=e.target.querySelector('button');btn.disabled=true;btn.innerHTML='<span class="spinner" style="width:20px;height:20px;border-width:2px"></span>';try{const res=await api('/api/auth/login',{method:'POST',body:JSON.stringify({username:document.getElementById('username').value,password:document.getElementById('password').value})});localStorage.setItem('g360_token',res.token);localStorage.setItem('g360_user',JSON.stringify(res.user));user=res.user;page='dashboard';render();toast('HoÅŸ geldiniz, '+user.full_name)}catch(err){toast(err.message,'error');btn.disabled=false;btn.textContent='GiriÅŸ Yap'}}}
function sidebar(){return`<aside class="sidebar ${sidebarOpen?'open':''}"><div class="sidebar-header"><div class="sidebar-logo" onclick="nav('dashboard');closeSidebar()"><span>G</span><span>3</span><span>6</span><span>0</span></div></div><nav class="sidebar-nav"><div class="nav-section"><div class="nav-item ${page==='dashboard'?'active':''}" onclick="nav('dashboard');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span>Ana Sayfa</span></div></div><div class="nav-section"><div class="nav-title">MÃ¼ÅŸteriler</div><div class="nav-item ${page==='customers'?'active':''}" onclick="nav('customers');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg><span>MÃ¼ÅŸteriler</span></div></div><div class="nav-section"><div class="nav-title">E-Posta</div><div class="nav-item ${page==='send'?'active':''}" onclick="nav('send');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg><span>Mail GÃ¶nder</span></div><div class="nav-item ${page==='emails'?'active':''}" onclick="nav('emails');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg><span>GÃ¶nderilen</span></div></div>${isAdmin()?`<div class="nav-section"><div class="nav-title">YÃ¶netim</div><div class="nav-item ${page==='templates'?'active':''}" onclick="nav('templates');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><span>Taslaklar</span></div><div class="nav-item ${page==='teams'?'active':''}" onclick="nav('teams');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>Ekipler</span></div><div class="nav-item ${page==='users'?'active':''}" onclick="nav('users');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span>KullanÄ±cÄ±lar</span></div><div class="nav-item ${page==='settings'?'active':''}" onclick="nav('settings');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>Ayarlar</span></div></div>`:`<div class="nav-section"><div class="nav-title">Hesap</div><div class="nav-item ${page==='settings'?'active':''}" onclick="nav('settings');closeSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><span>Profilim</span></div></div>`}<div class="nav-section" style="margin-top:auto;padding-top:16px;border-top:1px solid var(--border)"><a href="https://stats.uptimerobot.com/hJxMDJRwGE" target="_blank" class="nav-link"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>Uptime Monitor</a></div></nav><div class="sidebar-footer"><div class="user-card"><div class="user-avatar" style="${getRoleColor(user?.role)}">${user?.full_name?.[0]||'?'}</div><div class="user-info"><div class="user-name">${user?.full_name||''}</div><div class="user-role">${getRoleName(user?.role)}</div></div><button class="logout-btn" onclick="logout()" title="Ã‡Ä±kÄ±ÅŸ Yap"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></button></div></div></aside>`}
function mobileHeader(){return`<div class="mobile-header"><button class="menu-btn" onclick="toggleSidebar()"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg></button><div class="sidebar-logo" style="font-size:24px"><span>G</span><span>3</span><span>6</span><span>0</span></div><div style="width:40px"></div></div>`}
function dashboardPage(){return`<div class="page-header"><div><p style="color:var(--text-muted);font-size:14px">HoÅŸ geldin,</p><h1 class="page-title">${user?.full_name||''}</h1></div></div><div class="quick-actions"><button class="quick-action-btn" onclick="showCustomerModal()"><div class="quick-action-icon" style="background:rgba(20,184,166,0.15)"><svg width="24" height="24" fill="none" stroke="var(--accent-teal)" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg></div><div class="quick-action-text"><h4>Yeni MÃ¼ÅŸteri</h4><p>MÃ¼ÅŸteri kaydÄ± oluÅŸtur</p></div></button><button class="quick-action-btn" onclick="nav('send')"><div class="quick-action-icon" style="background:rgba(168,85,247,0.15)"><svg width="24" height="24" fill="none" stroke="var(--accent-purple)" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></div><div class="quick-action-text"><h4>Mail GÃ¶nder</h4><p>Teklif maili gÃ¶nder</p></div></button></div><div id="statsGrid" class="stats-grid"><div class="card stat-card"><div class="loading"><div class="spinner"></div></div></div><div class="card stat-card"><div class="loading"><div class="spinner"></div></div></div><div class="card stat-card"><div class="loading"><div class="spinner"></div></div></div><div class="card stat-card"><div class="loading"><div class="spinner"></div></div></div></div><div class="dashboard-grid"><div class="card section-card"><div class="section-card-header"><h3 class="section-card-title">Durum DaÄŸÄ±lÄ±mÄ±</h3></div><div id="statusBreakdown"><div class="loading"><div class="spinner"></div></div></div></div><div class="card section-card"><div class="section-card-header"><h3 class="section-card-title">Son MÃ¼ÅŸteriler</h3><button class="btn btn-ghost btn-sm" onclick="nav('customers')">TÃ¼mÃ¼ â†’</button></div><div id="recentCustomers"><div class="loading"><div class="spinner"></div></div></div></div></div>`}
function customersPage(){return`<div class="page-header"><div><h1 class="page-title">MÃ¼ÅŸteriler</h1><p class="page-subtitle" id="customerCount">YÃ¼kleniyor...</p></div><button class="btn btn-primary" onclick="showCustomerModal()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Yeni MÃ¼ÅŸteri</button></div><div class="customer-filters"><input type="text" class="input" placeholder="Ä°ÅŸletme ara..." id="searchInput" oninput="filterCustomers()"><select class="input" id="statusFilter" onchange="filterCustomers()"><option value="">TÃ¼m Durumlar</option></select><select class="input" id="categoryFilter" onchange="filterCustomers()"><option value="">TÃ¼m Kategoriler</option></select></div><div id="customerList" class="customer-list"><div class="loading"><div class="spinner"></div></div></div>`}
function sendPage(){return`<div class="page-header"><div><h1 class="page-title">Mail GÃ¶nder</h1><p class="page-subtitle">Taslak seÃ§in, deÄŸiÅŸkenleri doldurun, gÃ¶nderin</p></div></div><div class="send-grid"><div class="card" style="padding:24px"><form id="sendForm"><div class="form-group"><label class="form-label">Mail TaslaÄŸÄ± *</label><select id="templateSelect" class="input" required><option value="">Taslak seÃ§in...</option></select></div><div class="form-row"><div class="form-group"><label class="form-label">AlÄ±cÄ± E-posta *</label><input type="email" id="toEmail" class="input" placeholder="ornek@firma.com" required></div><div class="form-group"><label class="form-label">AlÄ±cÄ± AdÄ±</label><input type="text" id="toName" class="input" placeholder="Ad Soyad"></div></div><div id="variableInputs"></div><button type="submit" class="btn btn-primary" style="width:100%;padding:14px;margin-top:12px"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>Mail GÃ¶nder</button></form></div><div class="card" style="padding:24px;position:sticky;top:24px"><h3 style="font-size:14px;font-weight:600;margin-bottom:16px;color:var(--text-muted);display:flex;align-items:center;gap:8px"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>Ã–nizleme</h3><div id="sendPreview" class="preview-box"><p style="color:var(--text-muted);text-align:center;padding:40px 0">Taslak seÃ§in...</p></div></div></div>`}
function emailsPage(){return`<div class="page-header"><div><h1 class="page-title">GÃ¶nderilen Mailler</h1><p class="page-subtitle" id="emailCount">YÃ¼kleniyor...</p></div></div><div class="card" style="padding:0;overflow:hidden"><div id="emailList" class="email-list"><div class="loading"><div class="spinner"></div></div></div></div>`}
function templatesPage(){return`<div class="page-header"><div><h1 class="page-title">Mail TaslaklarÄ±</h1><p class="page-subtitle">DeÄŸiÅŸkenli mail ÅŸablonlarÄ±</p></div><button class="btn btn-primary" onclick="showTemplateModal()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Yeni Taslak</button></div><div id="templatesList" class="templates-grid"><div class="loading"><div class="spinner"></div></div></div>`}
function teamsPage(){return`<div class="page-header"><div><h1 class="page-title">Ekipler</h1><p class="page-subtitle">SatÄ±ÅŸ ekipleri yÃ¶netimi</p></div><button class="btn btn-primary" onclick="showTeamModal()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Yeni Ekip</button></div><div id="teamsList" class="templates-grid"><div class="loading"><div class="spinner"></div></div></div>`}
function usersPage(){return`<div class="page-header"><div><h1 class="page-title">KullanÄ±cÄ±lar</h1><p class="page-subtitle">KullanÄ±cÄ± hesaplarÄ± yÃ¶netimi</p></div><button class="btn btn-primary" onclick="showUserModal()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Yeni KullanÄ±cÄ±</button></div><div class="card"><div id="usersTable" class="table-container"><div class="loading"><div class="spinner"></div></div></div></div>`}
function settingsPage(){return`<div class="page-header"><div><h1 class="page-title">${isAdmin()?'Ayarlar':'Profilim'}</h1><p class="page-subtitle">Hesap ve sistem ayarlarÄ±</p></div></div><div class="settings-section"><div class="card settings-card"><h3 class="settings-card-title"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>Åžifre DeÄŸiÅŸtir</h3><form id="passwordForm"><div class="form-group"><label class="form-label">Mevcut Åžifre</label><input type="password" id="currentPassword" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required></div><div class="form-row"><div class="form-group"><label class="form-label">Yeni Åžifre</label><input type="password" id="newPassword" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6"></div><div class="form-group"><label class="form-label">Yeni Åžifre (Tekrar)</label><input type="password" id="confirmPassword" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required></div></div><button type="submit" class="btn btn-primary">Åžifreyi GÃ¼ncelle</button></form></div>${isAdmin()?`<div class="card settings-card"><h3 class="settings-card-title"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>Mail Ä°mzasÄ±</h3><div class="editor-container"><div class="editor-toolbar"><button type="button" class="toolbar-btn" onclick="document.execCommand('bold')"><strong>B</strong></button><button type="button" class="toolbar-btn" onclick="document.execCommand('italic')"><em>I</em></button><button type="button" class="toolbar-btn" onclick="document.execCommand('createLink',false,prompt('URL:'))">ðŸ”—</button></div><div id="signatureArea" class="editor-area" contenteditable="true" data-placeholder="Mail imzanÄ±zÄ± buraya yazÄ±n..."></div></div><button class="btn btn-primary" style="margin-top:16px" onclick="saveSignature()">Ä°mzayÄ± Kaydet</button></div>`:''}</div>`}
async function loadPageData(){try{if(categories.length===0)categories=await api('/api/categories');if(statuses.length===0)statuses=await api('/api/statuses');templates=await api('/api/templates');if(page==='dashboard'){stats=await api('/api/stats');customers=await api('/api/customers');renderDashboard()}if(page==='customers'){customers=await api('/api/customers');renderCustomers()}if(page==='send')setupSendPage();if(page==='emails'){emails=await api('/api/emails');renderEmails()}if(page==='templates')renderTemplates();if(page==='teams'){teams=await api('/api/teams');renderTeams()}if(page==='users'){teams=await api('/api/teams');users=await api('/api/users');renderUsers()}if(page==='settings')setupSettingsPage()}catch(err){console.error('Data loading error:',err);toast(err.message,'error')}}
function renderDashboard(){document.getElementById('statsGrid').innerHTML=`<div class="card stat-card"><div class="stat-icon" style="background:rgba(34,197,94,0.15)"><svg width="24" height="24" fill="none" stroke="var(--accent-green)" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div class="stat-content"><div class="stat-value">${formatMoney(stats.monthRevenue)}</div><div class="stat-label">AylÄ±k KazanÃ§</div></div></div><div class="card stat-card"><div class="stat-icon" style="background:rgba(59,130,246,0.15)"><svg width="24" height="24" fill="none" stroke="var(--accent-blue)" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg></div><div class="stat-content"><div class="stat-value">${stats.totalCustomers}</div><div class="stat-label">Toplam MÃ¼ÅŸteri</div>${stats.newToday>0?`<div class="stat-change positive">+${stats.newToday} bugÃ¼n</div>`:''}</div></div><div class="card stat-card"><div class="stat-icon" style="background:rgba(34,197,94,0.15)"><svg width="24" height="24" fill="none" stroke="var(--accent-green)" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg></div><div class="stat-content"><div class="stat-value" style="color:var(--accent-green)">${stats.completedCount}</div><div class="stat-label">Tamamlanan</div></div></div><div class="card stat-card"><div class="stat-icon" style="background:rgba(168,85,247,0.15)"><svg width="24" height="24" fill="none" stroke="var(--accent-purple)" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></div><div class="stat-content"><div class="stat-value" style="color:var(--accent-purple)">${stats.sentEmails||stats.totalEmails}</div><div class="stat-label">GÃ¶nderilen Mail</div></div></div>`;let statusHtml='';if(stats.byStatus)stats.byStatus.forEach(s=>{statusHtml+=`<div class="status-breakdown-item"><div class="status-breakdown-left"><div class="status-dot" style="background:${s.color}"></div><span style="font-size:14px;color:var(--text-secondary)">${s.name}</span></div><span class="status-breakdown-count">${s.count}</span></div>`});document.getElementById('statusBreakdown').innerHTML=statusHtml||'<p class="empty-state"><span>HenÃ¼z veri yok</span></p>';let recentHtml='';const recentList=stats.recentCustomers||customers.slice(0,5);recentList.forEach(c=>{const statusInfo=c.status_info||statuses.find(s=>s.id===c.status);recentHtml+=`<div class="recent-customer-item" onclick="showCustomerDetail('${c.id}')"><div class="recent-customer-bar" style="background:${statusInfo?.color||'var(--border)'}"></div><div class="recent-customer-info"><div class="recent-customer-name">${escapeHtml(c.business_name)}</div><div class="recent-customer-city">${c.city||'BelirtilmemiÅŸ'}</div></div><div class="recent-customer-price">${formatMoney(c.price)}</div></div>`});document.getElementById('recentCustomers').innerHTML=recentHtml||'<p class="empty-state"><span>HenÃ¼z mÃ¼ÅŸteri yok</span></p>'}
function renderCustomers(){document.getElementById('statusFilter').innerHTML='<option value="">TÃ¼m Durumlar</option>'+statuses.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');document.getElementById('categoryFilter').innerHTML='<option value="">TÃ¼m Kategoriler</option>'+categories.map(c=>`<option value="${c.id}">${c.id} | ${c.name}</option>`).join('');filterCustomers()}
function filterCustomers(){const search=document.getElementById('searchInput')?.value?.toLowerCase()||'';const status=document.getElementById('statusFilter')?.value||'';const category=document.getElementById('categoryFilter')?.value||'';let filtered=customers.filter(c=>{const matchSearch=!search||c.business_name?.toLowerCase().includes(search)||c.contact_name?.toLowerCase().includes(search)||c.city?.toLowerCase().includes(search);const matchStatus=!status||c.status===parseInt(status);const matchCategory=!category||c.category_id===parseInt(category);return matchSearch&&matchStatus&&matchCategory});document.getElementById('customerCount').textContent=`${filtered.length} mÃ¼ÅŸteri`;if(filtered.length===0){document.getElementById('customerList').innerHTML=`<div class="empty-state"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg><h3>MÃ¼ÅŸteri bulunamadÄ±</h3><p>Arama kriterlerinize uygun mÃ¼ÅŸteri yok</p></div>`;return}let html='';filtered.forEach(c=>{const cat=c.category||categories.find(x=>x.id===c.category_id);const statusInfo=c.status_info||statuses.find(s=>s.id===c.status);html+=`<div class="customer-item"><div class="customer-status-bar" style="background:${statusInfo?.color||'var(--border)'}" onclick="showStatusMenu(event,'${c.id}')" title="Durum deÄŸiÅŸtir"></div><div class="customer-info"><div class="customer-name">${escapeHtml(c.business_name)}${c.is_invoiced?'<span class="badge" style="background:rgba(34,197,94,0.15);color:var(--accent-green);font-size:10px;padding:2px 6px">FaturalÄ±</span>':''}</div><div class="customer-meta"><span>${cat?.name||'Kategori yok'}</span><span>${c.city||''}${c.district?' / '+c.district:''}</span>${c.contact_name?`<span>ðŸ‘¤ ${escapeHtml(c.contact_name)}</span>`:''}</div></div><div class="customer-details"><div class="customer-price"><div class="customer-price-value">${formatMoney(c.price)}</div><div class="customer-price-scenes">${c.scene_count||1} Sahne</div></div><div class="customer-user"><div class="customer-user-avatar">${c.user_name?.[0]||'?'}</div><div class="customer-user-info"><div class="customer-user-name">${c.user_name||'Bilinmiyor'}</div><div class="customer-user-date">${formatShortDate(c.created_at)}</div></div></div></div><div class="customer-actions"><button class="btn btn-primary btn-xs" onclick="sendMailToCustomer('${c.id}')" title="Mail GÃ¶nder"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></button><button class="btn btn-secondary btn-xs" onclick="editCustomer('${c.id}')" title="DÃ¼zenle"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button><button class="btn btn-secondary btn-xs" onclick="showCustomerDetail('${c.id}')" title="Detaylar"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></button></div></div>`});document.getElementById('customerList').innerHTML=html}
function renderEmails(){document.getElementById('emailCount').textContent=`${emails.length} mail`;if(emails.length===0){document.getElementById('emailList').innerHTML=`<div class="empty-state"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg><h3>HenÃ¼z mail gÃ¶nderilmemiÅŸ</h3><p>Ä°lk mailinizi gÃ¶ndermek iÃ§in "Mail GÃ¶nder" sayfasÄ±nÄ± kullanÄ±n</p></div>`;return}let html='';emails.forEach(e=>{const initial=(e.recipient_name||e.recipient_email||'?')[0].toUpperCase();html+=`<div class="email-item" onclick="viewEmail('${e.id}')"><div class="email-avatar">${initial}</div><div class="email-content"><div class="email-recipient">${escapeHtml(e.recipient_name||e.recipient_email)}</div><div class="email-subject">${escapeHtml(e.subject)}</div></div><div class="email-meta"><span class="badge" style="background:${e.status==='sent'?'rgba(34,197,94,0.15)':'rgba(239,68,68,0.15)'};color:${e.status==='sent'?'var(--accent-green)':'var(--accent-red)'}">${e.status==='sent'?'âœ“ GÃ¶nderildi':'âœ• Hata'}</span><span class="email-date">${formatShortDate(e.sent_at)}</span></div></div>`});document.getElementById('emailList').innerHTML=html}
function renderTemplates(){if(templates.length===0){document.getElementById('templatesList').innerHTML=`<div class="empty-state" style="grid-column:1/-1"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><h3>Taslak bulunamadÄ±</h3><p>Ä°lk mail taslaÄŸÄ±nÄ±zÄ± oluÅŸturun</p></div>`;return}let html='';templates.forEach(t=>{html+=`<div class="card" style="padding:20px"><h3 style="font-weight:700;font-size:16px;margin-bottom:8px;color:var(--text-primary)">${escapeHtml(t.name)}</h3><p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(t.subject)}</p><div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">${(t.variables||[]).map(v=>`<span class="var-tag">{{${v}}}</span>`).join('')}</div><div style="display:flex;gap:8px"><button class="btn btn-secondary btn-sm" onclick="editTemplate('${t.id}')">DÃ¼zenle</button><button class="btn btn-danger btn-sm" onclick="deleteTemplate('${t.id}')">Sil</button></div></div>`});document.getElementById('templatesList').innerHTML=html}
function renderTeams(){if(teams.length===0){document.getElementById('teamsList').innerHTML=`<div class="empty-state" style="grid-column:1/-1"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg><h3>Ekip bulunamadÄ±</h3><p>Ä°lk ekibinizi oluÅŸturun</p></div>`;return}let html='';teams.forEach(t=>{html+=`<div class="card" style="padding:20px"><div style="display:flex;align-items:center;gap:14px"><div style="width:48px;height:48px;background:var(--accent-purple);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px">${t.name[0]}</div><div style="flex:1"><h3 style="font-weight:700;font-size:16px;color:var(--text-primary)">${escapeHtml(t.name)}</h3></div><button class="btn btn-danger btn-sm" onclick="deleteTeam('${t.id}')">Sil</button></div></div>`});document.getElementById('teamsList').innerHTML=html}
function renderUsers(){if(users.length===0){document.getElementById('usersTable').innerHTML=`<div class="empty-state"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg><h3>KullanÄ±cÄ± bulunamadÄ±</h3></div>`;return}let html=`<table><thead><tr><th>KullanÄ±cÄ±</th><th>Ekip</th><th>Rol</th><th style="text-align:right">Ä°ÅŸlemler</th></tr></thead><tbody>`;users.forEach(u=>{html+=`<tr><td><div style="display:flex;align-items:center;gap:12px"><div class="user-avatar" style="${getRoleColor(u.role)};width:36px;height:36px;font-size:14px">${u.full_name[0]}</div><div><div style="font-weight:600;color:var(--text-primary)">${escapeHtml(u.full_name)}</div><div style="font-size:12px;color:var(--text-muted)">@${escapeHtml(u.username)}</div></div></div></td><td><span class="badge" style="background:rgba(59,130,246,0.15);color:var(--accent-blue)">${u.team_name||'Ekip yok'}</span></td><td><span class="badge" style="background:${u.role==='admin'?'rgba(249,115,22,0.15)':u.role==='manager'?'rgba(168,85,247,0.15)':'rgba(20,184,166,0.15)'};color:${u.role==='admin'?'var(--accent-orange)':u.role==='manager'?'var(--accent-purple)':'var(--accent-teal)'}">${getRoleName(u.role)}</span></td><td style="text-align:right">${u.role!=='admin'||users.filter(x=>x.role==='admin').length>1?`<button class="btn btn-secondary btn-sm" onclick="editUser('${u.id}')">DÃ¼zenle</button><button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Sil</button>`:''}</td></tr>`});html+='</tbody></table>';document.getElementById('usersTable').innerHTML=html}
async function setupSettingsPage(){document.getElementById('passwordForm').onsubmit=async(e)=>{e.preventDefault();const newPass=document.getElementById('newPassword').value;const confirmPass=document.getElementById('confirmPassword').value;if(newPass!==confirmPass){toast('Åžifreler eÅŸleÅŸmiyor','error');return}try{await api('/api/auth/password',{method:'PUT',body:JSON.stringify({current_password:document.getElementById('currentPassword').value,new_password:newPass})});toast('Åžifre gÃ¼ncellendi');e.target.reset()}catch(err){toast(err.message,'error')}};if(isAdmin()){try{const settings=await api('/api/settings');document.getElementById('signatureArea').innerHTML=settings.signature||''}catch(err){console.error('Failed to load signature:',err)}}}
async function saveSignature(){try{await api('/api/settings',{method:'POST',body:JSON.stringify({signature:document.getElementById('signatureArea').innerHTML})});toast('Ä°mza kaydedildi')}catch(err){toast(err.message,'error')}}
function showCustomerModal(edit=null){const m=document.createElement('div');m.className='modal';m.id='customerModal';const categoryOpts=categories.map(c=>`<option value="${c.id}" ${edit?.category_id===c.id?'selected':''}>${c.id} | ${c.name}</option>`).join('');m.innerHTML=`<div class="modal-content modal-lg"><div class="modal-header"><h3 class="modal-title">${edit?escapeHtml(edit.business_name):'Yeni MÃ¼ÅŸteri'}</h3><button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button></div><div class="modal-body">${edit?`<div class="form-group"><label class="form-label">Durum</label><div class="status-picker" id="statusPicker"></div></div>`:''}<div style="background:var(--bg-primary);padding:20px;border-radius:var(--radius-md);margin-bottom:20px;border:1px solid var(--border)"><label class="form-label" style="margin-bottom:12px">Ä°ÅŸletme</label><div class="form-group" style="margin-bottom:16px"><label class="form-label">Kategori *</label><select id="custCategory" class="input" required><option value="">Kategori seÃ§in</option>${categoryOpts}</select></div><div class="form-group" style="margin-bottom:0"><div class="places-wrapper"><input type="text" id="custBusinessName" class="input" placeholder="Ä°ÅŸletme adÄ±nÄ± yazÄ±n ve listeden seÃ§in..." value="${edit?.business_name||''}" required autocomplete="off"><div id="placesDropdown" class="places-dropdown"></div></div><p class="form-hint">Google Places'tan iÅŸletme bilgileri otomatik doldurulur</p></div></div><div class="form-group"><label class="form-label">Adres</label><input type="text" id="custAddress" class="input" placeholder="Lokasyon seÃ§ilince otomatik dolar" value="${edit?.address||''}" readonly style="background:var(--bg-primary)"><input type="hidden" id="custPlaceId" value="${edit?.place_id||''}"><input type="hidden" id="custCity" value="${edit?.city||''}"><input type="hidden" id="custDistrict" value="${edit?.district||''}"></div><div class="form-row-3"><div class="form-group"><label class="form-label">Yetkili Personel</label><input type="text" id="custContact" class="input" placeholder="Ad Soyad" value="${edit?.contact_name||''}"></div><div class="form-group"><label class="form-label">Telefon</label><input type="text" id="custPhone" class="input" placeholder="+90 5XX XXX XX XX" value="${edit?.phone||''}"></div><div class="form-group"><label class="form-label">E-Posta</label><input type="email" id="custEmail" class="input" placeholder="ornek@firma.com" value="${edit?.email||''}"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ä°ÅŸletme Ä°smi</label><input type="text" id="custBusinessNameAlt" class="input" placeholder="Manuel giriÅŸ (opsiyonel)" value="${edit?.business_name||''}"></div><div class="form-group"><label class="form-label">Vergi NumarasÄ±</label><input type="text" id="custTaxNumber" class="input" placeholder="Vergi numarasÄ±" value="${edit?.tax_number||''}"></div></div><div style="background:var(--bg-primary);padding:20px;border-radius:var(--radius-md);margin-top:20px;border:1px solid var(--border)"><label class="form-label" style="margin-bottom:16px">Teklif</label><div class="form-row"><div class="form-group" style="margin-bottom:0"><label class="form-label">Verilen Teklif (â‚º)</label><input type="number" id="custPrice" class="input" placeholder="0" value="${edit?.price||''}" step="0.01" oninput="calcKdv()"></div><div class="form-group" style="margin-bottom:0"><label class="form-label">Sahne SayÄ±sÄ±</label><input type="number" id="custSceneCount" class="input" placeholder="1" value="${edit?.scene_count||1}" min="1"></div></div><div class="form-group" style="margin-top:16px;margin-bottom:0"><label class="checkbox-wrapper"><input type="checkbox" id="custInvoiced" ${edit?.is_invoiced?'checked':''} onchange="calcKdv()"><span class="checkbox-label">KDV Dahil (FaturalÄ± Ä°ÅŸlem - %20)</span></label><div id="kdvCalc" class="kdv-calc"><div class="kdv-row"><span>KDV'siz Tutar:</span><span id="kdvWithout">0â‚º</span></div><div class="kdv-row"><span>KDV (%20):</span><span id="kdvAmount">0â‚º</span></div><div class="kdv-row total"><span>Toplam:</span><span id="kdvTotal">0â‚º</span></div></div></div></div><div class="form-group" style="margin-top:20px"><label class="form-label">Notlar</label><textarea id="custNotes" class="input" rows="3" placeholder="Ä°ÅŸletme yada teklif ile ilgili notlarÄ±nÄ±zÄ± buraya yazabilirsiniz.">${edit?.notes||''}</textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Ä°ptal</button><button class="btn btn-primary" onclick="saveCustomer('${edit?.id||''}')">${edit?'GÃ¼ncelle':'Kaydet'}</button></div></div>`;document.body.appendChild(m);m.onclick=(e)=>{if(e.target===m)m.remove()};if(edit){const picker=document.getElementById('statusPicker');picker.innerHTML=statuses.map(s=>`<button type="button" class="status-btn ${edit.status===s.id?'active':''}" data-status="${s.id}" style="${edit.status===s.id?'background:'+s.color+';border-color:'+s.color:''}">${s.name}</button>`).join('');picker.querySelectorAll('.status-btn').forEach(btn=>{btn.onclick=()=>{picker.querySelectorAll('.status-btn').forEach(b=>{b.classList.remove('active');b.style.background='var(--bg-primary)';b.style.borderColor='transparent'});btn.classList.add('active');const status=statuses.find(s=>s.id===parseInt(btn.dataset.status));btn.style.background=status.color;btn.style.borderColor=status.color}})}setupPlacesAutocomplete();calcKdv()}
function calcKdv(){const price=parseFloat(document.getElementById('custPrice')?.value)||0;const invoiced=document.getElementById('custInvoiced')?.checked;const calc=document.getElementById('kdvCalc');if(invoiced&&price>0){calc.style.display='block';const without=price/1.20;const vat=price-without;document.getElementById('kdvWithout').textContent=formatMoney(without);document.getElementById('kdvAmount').textContent=formatMoney(vat);document.getElementById('kdvTotal').textContent=formatMoney(price)}else{calc.style.display='none'}}
let placesTimeout=null;function setupPlacesAutocomplete(){const input=document.getElementById('custBusinessName');const dropdown=document.getElementById('placesDropdown');input.oninput=()=>{clearTimeout(placesTimeout);const q=input.value.trim();if(q.length<2){dropdown.classList.remove('show');return}placesTimeout=setTimeout(async()=>{try{const res=await api('/api/places/autocomplete?input='+encodeURIComponent(q));if(res.predictions?.length>0){dropdown.innerHTML=res.predictions.map(p=>`<div class="places-item" data-place-id="${p.place_id}"><div class="places-item-name">${p.structured_formatting?.main_text||p.description}</div><div class="places-item-address">${p.structured_formatting?.secondary_text||''}</div></div>`).join('');dropdown.classList.add('show');dropdown.querySelectorAll('.places-item').forEach(item=>{item.onclick=async()=>{const placeId=item.dataset.placeId;try{const details=await api('/api/places/details?place_id='+placeId);if(details.result){document.getElementById('custBusinessName').value=details.result.name||'';document.getElementById('custBusinessNameAlt').value=details.result.name||'';document.getElementById('custAddress').value=details.result.formatted_address||'';document.getElementById('custPlaceId').value=placeId;document.getElementById('custCity').value=details.parsed?.city||'';document.getElementById('custDistrict').value=details.parsed?.district||'';if(details.result.formatted_phone_number){document.getElementById('custPhone').value=details.result.formatted_phone_number}}}catch(err){console.error('Places details error:',err)}dropdown.classList.remove('show')}})}else{dropdown.classList.remove('show')}}catch(err){dropdown.classList.remove('show')}},300)};document.addEventListener('click',(e)=>{if(!e.target.closest('.places-wrapper')){dropdown.classList.remove('show')}})}
async function saveCustomer(id){const businessName=document.getElementById('custBusinessNameAlt').value||document.getElementById('custBusinessName').value;const data={category_id:document.getElementById('custCategory').value,business_name:businessName,place_id:document.getElementById('custPlaceId').value,address:document.getElementById('custAddress').value,city:document.getElementById('custCity').value,district:document.getElementById('custDistrict').value,contact_name:document.getElementById('custContact').value,phone:document.getElementById('custPhone').value,email:document.getElementById('custEmail').value,tax_number:document.getElementById('custTaxNumber').value,price:document.getElementById('custPrice').value||0,is_invoiced:document.getElementById('custInvoiced').checked,scene_count:document.getElementById('custSceneCount').value||1,notes:document.getElementById('custNotes').value};if(!data.category_id){toast('Kategori seÃ§in','error');return}if(!data.business_name){toast('Ä°ÅŸletme adÄ± girin','error');return}if(id){const activeStatus=document.querySelector('.status-btn.active');if(activeStatus)data.status=activeStatus.dataset.status}const btn=document.querySelector('#customerModal .btn-primary');btn.disabled=true;btn.innerHTML='<span class="spinner" style="width:16px;height:16px;border-width:2px"></span>';try{await api(id?'/api/customers/'+id:'/api/customers',{method:id?'PUT':'POST',body:JSON.stringify(data)});toast(id?'MÃ¼ÅŸteri gÃ¼ncellendi':'MÃ¼ÅŸteri oluÅŸturuldu');document.getElementById('customerModal').remove();customers=await api('/api/customers');if(page==='customers')renderCustomers();else if(page==='dashboard'){stats=await api('/api/stats');renderDashboard()}}catch(err){toast(err.message,'error');btn.disabled=false;btn.textContent=id?'GÃ¼ncelle':'Kaydet'}}
async function editCustomer(id){const c=customers.find(x=>x.id===id);if(c)showCustomerModal(c)}
function showCustomerDetail(id){const c=customers.find(x=>x.id===id);if(!c)return;const category=c.category||categories.find(cat=>cat.id===c.category_id);const statusInfo=c.status_info||statuses.find(s=>s.id===c.status);const m=document.createElement('div');m.className='modal';m.innerHTML=`<div class="modal-content"><div class="modal-header"><h3 class="modal-title">${escapeHtml(c.business_name)}</h3><button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button></div><div class="modal-body"><div class="detail-section"><div class="detail-title">Durum</div><div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg-primary);border-radius:var(--radius-md)"><div class="status-dot" style="background:${statusInfo?.color}"></div><span style="font-weight:600;color:var(--text-primary)">${statusInfo?.name}</span></div></div><div class="detail-section"><div class="detail-title">Ä°ÅŸletme Bilgileri</div><div class="detail-row"><span class="detail-label">Kategori</span><span class="detail-value">${category?.name||'-'}</span></div><div class="detail-row"><span class="detail-label">Yetkili</span><span class="detail-value">${escapeHtml(c.contact_name)||'-'}</span></div><div class="detail-row"><span class="detail-label">Telefon</span><span class="detail-value">${c.phone||'-'}</span></div><div class="detail-row"><span class="detail-label">E-Posta</span><span class="detail-value">${c.email||'-'}</span></div><div class="detail-row"><span class="detail-label">Vergi No</span><span class="detail-value">${c.tax_number||'-'}</span></div></div><div class="detail-section"><div class="detail-title">Lokasyon</div><div class="detail-row"><span class="detail-label">Ä°l / Ä°lÃ§e</span><span class="detail-value">${c.city||'-'}${c.district?' / '+c.district:''}</span></div><div class="detail-row"><span class="detail-label">Adres</span><span class="detail-value" style="max-width:240px;white-space:normal;text-align:right">${c.address||'-'}</span></div></div><div class="detail-section"><div class="detail-title">FiyatlandÄ±rma</div>${c.is_invoiced?`<div class="detail-row"><span class="detail-label">KDV'siz Tutar</span><span class="detail-value">${formatMoney(c.price_without_vat)}</span></div><div class="detail-row"><span class="detail-label">KDV (%20)</span><span class="detail-value">${formatMoney(c.vat_amount)}</span></div><div class="detail-row"><span class="detail-label">Toplam</span><span class="detail-value" style="color:var(--accent-teal);font-size:18px">${formatMoney(c.price)}</span></div>`:`<div class="detail-row"><span class="detail-label">Fiyat</span><span class="detail-value" style="color:var(--accent-teal);font-size:18px">${formatMoney(c.price)}</span></div>`}<div class="detail-row"><span class="detail-label">Sahne SayÄ±sÄ±</span><span class="detail-value">${c.scene_count||1}</span></div><div class="detail-row"><span class="detail-label">Fatura Durumu</span><span class="detail-value">${c.is_invoiced?'<span class="badge" style="background:rgba(34,197,94,0.15);color:var(--accent-green)">FaturalÄ±</span>':'<span class="badge" style="background:rgba(239,68,68,0.15);color:var(--accent-red)">FaturasÄ±z</span>'}</span></div></div>${c.notes?`<div class="detail-section"><div class="detail-title">Notlar</div><p style="color:var(--text-secondary);font-size:14px;line-height:1.6">${escapeHtml(c.notes)}</p></div>`:''}<div class="detail-section"><div class="detail-title">Meta</div><div class="detail-row"><span class="detail-label">OluÅŸturan</span><span class="detail-value">${c.user_name||'-'}</span></div><div class="detail-row"><span class="detail-label">OluÅŸturma Tarihi</span><span class="detail-value">${formatDate(c.created_at)}</span></div></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteCustomer('${c.id}')">Sil</button><button class="btn btn-secondary" onclick="editCustomer('${c.id}');this.closest('.modal').remove()">DÃ¼zenle</button><button class="btn btn-primary" onclick="sendMailToCustomer('${c.id}');this.closest('.modal').remove()">Mail GÃ¶nder</button></div></div>`;document.body.appendChild(m);m.onclick=(e)=>{if(e.target===m)m.remove()}}
async function deleteCustomer(id){if(!confirm('Bu mÃ¼ÅŸteriyi silmek istediÄŸinize emin misiniz?'))return;try{await api('/api/customers/'+id,{method:'DELETE'});toast('MÃ¼ÅŸteri silindi');document.querySelector('.modal')?.remove();customers=await api('/api/customers');if(page==='customers')renderCustomers();else if(page==='dashboard'){stats=await api('/api/stats');renderDashboard()}}catch(err){toast(err.message,'error')}}
function showStatusMenu(e,id){e.stopPropagation();document.querySelectorAll('.status-menu').forEach(m=>m.remove());const c=customers.find(x=>x.id===id);if(!c)return;const menu=document.createElement('div');menu.className='status-menu show';menu.style.position='fixed';menu.style.left=Math.min(e.clientX,window.innerWidth-240)+'px';menu.style.top=Math.min(e.clientY,window.innerHeight-300)+'px';menu.innerHTML=statuses.map(s=>`<div class="status-menu-item ${c.status===s.id?'style="background:var(--bg-secondary)"':''}" onclick="changeStatus('${id}',${s.id})"><div class="status-dot" style="background:${s.color}"></div><span>${s.name}</span>${c.status===s.id?'<span style="margin-left:auto;color:var(--accent-teal)">âœ“</span>':''}</div>`).join('');document.body.appendChild(menu);setTimeout(()=>document.addEventListener('click',()=>menu.remove(),{once:true}),10)}
async function changeStatus(id,status){try{await api('/api/customers/'+id+'/status',{method:'PATCH',body:JSON.stringify({status})});toast('Durum gÃ¼ncellendi');customers=await api('/api/customers');if(page==='customers')renderCustomers();else if(page==='dashboard'){stats=await api('/api/stats');renderDashboard()}}catch(err){toast(err.message,'error')}}
let currentVars={},currentCustomerId=null;
function sendMailToCustomer(id){const c=customers.find(x=>x.id===id);if(!c)return;currentCustomerId=id;page='send';render();setTimeout(()=>{if(c.email)document.getElementById('toEmail').value=c.email;if(c.contact_name)document.getElementById('toName').value=c.contact_name;window.mailCustomer=c;toast('MÃ¼ÅŸteri bilgileri yÃ¼klendi','info')},100)}
function setupSendPage(){const select=document.getElementById('templateSelect');select.innerHTML='<option value="">Taslak seÃ§in...</option>'+templates.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');select.onchange=onTemplateChange;document.getElementById('sendForm').onsubmit=handleSend}
function onTemplateChange(){const tid=document.getElementById('templateSelect').value;const t=templates.find(x=>x.id===tid);currentVars={};if(!t){document.getElementById('variableInputs').innerHTML='';document.getElementById('sendPreview').innerHTML='<p style="color:var(--text-muted);text-align:center;padding:40px 0">Taslak seÃ§in...</p>';return}if(t.variables?.length>0){let html='<div class="form-group"><label class="form-label">DeÄŸiÅŸkenler</label><div class="var-inputs">';t.variables.forEach(v=>{let def='';if(window.mailCustomer){const c=window.mailCustomer;if(v==='isim'||v==='ad'||v==='yetkili')def=c.contact_name||'';if(v==='firma'||v==='iÅŸletme'||v==='isletme')def=c.business_name||'';if(v==='fiyat'||v==='tutar'||v==='ucret')def=c.price||'';if(v==='email'||v==='eposta')def=c.email||'';if(v==='telefon'||v==='tel')def=c.phone||''}html+=`<input type="text" class="var-input" id="var_${v}" placeholder="${v}" value="${def}" oninput="updateVar('${v}',this.value)">`;if(def)currentVars[v]=def});html+='</div></div>';document.getElementById('variableInputs').innerHTML=html}else{document.getElementById('variableInputs').innerHTML=''}updatePreview()}
function updateVar(name,value){currentVars[name]=value;updatePreview()}
function updatePreview(){const tid=document.getElementById('templateSelect').value;const t=templates.find(x=>x.id===tid);if(!t)return;let subject=t.subject;let body=t.body;Object.keys(currentVars).forEach(k=>{const re=new RegExp('\\{\\{'+k+'\\}\\}','g');const val=currentVars[k]||`<span class="var-tag">{{${k}}}</span>`;subject=subject.replace(re,val);body=body.replace(re,val)});subject=subject.replace(/\{\{(\w+)\}\}/g,'<span class="var-tag">{{$1}}</span>');body=body.replace(/\{\{(\w+)\}\}/g,'<span class="var-tag">{{$1}}</span>');document.getElementById('sendPreview').innerHTML=`<div class="preview-subject">${subject}</div><div style="font-size:14px;line-height:1.7;color:var(--text-secondary)">${body}</div>`}
async function handleSend(e){e.preventDefault();const tid=document.getElementById('templateSelect').value;if(!tid){toast('Taslak seÃ§in','error');return}const email=document.getElementById('toEmail').value;if(!email){toast('E-posta adresi girin','error');return}const btn=e.target.querySelector('button[type="submit"]');btn.disabled=true;btn.innerHTML='<span class="spinner" style="width:18px;height:18px;border-width:2px"></span> GÃ¶nderiliyor...';try{await api('/api/emails/send',{method:'POST',body:JSON.stringify({template_id:tid,recipient_email:email,recipient_name:document.getElementById('toName').value,variables:currentVars,customer_id:currentCustomerId})});toast('Mail baÅŸarÄ±yla gÃ¶nderildi!');window.mailCustomer=null;currentCustomerId=null;currentVars={};document.getElementById('sendForm').reset();document.getElementById('variableInputs').innerHTML='';document.getElementById('sendPreview').innerHTML='<p style="color:var(--text-muted);text-align:center;padding:40px 0">Taslak seÃ§in...</p>'}catch(err){toast(err.message,'error')}btn.disabled=false;btn.innerHTML=`<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>Mail GÃ¶nder`}
async function viewEmail(id){try{const e=await api('/api/emails/'+id);const m=document.createElement('div');m.className='modal';m.innerHTML=`<div class="modal-content modal-lg"><div class="modal-header"><h3 class="modal-title">Mail DetayÄ±</h3><button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button></div><div style="padding:20px;background:var(--bg-primary);border-bottom:1px solid var(--border)"><div style="font-size:18px;font-weight:700;margin-bottom:12px;color:var(--text-primary)">${escapeHtml(e.subject)}</div><div style="display:flex;flex-wrap:wrap;gap:16px;font-size:13px;color:var(--text-muted)"><span><strong>AlÄ±cÄ±:</strong> ${escapeHtml(e.recipient_name||'')} &lt;${e.recipient_email}&gt;</span><span><strong>Tarih:</strong> ${formatDate(e.sent_at)}</span><span><strong>Durum:</strong> <span class="badge" style="background:${e.status==='sent'?'rgba(34,197,94,0.15)':'rgba(239,68,68,0.15)'};color:${e.status==='sent'?'var(--accent-green)':'var(--accent-red)'}">${e.status==='sent'?'GÃ¶nderildi':'Hata'}</span></span></div></div><div class="modal-body"><div style="font-size:14px;line-height:1.7;color:var(--text-secondary)">${e.body}</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Kapat</button></div></div>`;document.body.appendChild(m);m.onclick=(ev)=>{if(ev.target===m)m.remove()}}catch(err){toast(err.message,'error')}}
function showTemplateModal(edit=null){const m=document.createElement('div');m.className='modal';m.id='templateModal';m.innerHTML=`<div class="modal-content modal-lg"><div class="modal-header"><h3 class="modal-title">${edit?'Taslak DÃ¼zenle':'Yeni Taslak'}</h3><button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Taslak AdÄ± *</label><input type="text" id="tplName" class="input" value="${edit?.name||''}" placeholder="Ã–rn: Teklif Maili" required></div><div class="form-group"><label class="form-label">Konu *</label><input type="text" id="tplSubject" class="input" placeholder="{{deÄŸiÅŸken}} kullanabilirsiniz" value="${edit?.subject||''}" required><p class="form-hint">Ã–rn: {{firma}} iÃ§in Google Street View Teklifi</p></div><div class="form-group"><label class="form-label">Ä°Ã§erik *</label><div class="editor-container"><div class="editor-toolbar"><button type="button" class="toolbar-btn" onclick="document.execCommand('bold')"><strong>B</strong></button><button type="button" class="toolbar-btn" onclick="document.execCommand('italic')"><em>I</em></button><button type="button" class="toolbar-btn" onclick="insertVariable()">{{x}} DeÄŸiÅŸken</button></div><div id="tplBody" class="editor-area" contenteditable="true" data-placeholder="Mail iÃ§eriÄŸi...">${edit?.body||''}</div></div><p class="form-hint">YaygÄ±n deÄŸiÅŸkenler: {{isim}}, {{firma}}, {{fiyat}}</p></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Ä°ptal</button><button class="btn btn-primary" onclick="saveTemplate('${edit?.id||''}')">${edit?'GÃ¼ncelle':'Kaydet'}</button></div></div>`;document.body.appendChild(m);m.onclick=(e)=>{if(e.target===m)m.remove()}}
function insertVariable(){const name=prompt('DeÄŸiÅŸken adÄ± (Ã¶rn: isim, firma, fiyat):');if(name){document.execCommand('insertText',false,'{{'+name.trim()+'}}')}}
async function saveTemplate(id){const name=document.getElementById('tplName').value;const subject=document.getElementById('tplSubject').value;const body=document.getElementById('tplBody').innerHTML;if(!name||!subject||!body){toast('TÃ¼m alanlarÄ± doldurun','error');return}try{await api(id?'/api/templates/'+id:'/api/templates',{method:id?'PUT':'POST',body:JSON.stringify({name,subject,body})});toast(id?'Taslak gÃ¼ncellendi':'Taslak oluÅŸturuldu');document.getElementById('templateModal').remove();templates=await api('/api/templates');renderTemplates()}catch(err){toast(err.message,'error')}}
async function editTemplate(id){const t=templates.find(x=>x.id===id);if(t)showTemplateModal(t)}
async function deleteTemplate(id){if(!confirm('Bu taslaÄŸÄ± silmek istediÄŸinize emin misiniz?'))return;try{await api('/api/templates/'+id,{method:'DELETE'});toast('Taslak silindi');templates=await api('/api/templates');renderTemplates()}catch(err){toast(err.message,'error')}}
function showTeamModal(){const m=document.createElement('div');m.className='modal';m.innerHTML=`<div class="modal-content" style="max-width:400px"><div class="modal-header"><h3 class="modal-title">Yeni Ekip</h3><button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Ekip AdÄ± *</label><input type="text" id="teamName" class="input" placeholder="Ã–rn: Ä°stanbul Avrupa" required></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Ä°ptal</button><button class="btn btn-primary" onclick="saveTeam()">Kaydet</button></div></div>`;document.body.appendChild(m)}
async function saveTeam(){const name=document.getElementById('teamName').value;if(!name){toast('Ekip adÄ± girin','error');return}try{await api('/api/teams',{method:'POST',body:JSON.stringify({name})});toast('Ekip oluÅŸturuldu');document.querySelector('.modal').remove();teams=await api('/api/teams');renderTeams()}catch(err){toast(err.message,'error')}}
async function deleteTeam(id){if(!confirm('Bu ekibi silmek istediÄŸinize emin misiniz?'))return;try{await api('/api/teams/'+id,{method:'DELETE'});toast('Ekip silindi');teams=await api('/api/teams');renderTeams()}catch(err){toast(err.message,'error')}}
function showUserModal(edit=null){const teamOpts=teams.map(t=>`<option value="${t.id}" ${edit?.team_id===t.id?'selected':''}>${t.name}</option>`).join('');const m=document.createElement('div');m.className='modal';m.innerHTML=`<div class="modal-content" style="max-width:480px"><div class="modal-header"><h3 class="modal-title">${edit?'KullanÄ±cÄ± DÃ¼zenle':'Yeni KullanÄ±cÄ±'}</h3><button class="modal-close" onclick="this.closest('.modal').remove()">âœ•</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label class="form-label">KullanÄ±cÄ± AdÄ± *</label><input type="text" id="userName" class="input" value="${edit?.username||''}" ${edit?'disabled style="opacity:0.6"':'required'} placeholder="kullanici"></div><div class="form-group"><label class="form-label">Ad Soyad *</label><input type="text" id="userFullName" class="input" value="${edit?.full_name||''}" required placeholder="Ad Soyad"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ekip</label><select id="userTeam" class="input"><option value="">Ekip seÃ§in</option>${teamOpts}</select></div><div class="form-group"><label class="form-label">Rol *</label><select id="userRole" class="input" required><option value="sales" ${edit?.role==='sales'?'selected':''}>SatÄ±ÅŸ Temsilcisi</option><option value="manager" ${edit?.role==='manager'?'selected':''}>BÃ¶lge YÃ¶neticisi</option><option value="admin" ${edit?.role==='admin'?'selected':''}>Admin</option></select></div></div><div class="form-group"><label class="form-label">Åžifre ${edit?'(boÅŸ bÄ±rakÄ±rsanÄ±z deÄŸiÅŸmez)':'*'}</label><input type="password" id="userPass" class="input" ${edit?'':'required'} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minlength="6"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Ä°ptal</button><button class="btn btn-primary" onclick="saveUser('${edit?.id||''}')">${edit?'GÃ¼ncelle':'Kaydet'}</button></div></div>`;document.body.appendChild(m)}
async function saveUser(id){const data={full_name:document.getElementById('userFullName').value,team_id:document.getElementById('userTeam').value||null,role:document.getElementById('userRole').value};if(!id){data.username=document.getElementById('userName').value;if(!data.username){toast('KullanÄ±cÄ± adÄ± girin','error');return}}const pass=document.getElementById('userPass').value;if(pass)data.password=pass;else if(!id){toast('Åžifre girin','error');return}if(!data.full_name){toast('Ad soyad girin','error');return}try{await api(id?'/api/users/'+id:'/api/users',{method:id?'PUT':'POST',body:JSON.stringify(data)});toast(id?'KullanÄ±cÄ± gÃ¼ncellendi':'KullanÄ±cÄ± oluÅŸturuldu');document.querySelector('.modal').remove();users=await api('/api/users');renderUsers()}catch(err){toast(err.message,'error')}}
async function editUser(id){const u=users.find(x=>x.id===id);if(u)showUserModal(u)}
async function deleteUser(id){if(!confirm('Bu kullanÄ±cÄ±yÄ± silmek istediÄŸinize emin misiniz?'))return;try{await api('/api/users/'+id,{method:'DELETE'});toast('KullanÄ±cÄ± silindi');users=await api('/api/users');renderUsers()}catch(err){toast(err.message,'error')}}
(function init(){const t=localStorage.getItem('g360_token');const u=localStorage.getItem('g360_user');if(t&&u){try{user=JSON.parse(u);page='dashboard'}catch(e){localStorage.removeItem('g360_token');localStorage.removeItem('g360_user')}}render()})();
</script>
</body>
</html>
