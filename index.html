<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G360 Mail</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:#f8fafc;color:#1e293b;min-height:100vh}
.hidden{display:none!important}
.btn{padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;font-size:14px}
.btn-primary{background:linear-gradient(135deg,#0d9488,#0891b2);color:#fff}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(13,148,136,0.3)}
.btn-secondary{background:#e2e8f0;color:#475569}
.btn-secondary:hover{background:#cbd5e1}
.btn-danger{background:#fee2e2;color:#dc2626}
.btn-danger:hover{background:#fecaca}
.btn-sm{padding:6px 12px;font-size:12px}
.input{width:100%;padding:12px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;transition:border 0.2s}
.input:focus{outline:none;border-color:#0d9488}
.card{background:#fff;border-radius:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);border:1px solid #e2e8f0}
.badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-success{background:#d1fae5;color:#059669}
.badge-danger{background:#fee2e2;color:#dc2626}
.badge-info{background:#e0f2fe;color:#0284c7}
.badge-purple{background:#f3e8ff;color:#9333ea}
.badge-orange{background:#ffedd5;color:#ea580c}

/* Layout */
.app{display:flex;min-height:100vh}
.sidebar{width:280px;background:#fff;border-right:1px solid #e2e8f0;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100}
.main{flex:1;margin-left:280px;min-height:100vh}
.content{padding:24px;max-width:1400px;margin:0 auto}

/* Mobile */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);transition:transform 0.3s}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0}
  .mobile-header{display:flex!important}
  .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
  .overlay.show{display:block}
}

/* Sidebar */
.sidebar-header{padding:20px;border-bottom:1px solid #e2e8f0}
.sidebar-logo{display:flex;align-items:center;gap:12px}
.sidebar-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#0d9488,#0891b2);border-radius:10px;display:flex;align-items:center;justify-content:center}
.sidebar-logo-icon svg{width:24px;height:24px;color:#fff}
.sidebar-logo-text{font-size:20px;font-weight:700;color:#0d9488}
.sidebar-nav{flex:1;padding:16px;overflow-y:auto}
.nav-section{margin-bottom:24px}
.nav-title{font-size:11px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;padding:0 12px;margin-bottom:8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;color:#64748b;cursor:pointer;transition:all 0.2s;margin-bottom:4px}
.nav-item:hover{background:#f1f5f9;color:#0d9488}
.nav-item.active{background:linear-gradient(135deg,rgba(13,148,136,0.1),rgba(8,145,178,0.1));color:#0d9488;font-weight:600}
.nav-item svg{width:20px;height:20px}
.sidebar-footer{padding:16px;border-top:1px solid #e2e8f0}
.user-card{display:flex;align-items:center;gap:12px;padding:12px;background:#f8fafc;border-radius:12px}
.user-avatar{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px}
.user-info{flex:1;min-width:0}
.user-name{font-weight:600;font-size:14px;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-role{font-size:12px;color:#64748b}
.logout-btn{padding:8px;border-radius:8px;background:transparent;border:none;cursor:pointer;color:#94a3b8}
.logout-btn:hover{background:#fee2e2;color:#dc2626}

/* Mobile Header */
.mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:60px;background:#fff;border-bottom:1px solid #e2e8f0;padding:0 16px;align-items:center;justify-content:space-between;z-index:98}
.menu-btn{padding:8px;border:none;background:transparent;cursor:pointer}

/* Page Header */
.page-header{margin-bottom:24px}
.page-title{font-size:24px;font-weight:700;color:#1e293b;margin-bottom:4px}
.page-subtitle{color:#64748b;font-size:14px}

/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{padding:20px;display:flex;align-items:center;gap:16px}
.stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center}
.stat-icon svg{width:24px;height:24px}
.stat-value{font-size:28px;font-weight:700;color:#1e293b}
.stat-label{font-size:13px;color:#64748b}

/* Table */
.table-container{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:14px 16px;font-size:12px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid #e2e8f0}
td{padding:16px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
tr:hover td{background:#f8fafc}
.table-empty{padding:48px;text-align:center;color:#94a3b8}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(15,23,42,0.6);display:flex;align-items:center;justify-content:center;z-index:200;padding:16px}
.modal-content{background:#fff;border-radius:20px;width:100%;max-width:600px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:20px 24px;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:18px;font-weight:700}
.modal-close{padding:8px;border:none;background:#f1f5f9;border-radius:8px;cursor:pointer}
.modal-close:hover{background:#e2e8f0}
.modal-body{padding:24px;overflow-y:auto;flex:1}
.modal-footer{padding:16px 24px;border-top:1px solid #e2e8f0;display:flex;gap:12px;justify-content:flex-end}
.modal-lg{max-width:900px}

/* Form */
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:8px}
.form-hint{font-size:12px;color:#94a3b8;margin-top:6px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:640px){.form-row{grid-template-columns:1fr}}

/* Template Editor */
.editor-container{border:2px solid #e2e8f0;border-radius:12px;overflow:hidden}
.editor-toolbar{padding:12px;background:#f8fafc;border-bottom:1px solid #e2e8f0;display:flex;flex-wrap:wrap;gap:8px}
.toolbar-btn{padding:8px 12px;border:1px solid #e2e8f0;background:#fff;border-radius:8px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px}
.toolbar-btn:hover{background:#f1f5f9;border-color:#cbd5e1}
.toolbar-btn.active{background:#0d9488;color:#fff;border-color:#0d9488}
.editor-area{min-height:200px;padding:16px;outline:none;font-size:14px;line-height:1.7}
.editor-area:empty:before{content:attr(data-placeholder);color:#94a3b8}
.var-tag{display:inline-block;background:linear-gradient(135deg,#fef3c7,#fde68a);color:#92400e;padding:2px 8px;border-radius:6px;font-weight:600;font-size:13px;margin:0 2px}

/* Send Form */
.send-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
@media(max-width:900px){.send-grid{grid-template-columns:1fr}}
.preview-card{position:sticky;top:24px}
.preview-box{background:#fff;border:2px solid #e2e8f0;border-radius:12px;padding:24px;min-height:300px;max-height:500px;overflow-y:auto}
.preview-subject{font-size:16px;font-weight:600;color:#1e293b;padding-bottom:16px;margin-bottom:16px;border-bottom:1px solid #e2e8f0}
.var-input{background:#fef3c7;border:2px solid #fcd34d;border-radius:8px;padding:8px 12px;font-weight:600;color:#92400e;min-width:120px}
.var-input:focus{outline:none;border-color:#f59e0b;background:#fef9c3}
.var-input::placeholder{color:#b45309}

/* Email Detail */
.email-detail-header{padding:20px;background:#f8fafc;border-bottom:1px solid #e2e8f0}
.email-meta{display:flex;flex-wrap:wrap;gap:16px;margin-top:12px;font-size:13px;color:#64748b}
.email-body{padding:24px}

/* Recent Sidebar */
.recent-list{margin-top:8px}
.recent-item{padding:10px 12px;border-radius:8px;cursor:pointer;margin-bottom:4px}
.recent-item:hover{background:#f1f5f9}
.recent-item-title{font-size:13px;font-weight:500;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.recent-item-sub{font-size:11px;color:#94a3b8;margin-top:2px}

/* Toast */
.toast{position:fixed;top:20px;right:20px;padding:16px 24px;border-radius:12px;color:#fff;font-weight:500;z-index:300;animation:slideIn 0.3s}
.toast-success{background:linear-gradient(135deg,#059669,#10b981)}
.toast-error{background:linear-gradient(135deg,#dc2626,#ef4444)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
</style>
</head>
<body>
<div id="app"></div>

<script>
let user = null;
let page = 'login';
let templates = [];
let teams = [];
let emails = [];
let sidebarOpen = false;

const API = '';

function token() { return localStorage.getItem('token'); }

async function api(url, opts = {}) {
  opts.headers = { 'Content-Type': 'application/json' };
  if (token()) opts.headers.Authorization = 'Bearer ' + token();
  const res = await fetch(API + url, opts);
  const data = await res.json();
  if (res.status === 401) { localStorage.clear(); page = 'login'; render(); throw new Error('Oturum sonlandi'); }
  if (!res.ok) throw new Error(data.error || 'Hata olustu');
  return data;
}

function toast(msg, type = 'success') {
  const t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function nav(p) { page = p; render(); }
function toggleSidebar() { sidebarOpen = !sidebarOpen; render(); }
function closeSidebar() { sidebarOpen = false; render(); }

function isAdmin() { return user?.role === 'admin'; }
function isManager() { return user?.role === 'manager'; }
function isSales() { return user?.role === 'sales'; }

function getRoleName(r) {
  if (r === 'admin') return 'Admin';
  if (r === 'manager') return 'Bölge Yöneticisi';
  return 'Satış Personeli';
}

function getRoleColor(r) {
  if (r === 'admin') return 'background:linear-gradient(135deg,#f59e0b,#d97706)';
  if (r === 'manager') return 'background:linear-gradient(135deg,#8b5cf6,#7c3aed)';
  return 'background:linear-gradient(135deg,#0d9488,#0891b2)';
}

function formatDate(d) {
  return new Date(d).toLocaleString('tr-TR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

// RENDER
function render() {
  const app = document.getElementById('app');
  if (page === 'login') {
    app.innerHTML = loginPage();
    setupLogin();
  } else {
    app.innerHTML = `
      <div class="app">
        <div class="overlay ${sidebarOpen ? 'show' : ''}" onclick="closeSidebar()"></div>
        ${sidebar()}
        <div class="main">
          ${mobileHeader()}
          <div class="content" style="padding-top:${window.innerWidth <= 768 ? '80px' : '24px'}">
            ${page === 'dashboard' ? dashboardPage() : ''}
            ${page === 'send' ? sendPage() : ''}
            ${page === 'emails' ? emailsPage() : ''}
            ${page === 'templates' ? templatesPage() : ''}
            ${page === 'teams' ? teamsPage() : ''}
            ${page === 'users' ? usersPage() : ''}
            ${page === 'settings' ? settingsPage() : ''}
          </div>
        </div>
      </div>
    `;
    loadPageData();
  }
}

// PAGES
function loginPage() {
  return `
    <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#f0fdfa,#ecfeff)">
      <div class="card" style="width:100%;max-width:400px;padding:40px">
        <div style="text-align:center;margin-bottom:32px">
          <div style="width:64px;height:64px;background:linear-gradient(135deg,#0d9488,#0891b2);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
            <svg width="32" height="32" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          </div>
          <h1 style="font-size:28px;font-weight:700;color:#0d9488">G360 Mail</h1>
          <p style="color:#64748b;margin-top:8px">Mail Yönetim Sistemi</p>
        </div>
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label">Kullanıcı Adı</label>
            <input type="text" id="username" class="input" placeholder="Kullanıcı adınız" required>
          </div>
          <div class="form-group">
            <label class="form-label">Şifre</label>
            <input type="password" id="password" class="input" placeholder="••••••••" required>
          </div>
          <button type="submit" class="btn btn-primary" style="width:100%;padding:14px">Giriş Yap</button>
        </form>
      </div>
    </div>
  `;
}

function sidebar() {
  const recentEmails = emails.slice(0, 3);
  return `
    <aside class="sidebar ${sidebarOpen ? 'open' : ''}">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          </div>
          <span class="sidebar-logo-text">G360 Mail</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-item ${page === 'dashboard' ? 'active' : ''}" onclick="nav('dashboard')">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span>Ana Sayfa</span>
          </div>
          <div class="nav-item ${page === 'send' ? 'active' : ''}" onclick="nav('send')">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
            <span>Mail Gönder</span>
          </div>
          <div class="nav-item ${page === 'emails' ? 'active' : ''}" onclick="nav('emails')">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            <span>Mailler</span>
          </div>
        </div>
        
        ${recentEmails.length > 0 ? `
        <div class="nav-section">
          <div class="nav-title">Son Gönderilen</div>
          <div class="recent-list">
            ${recentEmails.map(e => `
              <div class="recent-item" onclick="viewEmail('${e.id}')">
                <div class="recent-item-title">${e.recipient_name || e.recipient_email}</div>
                <div class="recent-item-sub">${e.subject.substring(0, 30)}...</div>
              </div>
            `).join('')}
          </div>
        </div>
        ` : ''}
        
        ${!isAdmin() && templates.length > 0 ? `
        <div class="nav-section">
          <div class="nav-title">Taslaklar</div>
          ${templates.slice(0, 5).map(t => `
            <div class="nav-item" onclick="quickSend('${t.id}')" style="padding:10px 12px">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              <span style="font-size:13px">${t.name}</span>
            </div>
          `).join('')}
        </div>
        ` : ''}
        
        ${isAdmin() ? `
        <div class="nav-section">
          <div class="nav-title">Yönetim</div>
          <div class="nav-item ${page === 'templates' ? 'active' : ''}" onclick="nav('templates')">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span>Taslaklar</span>
          </div>
          <div class="nav-item ${page === 'teams' ? 'active' : ''}" onclick="nav('teams')">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>Ekipler</span>
          </div>
          <div class="nav-item ${page === 'users' ? 'active' : ''}" onclick="nav('users')">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span>Kullanıcılar</span>
          </div>
          <div class="nav-item ${page === 'settings' ? 'active' : ''}" onclick="nav('settings')">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span>Ayarlar</span>
          </div>
        </div>
        ` : ''}
      </nav>
      <div class="sidebar-footer">
        <div class="user-card">
          <div class="user-avatar" style="${getRoleColor(user?.role)}">${user?.full_name?.[0] || '?'}</div>
          <div class="user-info">
            <div class="user-name">${user?.full_name || ''}</div>
            <div class="user-role">${getRoleName(user?.role)}</div>
          </div>
          <button class="logout-btn" onclick="logout()" title="Çıkış">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>
  `;
}

function mobileHeader() {
  return `
    <div class="mobile-header">
      <button class="menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
      <span style="font-weight:700;color:#0d9488">G360 Mail</span>
      <div style="width:40px"></div>
    </div>
  `;
}

function dashboardPage() {
  return `
    <div class="page-header">
      <p style="color:#64748b">Hoş geldin,</p>
      <h1 class="page-title">${user?.full_name || ''}</h1>
    </div>
    <div id="stats" class="stats-grid"></div>
    <div class="card" style="padding:24px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="font-size:18px;font-weight:600">Son Mailler</h2>
        <button class="btn btn-primary" onclick="nav('send')">+ Yeni Mail</button>
      </div>
      <div id="recentEmails"></div>
    </div>
  `;
}

function sendPage() {
  return `
    <div class="page-header">
      <h1 class="page-title">Mail Gönder</h1>
      <p class="page-subtitle">Taslak seçin, bilgileri doldurun, gönderin</p>
    </div>
    <div class="send-grid">
      <div class="card" style="padding:24px">
        <form id="sendForm">
          <div class="form-group">
            <label class="form-label">Mail Taslağı</label>
            <select id="templateSelect" class="input" onchange="updateSendPreview()">
              <option value="">Taslak seçin...</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Alıcı E-posta *</label>
              <input type="email" id="toEmail" class="input" placeholder="ornek@firma.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Alıcı Adı</label>
              <input type="text" id="toName" class="input" placeholder="Ahmet Bey">
            </div>
          </div>
          <div id="variableInputs"></div>
          <button type="submit" class="btn btn-primary" style="width:100%;padding:14px;margin-top:8px">
            <span style="display:flex;align-items:center;justify-content:center;gap:8px">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              Mail Gönder
            </span>
          </button>
        </form>
      </div>
      <div>
        <div class="card preview-card" style="padding:24px">
          <h3 style="font-size:16px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px">
            <svg width="20" height="20" fill="none" stroke="#0d9488" stroke-width="2" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            Önizleme
          </h3>
          <div id="sendPreview" class="preview-box">
            <p style="color:#94a3b8;text-align:center;padding:40px">Taslak seçin...</p>
          </div>
        </div>
      </div>
    </div>
  `;
}

function emailsPage() {
  const title = isAdmin() ? 'Tüm Mailler' : isManager() ? 'Ekip Mailleri' : 'Maillerim';
  return `
    <div class="page-header">
      <h1 class="page-title">${title}</h1>
      <p class="page-subtitle" id="emailCount"></p>
    </div>
    <div class="card">
      <div class="table-container" id="emailsTable"></div>
    </div>
  `;
}

function templatesPage() {
  return `
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
      <div>
        <h1 class="page-title">Mail Taslakları</h1>
        <p class="page-subtitle">Taslak oluşturun, değişkenleri belirleyin</p>
      </div>
      <button class="btn btn-primary" onclick="showTemplateModal()">+ Yeni Taslak</button>
    </div>
    <div id="templatesList"></div>
  `;
}

function teamsPage() {
  return `
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
      <div>
        <h1 class="page-title">Ekipler</h1>
        <p class="page-subtitle">Satış ekiplerini yönetin</p>
      </div>
      <button class="btn btn-primary" onclick="showTeamModal()">+ Yeni Ekip</button>
    </div>
    <div id="teamsList" class="stats-grid"></div>
  `;
}

function usersPage() {
  return `
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
      <div>
        <h1 class="page-title">Kullanıcılar</h1>
        <p class="page-subtitle">Ekip üyelerini yönetin</p>
      </div>
      <button class="btn btn-primary" onclick="showUserModal()">+ Yeni Kullanıcı</button>
    </div>
    <div class="card">
      <div class="table-container" id="usersTable"></div>
    </div>
  `;
}

function settingsPage() {
  return `
    <div class="page-header">
      <h1 class="page-title">Ayarlar</h1>
      <p class="page-subtitle">İmza ve diğer ayarlar</p>
    </div>
    <div class="card" style="padding:24px;max-width:800px">
      <h3 style="font-size:16px;font-weight:600;margin-bottom:16px">Mail İmzası</h3>
      <p style="color:#64748b;font-size:14px;margin-bottom:16px">Her mailin altına otomatik eklenecek imza</p>
      <div id="signatureEditor" class="editor-container">
        <div class="editor-toolbar">
          <button type="button" class="toolbar-btn" onclick="execCmd('bold')"><strong>B</strong></button>
          <button type="button" class="toolbar-btn" onclick="execCmd('italic')"><em>I</em></button>
        </div>
        <div id="signatureArea" class="editor-area" contenteditable="true" data-placeholder="İmza yazın..."></div>
      </div>
      <button class="btn btn-primary" style="margin-top:16px" onclick="saveSignature()">İmzayı Kaydet</button>
    </div>
  `;
}

// DATA LOADING
async function loadPageData() {
  try {
    // Always load templates and emails for sidebar
    templates = await api('/api/templates');
    emails = await api('/api/emails');
    
    if (page === 'dashboard') {
      const stats = await api('/api/stats');
      document.getElementById('stats').innerHTML = `
        <div class="card stat-card">
          <div class="stat-icon" style="background:#dbeafe"><svg fill="none" stroke="#2563eb" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></div>
          <div><div class="stat-value">${stats.total}</div><div class="stat-label">Toplam Mail</div></div>
        </div>
        <div class="card stat-card">
          <div class="stat-icon" style="background:#d1fae5"><svg fill="none" stroke="#059669" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg></div>
          <div><div class="stat-value" style="color:#059669">${stats.sent}</div><div class="stat-label">Başarılı</div></div>
        </div>
        <div class="card stat-card">
          <div class="stat-icon" style="background:#fee2e2"><svg fill="none" stroke="#dc2626" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></div>
          <div><div class="stat-value" style="color:#dc2626">${stats.failed}</div><div class="stat-label">Başarısız</div></div>
        </div>
        <div class="card stat-card">
          <div class="stat-icon" style="background:#f3e8ff"><svg fill="none" stroke="#9333ea" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg></div>
          <div><div class="stat-value" style="color:#9333ea">${stats.teams}</div><div class="stat-label">Ekip</div></div>
        </div>
      `;
      
      const recentHtml = emails.slice(0, 5).map(e => `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 0;border-bottom:1px solid #f1f5f9;cursor:pointer" onclick="viewEmail('${e.id}')">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:40px;height:40px;background:#f1f5f9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:600;color:#64748b">${(e.recipient_name || e.recipient_email)[0].toUpperCase()}</div>
            <div>
              <div style="font-weight:600">${e.recipient_name || e.recipient_email}</div>
              <div style="font-size:13px;color:#64748b">${e.subject}</div>
            </div>
          </div>
          <div style="text-align:right">
            <span class="badge ${e.status === 'sent' ? 'badge-success' : 'badge-danger'}">${e.status === 'sent' ? 'Gönderildi' : 'Başarısız'}</span>
            <div style="font-size:12px;color:#94a3b8;margin-top:4px">${formatDate(e.sent_at)}</div>
          </div>
        </div>
      `).join('');
      document.getElementById('recentEmails').innerHTML = recentHtml || '<p class="table-empty">Henüz mail gönderilmemiş</p>';
    }
    
    if (page === 'send') {
      const select = document.getElementById('templateSelect');
      select.innerHTML = '<option value="">Taslak seçin...</option>' + templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      document.getElementById('sendForm').onsubmit = handleSend;
    }
    
    if (page === 'emails') {
      document.getElementById('emailCount').textContent = emails.length + ' mail';
      const hasTeamCol = isAdmin();
      const hasSenderCol = isAdmin() || isManager();
      
      let html = `<table>
        <thead><tr>
          <th>Alıcı</th>
          ${hasSenderCol ? '<th>Gönderen</th>' : ''}
          ${hasTeamCol ? '<th>Ekip</th>' : ''}
          <th>Konu</th>
          <th>Durum</th>
          <th>Tarih</th>
        </tr></thead>
        <tbody>`;
      
      if (emails.length === 0) {
        html += `<tr><td colspan="${2 + (hasSenderCol?1:0) + (hasTeamCol?1:0) + 2}" class="table-empty">Henüz mail gönderilmemiş</td></tr>`;
      } else {
        emails.forEach(e => {
          html += `<tr style="cursor:pointer" onclick="viewEmail('${e.id}')">
            <td><div style="font-weight:500">${e.recipient_name || '-'}</div><div style="font-size:12px;color:#64748b">${e.recipient_email}</div></td>
            ${hasSenderCol ? `<td>${e.sender_name || '-'}</td>` : ''}
            ${hasTeamCol ? `<td><span class="badge badge-info">${e.team_name || '-'}</span></td>` : ''}
            <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.subject}</td>
            <td><span class="badge ${e.status === 'sent' ? 'badge-success' : 'badge-danger'}">${e.status === 'sent' ? 'Gönderildi' : 'Başarısız'}</span></td>
            <td style="font-size:13px;color:#64748b">${formatDate(e.sent_at)}</td>
          </tr>`;
        });
      }
      html += '</tbody></table>';
      document.getElementById('emailsTable').innerHTML = html;
    }
    
    if (page === 'templates') {
      let html = '<div class="stats-grid">';
      templates.forEach(t => {
        html += `
          <div class="card" style="padding:20px">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
              <div>
                <h3 style="font-weight:600;font-size:16px">${t.name}</h3>
                <p style="font-size:13px;color:#64748b;margin-top:4px">${t.subject}</p>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn btn-secondary btn-sm" onclick="editTemplate('${t.id}')">Düzenle</button>
                <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${t.id}')">Sil</button>
              </div>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:6px">
              ${t.variables.map(v => `<span class="badge badge-orange">{{${v}}}</span>`).join('')}
            </div>
          </div>
        `;
      });
      html += '</div>';
      document.getElementById('templatesList').innerHTML = html || '<p class="table-empty">Henüz taslak eklenmemiş</p>';
    }
    
    if (page === 'teams') {
      teams = await api('/api/teams');
      let html = '';
      teams.forEach(t => {
        html += `
          <div class="card" style="padding:20px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="display:flex;align-items:center;gap:12px">
                <div style="width:48px;height:48px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px">${t.name[0]}</div>
                <div>
                  <h3 style="font-weight:600">${t.name}</h3>
                  <p style="font-size:13px;color:#64748b">Ekip</p>
                </div>
              </div>
              <button class="btn btn-danger btn-sm" onclick="deleteTeam('${t.id}')">Sil</button>
            </div>
          </div>
        `;
      });
      document.getElementById('teamsList').innerHTML = html || '<p class="table-empty">Henüz ekip eklenmemiş</p>';
    }
    
    if (page === 'users') {
      const users = await api('/api/users');
      teams = await api('/api/teams');
      
      let html = `<table>
        <thead><tr><th>Kullanıcı</th><th>Ekip</th><th>Rol</th><th style="text-align:right">İşlem</th></tr></thead>
        <tbody>`;
      
      users.forEach(u => {
        html += `<tr>
          <td>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;${getRoleColor(u.role)}">${u.full_name[0]}</div>
              <div><div style="font-weight:500">${u.full_name}</div><div style="font-size:12px;color:#64748b">@${u.username}</div></div>
            </div>
          </td>
          <td><span class="badge badge-info">${u.team_name || '-'}</span></td>
          <td><span class="badge ${u.role === 'admin' ? 'badge-orange' : u.role === 'manager' ? 'badge-purple' : 'badge-success'}">${getRoleName(u.role)}</span></td>
          <td style="text-align:right">
            ${u.role !== 'admin' ? `
              <button class="btn btn-secondary btn-sm" onclick="editUser('${u.id}')">Düzenle</button>
              <button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Sil</button>
            ` : '<span style="color:#94a3b8">Admin</span>'}
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('usersTable').innerHTML = html;
    }
    
    if (page === 'settings') {
      const settings = await api('/api/settings');
      document.getElementById('signatureArea').innerHTML = settings.signature || '';
    }
    
    // Re-render sidebar with updated data
    document.querySelector('.sidebar').outerHTML = sidebar();
    
  } catch (err) {
    console.error(err);
  }
}

// ACTIONS
function setupLogin() {
  document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    try {
      const res = await api('/api/auth/login', {
        method: 'POST',
        body: JSON.stringify({
          username: document.getElementById('username').value,
          password: document.getElementById('password').value
        })
      });
      localStorage.setItem('token', res.token);
      localStorage.setItem('user', JSON.stringify(res.user));
      user = res.user;
      toast('Giriş başarılı!');
      nav('dashboard');
    } catch (err) {
      toast(err.message, 'error');
    }
  };
}

function logout() {
  localStorage.clear();
  user = null;
  nav('login');
}

function updateSendPreview() {
  const tid = document.getElementById('templateSelect').value;
  const t = templates.find(x => x.id === tid);
  if (!t) {
    document.getElementById('sendPreview').innerHTML = '<p style="color:#94a3b8;text-align:center;padding:40px">Taslak seçin...</p>';
    document.getElementById('variableInputs').innerHTML = '';
    return;
  }
  
  // Variable inputs
  let varsHtml = '';
  if (t.variables.length > 0) {
    varsHtml = '<div class="form-group"><label class="form-label">Değişkenleri Doldurun</label><div class="form-row" style="grid-template-columns:repeat(auto-fill,minmax(180px,1fr))">';
    t.variables.forEach(v => {
      varsHtml += `<div><input type="text" class="input var-field" data-var="${v}" placeholder="${v}" oninput="updateSendPreview()"></div>`;
    });
    varsHtml += '</div></div>';
  }
  document.getElementById('variableInputs').innerHTML = varsHtml;
  
  // Preview
  let html = t.body;
  let subject = t.subject;
  document.querySelectorAll('.var-field').forEach(inp => {
    const v = inp.dataset.var;
    const val = inp.value || `<span class="var-tag">${v}</span>`;
    const re = new RegExp('\\{\\{' + v + '\\}\\}', 'g');
    html = html.replace(re, val);
    subject = subject.replace(re, inp.value || `[${v}]`);
  });
  
  document.getElementById('sendPreview').innerHTML = `
    <div class="preview-subject">${subject}</div>
    <div>${html}</div>
  `;
}

async function handleSend(e) {
  e.preventDefault();
  const btn = e.target.querySelector('button[type=submit]');
  const tid = document.getElementById('templateSelect').value;
  if (!tid) { toast('Taslak seçin', 'error'); return; }
  
  btn.disabled = true;
  btn.innerHTML = '<span>Gönderiliyor...</span>';
  
  const vars = {};
  document.querySelectorAll('.var-field').forEach(inp => {
    vars[inp.dataset.var] = inp.value;
  });
  
  try {
    await api('/api/emails/send', {
      method: 'POST',
      body: JSON.stringify({
        template_id: tid,
        recipient_email: document.getElementById('toEmail').value,
        recipient_name: document.getElementById('toName').value,
        variables: vars
      })
    });
    toast('Mail başarıyla gönderildi!');
    nav('emails');
  } catch (err) {
    toast(err.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<span style="display:flex;align-items:center;justify-content:center;gap:8px"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>Mail Gönder</span>';
  }
}

function quickSend(tid) {
  nav('send');
  setTimeout(() => {
    document.getElementById('templateSelect').value = tid;
    updateSendPreview();
  }, 100);
}

async function viewEmail(id) {
  try {
    const e = await api('/api/emails/' + id);
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content modal-lg">
        <div class="modal-header">
          <h3 class="modal-title">Mail Detayı</h3>
          <button class="modal-close" onclick="this.closest('.modal').remove()">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="email-detail-header">
          <h2 style="font-size:18px;font-weight:600">${e.subject}</h2>
          <div class="email-meta">
            <span><strong>Alıcı:</strong> ${e.recipient_name || ''} &lt;${e.recipient_email}&gt;</span>
            <span><strong>Tarih:</strong> ${formatDate(e.sent_at)}</span>
            <span class="badge ${e.status === 'sent' ? 'badge-success' : 'badge-danger'}">${e.status === 'sent' ? 'Gönderildi' : 'Başarısız'}</span>
          </div>
        </div>
        <div class="email-body">${e.body}</div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
  } catch (err) {
    toast(err.message, 'error');
  }
}

// TEMPLATE MODAL
function showTemplateModal(edit = null) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.id = 'templateModal';
  modal.innerHTML = `
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">${edit ? 'Taslağı Düzenle' : 'Yeni Taslak'}</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="templateForm">
          <div class="form-group">
            <label class="form-label">Taslak Adı</label>
            <input type="text" id="tplName" class="input" placeholder="Örn: Teklif Maili" value="${edit?.name || ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">Mail Konusu</label>
            <input type="text" id="tplSubject" class="input" placeholder="Örn: Teklif - {{firma}}" value="${edit?.subject || ''}" required>
            <p class="form-hint">Değişken eklemek için {{isim}} formatını kullanın</p>
          </div>
          <div class="form-group">
            <label class="form-label">Mail İçeriği</label>
            <div class="editor-container">
              <div class="editor-toolbar">
                <button type="button" class="toolbar-btn" onclick="execCmd('bold')"><strong>B</strong></button>
                <button type="button" class="toolbar-btn" onclick="execCmd('italic')"><em>I</em></button>
                <button type="button" class="toolbar-btn" onclick="execCmd('underline')"><u>U</u></button>
                <button type="button" class="toolbar-btn" onclick="insertVar()">+ Değişken Ekle</button>
              </div>
              <div id="tplBody" class="editor-area" contenteditable="true" data-placeholder="Mail içeriğini yazın...">${edit?.body || ''}</div>
            </div>
            <p class="form-hint">Değişken ekle butonuyla veya {{degisken}} yazarak değişken ekleyebilirsiniz</p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">İptal</button>
        <button class="btn btn-primary" onclick="saveTemplate('${edit?.id || ''}')">${edit ? 'Güncelle' : 'Kaydet'}</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
}

function execCmd(cmd) {
  document.execCommand(cmd, false, null);
}

function insertVar() {
  const name = prompt('Değişken adı girin (boşluksuz):');
  if (name) {
    const tag = `<span class="var-tag">{{${name}}}</span>&nbsp;`;
    document.execCommand('insertHTML', false, tag);
  }
}

async function saveTemplate(id) {
  const body = document.getElementById('tplBody').innerHTML
    .replace(/<span class="var-tag">\{\{(\w+)\}\}<\/span>/g, '{{$1}}');
  
  try {
    await api(id ? '/api/templates/' + id : '/api/templates', {
      method: id ? 'PUT' : 'POST',
      body: JSON.stringify({
        name: document.getElementById('tplName').value,
        subject: document.getElementById('tplSubject').value,
        body: body
      })
    });
    toast(id ? 'Taslak güncellendi!' : 'Taslak oluşturuldu!');
    document.getElementById('templateModal').remove();
    loadPageData();
  } catch (err) {
    toast(err.message, 'error');
  }
}

function editTemplate(id) {
  const t = templates.find(x => x.id === id);
  if (t) {
    const bodyWithTags = t.body.replace(/\{\{(\w+)\}\}/g, '<span class="var-tag">{{$1}}</span>');
    showTemplateModal({ ...t, body: bodyWithTags });
  }
}

async function deleteTemplate(id) {
  if (!confirm('Bu taslağı silmek istediğinize emin misiniz?')) return;
  try {
    await api('/api/templates/' + id, { method: 'DELETE' });
    toast('Taslak silindi');
    loadPageData();
  } catch (err) {
    toast(err.message, 'error');
  }
}

// TEAM MODAL
function showTeamModal() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.id = 'teamModal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:400px">
      <div class="modal-header">
        <h3 class="modal-title">Yeni Ekip</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Ekip Adı</label>
          <input type="text" id="teamName" class="input" placeholder="Örn: İstanbul" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">İptal</button>
        <button class="btn btn-primary" onclick="saveTeam()">Kaydet</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
}

async function saveTeam() {
  try {
    await api('/api/teams', {
      method: 'POST',
      body: JSON.stringify({ name: document.getElementById('teamName').value })
    });
    toast('Ekip oluşturuldu!');
    document.getElementById('teamModal').remove();
    loadPageData();
  } catch (err) {
    toast(err.message, 'error');
  }
}

async function deleteTeam(id) {
  if (!confirm('Bu ekibi silmek istediğinize emin misiniz?')) return;
  try {
    await api('/api/teams/' + id, { method: 'DELETE' });
    toast('Ekip silindi');
    loadPageData();
  } catch (err) {
    toast(err.message, 'error');
  }
}

// USER MODAL
function showUserModal(edit = null) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.id = 'userModal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:500px">
      <div class="modal-header">
        <h3 class="modal-title">${edit ? 'Kullanıcı Düzenle' : 'Yeni Kullanıcı'}</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Kullanıcı Adı</label>
            <input type="text" id="userName" class="input" placeholder="kullanici" value="${edit?.username || ''}" ${edit ? 'disabled' : 'required'}>
          </div>
          <div class="form-group">
            <label class="form-label">Ad Soyad</label>
            <input type="text" id="userFullName" class="input" placeholder="Ahmet Yılmaz" value="${edit?.full_name || ''}" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Ekip</label>
            <select id="userTeam" class="input">
              <option value="">Ekip Yok</option>
              ${teams.map(t => `<option value="${t.id}" ${edit?.team_id === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Rol</label>
            <select id="userRole" class="input">
              <option value="sales" ${edit?.role === 'sales' ? 'selected' : ''}>Satış Personeli</option>
              <option value="manager" ${edit?.role === 'manager' ? 'selected' : ''}>Bölge Yöneticisi</option>
              <option value="admin" ${edit?.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Şifre ${edit ? '(boş bırakırsanız değişmez)' : ''}</label>
          <input type="password" id="userPass" class="input" placeholder="••••••••" ${edit ? '' : 'required'}>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">İptal</button>
        <button class="btn btn-primary" onclick="saveUser('${edit?.id || ''}')">${edit ? 'Güncelle' : 'Kaydet'}</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
}

async function saveUser(id) {
  const data = {
    full_name: document.getElementById('userFullName').value,
    team_id: document.getElementById('userTeam').value || null,
    role: document.getElementById('userRole').value
  };
  
  if (!id) data.username = document.getElementById('userName').value;
  const pass = document.getElementById('userPass').value;
  if (pass) data.password = pass;
  
  try {
    await api(id ? '/api/users/' + id : '/api/users', {
      method: id ? 'PUT' : 'POST',
      body: JSON.stringify(data)
    });
    toast(id ? 'Kullanıcı güncellendi!' : 'Kullanıcı oluşturuldu!');
    document.getElementById('userModal').remove();
    loadPageData();
  } catch (err) {
    toast(err.message, 'error');
  }
}

async function editUser(id) {
  const users = await api('/api/users');
  const u = users.find(x => x.id === id);
  if (u) showUserModal(u);
}

async function deleteUser(id) {
  if (!confirm('Bu kullanıcıyı silmek istediğinize emin misiniz?')) return;
  try {
    await api('/api/users/' + id, { method: 'DELETE' });
    toast('Kullanıcı silindi');
    loadPageData();
  } catch (err) {
    toast(err.message, 'error');
  }
}

// SIGNATURE
async function saveSignature() {
  try {
    await api('/api/settings', {
      method: 'POST',
      body: JSON.stringify({ signature: document.getElementById('signatureArea').innerHTML })
    });
    toast('İmza kaydedildi!');
  } catch (err) {
    toast(err.message, 'error');
  }
}

// INIT
(function() {
  const t = localStorage.getItem('token');
  const u = localStorage.getItem('user');
  if (t && u) {
    user = JSON.parse(u);
    page = 'dashboard';
  }
  render();
})();
</script>
</body>
</html>
